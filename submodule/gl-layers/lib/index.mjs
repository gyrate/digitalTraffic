import*as t from"three";import{BufferGeometry as e,BufferAttribute as n,TrianglesDrawMode as r,TriangleFanDrawMode as i,TriangleStripDrawMode as a,Loader as o,LoaderUtils as s,FileLoader as l,Color as u,LinearSRGBColorSpace as c,SpotLight as h,PointLight as d,DirectionalLight as f,MeshBasicMaterial as p,SRGBColorSpace as v,MeshPhysicalMaterial as m,Vector2 as g,Matrix4 as y,Vector3 as _,Quaternion as x,InstancedMesh as w,Object3D as b,TextureLoader as A,ImageBitmapLoader as M,InterleavedBuffer as T,InterleavedBufferAttribute as S,LinearFilter as k,LinearMipmapLinearFilter as C,RepeatWrapping as E,PointsMaterial as L,Material as P,LineBasicMaterial as R,MeshStandardMaterial as I,DoubleSide as O,PropertyBinding as D,SkinnedMesh as N,Mesh as U,LineSegments as F,Line as B,LineLoop as z,Points as G,Group as V,PerspectiveCamera as j,MathUtils as H,OrthographicCamera as W,Skeleton as X,AnimationClip as Y,Bone as K,InterpolateLinear as Q,ColorManagement as q,NearestFilter as Z,NearestMipmapNearestFilter as J,LinearMipmapNearestFilter as $,NearestMipmapLinearFilter as tt,ClampToEdgeWrapping as et,MirroredRepeatWrapping as nt,InterpolateDiscrete as rt,FrontSide as it,Texture as at,VectorKeyframeTrack as ot,NumberKeyframeTrack as st,QuaternionKeyframeTrack as lt,Box3 as ut,Sphere as ct,Interpolant as ht,Float32BufferAttribute as dt,ShaderMaterial as ft,UniformsUtils as pt,WebGLRenderTarget as vt,HalfFloatType as mt,NoBlending as gt,Clock as yt,AdditiveBlending as _t,ShaderChunk as xt,RawShaderMaterial as wt,SRGBTransfer as bt,LinearToneMapping as At,ReinhardToneMapping as Mt,CineonToneMapping as Tt,ACESFilmicToneMapping as St,UniformsLib as kt,ShaderLib as Ct,InstancedBufferGeometry as Et,InstancedInterleavedBuffer as Lt,WireframeGeometry as Pt,Vector4 as Rt,Line3 as It}from"three";import Ot from"lodash";import Dt from"html2canvas";import{TilesRenderer as Nt}from"3d-tiles-renderer";function Ut(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,r=Array(e);n<e;n++)r[n]=t[n];return r}function Ft(t,e,n,r,i,a,o){try{var s=t[a](o),l=s.value}catch(t){return void n(t)}s.done?e(l):Promise.resolve(l).then(r,i)}function Bt(t){return function(){var e=this,n=arguments;return new Promise((function(r,i){var a=t.apply(e,n);function o(t){Ft(a,r,i,o,s,"next",t)}function s(t){Ft(a,r,i,o,s,"throw",t)}o(void 0)}))}}function zt(t,e,n){return e=Xt(e),Zt(t,Kt()?Reflect.construct(e,n||[],Xt(t).constructor):e.apply(t,n))}function Gt(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function Vt(t,e){for(var n=0;n<e.length;n++){var r=e[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,ne(r.key),r)}}function jt(t,e,n){return e&&Vt(t.prototype,e),n&&Vt(t,n),Object.defineProperty(t,"prototype",{writable:!1}),t}function Ht(t,e,n){return(e=ne(e))in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function Wt(){return Wt="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,n){var r=function(t,e){for(;!{}.hasOwnProperty.call(t,e)&&null!==(t=Xt(t)););return t}(t,e);if(r){var i=Object.getOwnPropertyDescriptor(r,e);return i.get?i.get.call(arguments.length<3?t:n):i.value}},Wt.apply(null,arguments)}function Xt(t){return Xt=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},Xt(t)}function Yt(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&$t(t,e)}function Kt(){try{var t=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(t){}return(Kt=function(){return!!t})()}function Qt(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);e&&(r=r.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,r)}return n}function qt(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?Qt(Object(n),!0).forEach((function(e){Ht(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):Qt(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function Zt(t,e){if(e&&("object"==typeof e||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function Jt(){Jt=function(){return e};var t,e={},n=Object.prototype,r=n.hasOwnProperty,i=Object.defineProperty||function(t,e,n){t[e]=n.value},a="function"==typeof Symbol?Symbol:{},o=a.iterator||"@@iterator",s=a.asyncIterator||"@@asyncIterator",l=a.toStringTag||"@@toStringTag";function u(t,e,n){return Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}),t[e]}try{u({},"")}catch(t){u=function(t,e,n){return t[e]=n}}function c(t,e,n,r){var a=e&&e.prototype instanceof g?e:g,o=Object.create(a.prototype),s=new L(r||[]);return i(o,"_invoke",{value:S(t,n,s)}),o}function h(t,e,n){try{return{type:"normal",arg:t.call(e,n)}}catch(t){return{type:"throw",arg:t}}}e.wrap=c;var d="suspendedStart",f="suspendedYield",p="executing",v="completed",m={};function g(){}function y(){}function _(){}var x={};u(x,o,(function(){return this}));var w=Object.getPrototypeOf,b=w&&w(w(P([])));b&&b!==n&&r.call(b,o)&&(x=b);var A=_.prototype=g.prototype=Object.create(x);function M(t){["next","throw","return"].forEach((function(e){u(t,e,(function(t){return this._invoke(e,t)}))}))}function T(t,e){function n(i,a,o,s){var l=h(t[i],t,a);if("throw"!==l.type){var u=l.arg,c=u.value;return c&&"object"==typeof c&&r.call(c,"__await")?e.resolve(c.__await).then((function(t){n("next",t,o,s)}),(function(t){n("throw",t,o,s)})):e.resolve(c).then((function(t){u.value=t,o(u)}),(function(t){return n("throw",t,o,s)}))}s(l.arg)}var a;i(this,"_invoke",{value:function(t,r){function i(){return new e((function(e,i){n(t,r,e,i)}))}return a=a?a.then(i,i):i()}})}function S(e,n,r){var i=d;return function(a,o){if(i===p)throw Error("Generator is already running");if(i===v){if("throw"===a)throw o;return{value:t,done:!0}}for(r.method=a,r.arg=o;;){var s=r.delegate;if(s){var l=k(s,r);if(l){if(l===m)continue;return l}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===d)throw i=v,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=p;var u=h(e,n,r);if("normal"===u.type){if(i=r.done?v:f,u.arg===m)continue;return{value:u.arg,done:r.done}}"throw"===u.type&&(i=v,r.method="throw",r.arg=u.arg)}}}function k(e,n){var r=n.method,i=e.iterator[r];if(i===t)return n.delegate=null,"throw"===r&&e.iterator.return&&(n.method="return",n.arg=t,k(e,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),m;var a=h(i,e.iterator,n.arg);if("throw"===a.type)return n.method="throw",n.arg=a.arg,n.delegate=null,m;var o=a.arg;return o?o.done?(n[e.resultName]=o.value,n.next=e.nextLoc,"return"!==n.method&&(n.method="next",n.arg=t),n.delegate=null,m):o:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,m)}function C(t){var e={tryLoc:t[0]};1 in t&&(e.catchLoc=t[1]),2 in t&&(e.finallyLoc=t[2],e.afterLoc=t[3]),this.tryEntries.push(e)}function E(t){var e=t.completion||{};e.type="normal",delete e.arg,t.completion=e}function L(t){this.tryEntries=[{tryLoc:"root"}],t.forEach(C,this),this.reset(!0)}function P(e){if(e||""===e){var n=e[o];if(n)return n.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var i=-1,a=function n(){for(;++i<e.length;)if(r.call(e,i))return n.value=e[i],n.done=!1,n;return n.value=t,n.done=!0,n};return a.next=a}}throw new TypeError(typeof e+" is not iterable")}return y.prototype=_,i(A,"constructor",{value:_,configurable:!0}),i(_,"constructor",{value:y,configurable:!0}),y.displayName=u(_,l,"GeneratorFunction"),e.isGeneratorFunction=function(t){var e="function"==typeof t&&t.constructor;return!!e&&(e===y||"GeneratorFunction"===(e.displayName||e.name))},e.mark=function(t){return Object.setPrototypeOf?Object.setPrototypeOf(t,_):(t.__proto__=_,u(t,l,"GeneratorFunction")),t.prototype=Object.create(A),t},e.awrap=function(t){return{__await:t}},M(T.prototype),u(T.prototype,s,(function(){return this})),e.AsyncIterator=T,e.async=function(t,n,r,i,a){void 0===a&&(a=Promise);var o=new T(c(t,n,r,i),a);return e.isGeneratorFunction(n)?o:o.next().then((function(t){return t.done?t.value:o.next()}))},M(A),u(A,l,"Generator"),u(A,o,(function(){return this})),u(A,"toString",(function(){return"[object Generator]"})),e.keys=function(t){var e=Object(t),n=[];for(var r in e)n.push(r);return n.reverse(),function t(){for(;n.length;){var r=n.pop();if(r in e)return t.value=r,t.done=!1,t}return t.done=!0,t}},e.values=P,L.prototype={constructor:L,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=t,this.done=!1,this.delegate=null,this.method="next",this.arg=t,this.tryEntries.forEach(E),!e)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=t)},stop:function(){this.done=!0;var t=this.tryEntries[0].completion;if("throw"===t.type)throw t.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var n=this;function i(r,i){return s.type="throw",s.arg=e,n.next=r,i&&(n.method="next",n.arg=t),!!i}for(var a=this.tryEntries.length-1;a>=0;--a){var o=this.tryEntries[a],s=o.completion;if("root"===o.tryLoc)return i("end");if(o.tryLoc<=this.prev){var l=r.call(o,"catchLoc"),u=r.call(o,"finallyLoc");if(l&&u){if(this.prev<o.catchLoc)return i(o.catchLoc,!0);if(this.prev<o.finallyLoc)return i(o.finallyLoc)}else if(l){if(this.prev<o.catchLoc)return i(o.catchLoc,!0)}else{if(!u)throw Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return i(o.finallyLoc)}}}},abrupt:function(t,e){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var a=i;break}}a&&("break"===t||"continue"===t)&&a.tryLoc<=e&&e<=a.finallyLoc&&(a=null);var o=a?a.completion:{};return o.type=t,o.arg=e,a?(this.method="next",this.next=a.finallyLoc,m):this.complete(o)},complete:function(t,e){if("throw"===t.type)throw t.arg;return"break"===t.type||"continue"===t.type?this.next=t.arg:"return"===t.type?(this.rval=this.arg=t.arg,this.method="return",this.next="end"):"normal"===t.type&&e&&(this.next=e),m},finish:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.finallyLoc===t)return this.complete(n.completion,n.afterLoc),E(n),m}},catch:function(t){for(var e=this.tryEntries.length-1;e>=0;--e){var n=this.tryEntries[e];if(n.tryLoc===t){var r=n.completion;if("throw"===r.type){var i=r.arg;E(n)}return i}}throw Error("illegal catch attempt")},delegateYield:function(e,n,r){return this.delegate={iterator:P(e),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=t),m}},e}function $t(t,e){return $t=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},$t(t,e)}function te(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=n){var r,i,a,o,s=[],l=!0,u=!1;try{if(a=(n=n.call(t)).next,0===e){if(Object(n)!==n)return;l=!1}else for(;!(l=(r=a.call(n)).done)&&(s.push(r.value),s.length!==e);l=!0);}catch(t){u=!0,i=t}finally{try{if(!l&&null!=n.return&&(o=n.return(),Object(o)!==o))return}finally{if(u)throw i}}return s}}(t,e)||ie(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ee(t){return function(t){if(Array.isArray(t))return Ut(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||ie(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function ne(t){var e=function(t,e){if("object"!=typeof t||!t)return t;var n=t[Symbol.toPrimitive];if(void 0!==n){var r=n.call(t,e||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==typeof e?e:e+""}function re(t){return re="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},re(t)}function ie(t,e){if(t){if("string"==typeof t)return Ut(t,e);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Ut(t,e):void 0}}var ae=function(){return jt((function t(){Gt(this,t),Ht(this,"eventMap",{})}),[{key:"addEventListener",value:function(t,e){return this.eventMap[t]||(this.eventMap[t]=[]),this.eventMap[t].push(e),this}},{key:"on",value:function(t,e){return this.addEventListener(t,e),this}},{key:"removeEventListener",value:function(t,e){if(!this.eventMap[t])return this;var n=this.eventMap[t].findIndex((function(t){return t===e}));return n>-1&&this.eventMap[t].splice(n,1),this}},{key:"off",value:function(t,e){return this.removeEventListener(t,e),this}},{key:"handleEvent",value:function(t,e){for(var n=this.eventMap[t]||[],r=0;r<n.length;r++)"function"==typeof n[r]&&n[r].apply(n[r],[e,this]);return this}}])}(),oe=0,se=null,le=function(){function e(t){var n,r;if(Gt(this,e),Ht(r=zt(this,e),"id",null),Ht(r,"title",""),Ht(r,"_canvas",null),Ht(r,"composer",null),Ht(r,"_conf",{renderOption:{antialias:!1,precision:"highp"},alone:!0,zIndex:120,visible:!0}),Ht(r,"_zooms",[3,22]),Ht(r,"_isAnimate",!0),Ht(r,"_center",null),Ht(r,"_raycaster",null),Ht(r,"_interactAble",!1),Ht(r,"_visible",!0),Ht(r,"_baseURL","."),Ht(r,"_pickEvent",null),Ht(r,"_intensity",.3),r._conf=Ot.merge(r._conf,t),void 0===t.map||null==t.map||"function"!=typeof t.map.getContainer)throw Error("config.map invalid");if(r.map=t.map,r.container=t.container||t.map.getContainer(),!r.container)throw Error("config.container invalid");if(r._interactAble=null!==(n=t.interact)&&void 0!==n&&n,r.customCoords=r.map.customCoords,r.layer=null,delete r._conf.data,r.id=t.id||(new Date).getTime().toString(),r.title=t.title||"",t.zooms&&(r._zooms=t.zooms),void 0!==t.animate&&(r._isAnimate=t.animate),t.center)r.updateCenter(t.center),r._center=t.center;else{var i=r.map.getCenter(),a=i.lng,o=i.lat;r.updateCenter([a,o]),r._center=[a,o]}return r.reviseVisible(),"number"==typeof t.intensity&&(r._intensity=t.intensity),void 0!==t.baseURL&&(r._baseURL=t.baseURL),t.pickEvent||(r._pickEvent=t.pickEvent||"mousemove"),r.handleOnRay=Ot.debounce(r.onRay,100,!0),r.bindMethods(["animate","resizeLayer","handleOnRay"]),r.camera=null,r.renderer=null,r.scene=null,r.eventMap={},r.preparea(),r}return Yt(e,ae),jt(e,[{key:"preparea",value:(r=Bt(Jt().mark((function t(){return Jt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.initZooms(),this.addModuleListener(),t.next=4,this.initLayer();case 4:this.onReady(),this._initInteract(),this.animate(),this.handleEvent("complete",this);case 8:case"end":return t.stop()}}),t,this)}))),function(){return r.apply(this,arguments)})},{key:"onReady",value:function(){throw Error("该方法只能被子类重写")}},{key:"onRender",value:function(){}},{key:"update",value:function(){}},{key:"beforeDestroy",value:function(){}},{key:"createHelper",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[0,0,0],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:15e3,r=new t.AxesHelper(n),i=te(e,3),a=i[0],o=i[1],s=i[2];r.position.set(a,o,s),this.scene.add(r)}},{key:"queryFeature",value:function(t){var e=this;return new Promise((function(n){n(e.onRay(t))}))}},{key:"destroy",value:function(){for(var t in"function"==typeof this.beforeDestroy&&this.beforeDestroy(),this.removeModuleListener(),this.layer&&(this.layer.hide(),this.map.remove(this.layer)),this.scene&&(this.scene.traverse((function(t){t.material&&t.material.dispose(),t.geometry&&t.geometry.dispose()})),this.scene=null),this.renderer&&(this.camera=null,this.renderer.clear(),this.renderer.dispose(),this.renderer=null),this)delete this[t];(oe-=1)<=0&&(se.destroy(),se=null,oe=0)}},{key:"setCenter",value:function(t){this._center=t}},{key:"setVisible",value:function(t){this._conf.visible=!0===t,this.reviseVisible()}},{key:"getVisible",value:function(){return this._visible}},{key:"reviseVisible",value:function(t){var e;return(e=!!this.isInZooms()&&("boolean"!=typeof t||t))!==this._visible&&(this.handleEvent("visibleChange",e),!1===e&&this.renderer&&this.renderer.clear()),this._visible=e,this._visible}},{key:"updateCenter",value:function(t){t instanceof Array&&this.customCoords.setCenter(t),this._center=this.customCoords.getCenter()}},{key:"initThree",value:function(e){var n=this.container,r=n.clientWidth,i=n.clientHeight;this.camera=new t.PerspectiveCamera(60,r/i,100,1<<30);var a=this._conf.renderOption,o={alpha:!0,antialias:a.antialias,precision:a.precision};this._conf.alone?o.context=this._canvas.getContext("webgl"):o.context=e;var s=new t.WebGLRenderer(o);if(s.autoClear=!1,s.setClearAlpha(0),s.shadowMap.enabled=!0,s.shadowMap.type=t.PCFSoftShadowMap,s.setSize(r,i),s.setPixelRatio(window.devicePixelRatio),this.renderer=s,this.scene=new t.Scene,this._intensity>0){var l=new t.AmbientLight(16777215,this._intensity);this.scene.add(l)}}},{key:"initLayer",value:(n=Bt(Jt().mark((function t(){return Jt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!this._conf.alone){t.next=6;break}return t.next=3,this.createCustomLayer();case 3:this.layer=t.sent,t.next=9;break;case 6:return t.next=8,this.createGlCustomLayer();case 8:this.layer=t.sent;case 9:this._conf.visible?this.layer.show():this.layer.hide();case 10:case"end":return t.stop()}}),t,this)}))),function(){return n.apply(this,arguments)})},{key:"setOpacity",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;this.layer&&this.layer.setOpacity(t)}},{key:"createCustomLayer",value:function(){var t=this;return new Promise((function(e){if(se)t._canvas=se.canvas,t.initThree(),t.updateCenter(t._center);else{var n=t.container,r=n.clientWidth,i=n.clientHeight;t._canvas=document.createElement("canvas"),t._canvas.id="gl-layers",t._canvas.width=r,t._canvas.height=i,t._canvas.style.cssText="width: ".concat(r,"px; height: ").concat(i,"px;");var a=new AMap.CustomLayer(t._canvas,{visible:!0,zIndex:t._conf.zIndex,alwaysRender:!0});t.initThree(),t.updateCenter(t._center),a.render=function(){null!=t.renderer&&t.onRender()},t.map.add(a),se=a}oe+=1,e(se)}))}},{key:"createGlCustomLayer",value:function(){var t=this;return new Promise((function(e){var n=new AMap.GLCustomLayer({zIndex:t._conf.zIndex,visible:!0,init:function(r){t.initThree(r),t.updateCenter(t._center),t.reviseVisible(),e(n)},render:function(e){t.updateCamera(),t.onRender()}});t.map.add(n)}))}},{key:"updateCamera",value:function(){var t,e,n=this.scene,r=this.renderer,i=this.camera,a=this.customCoords;if(r){r.resetState(),this._center&&a.setCenter(this._center);var o=a.getCameraParams(),s=o.near,l=o.far,u=o.fov,c=o.up,h=o.lookAt,d=o.position;i.near=s,i.far=l,i.fov=u,(t=i.position).set.apply(t,ee(d)),(e=i.up).set.apply(e,ee(c)),i.lookAt.apply(i,ee(h)),i.updateProjectionMatrix(),this.composer?this.composer.render():this._visible&&r.render(n,i),r.resetState()}}},{key:"animate",value:function(t){this.renderer&&(this.update&&this.update(t),this._conf.alone?this.updateCamera():this.map&&this.map.render(),requestAnimationFrame(this.animate))}},{key:"_initInteract",value:function(){!1!==this._interactAble&&(this._raycaster=new t.Raycaster,this._pickEvent&&this.container.addEventListener(this._pickEvent,this.handleOnRay))}},{key:"onRay",value:function(t){var e=this.scene,n=this.camera;if(e){var r=this.setPickPosition(t);this._raycaster.setFromCamera(r,n);var i=this._raycaster.intersectObjects(e.children,!0);return"function"==typeof this.onPicked&&this._interactAble&&this._visible&&this.onPicked.apply(this,[{targets:i,event:t}]),i}}},{key:"getRayPickMesh",value:function(t){var e=this.scene,n=this.camera;if(e){var r=this.setPickPosition(t);return this._raycaster.setFromCamera(r,n),this._raycaster.intersectObjects(e.children,!0)}}},{key:"setPickPosition",value:function(t){var e={x:0,y:0},n=this.container.getBoundingClientRect();return e.x=t.clientX/n.width*2-1,e.y=t.clientY/n.height*-2+1,e}},{key:"initZooms",value:function(){var t=this;this.map.on("zoomend",(function(e){t.reviseVisible()}))}},{key:"isInZooms",value:function(){var t=this.map.getZoom();return t>=this._zooms[0]&&t<=this._zooms[1]}},{key:"addModuleListener",value:function(){window.addEventListener("resize",this.resizeLayer)}},{key:"removeModuleListener",value:function(){window.removeEventListener("resize",this.resizeLayer),this._pickEvent&&this.container.removeEventListener(this._pickEvent,this.onRay)}},{key:"resizeLayer",value:function(){var t=this.container,e=t.clientWidth,n=t.clientHeight;this._canvas&&(this._canvas.width=e,this._canvas.height=n,this._canvas.style.width=e+"px",this._canvas.style.height=n+"px"),this.camera&&(this.camera.aspect=e/n)}},{key:"show",value:function(){this.layer&&(!1===this._conf.alone&&this.layer.show(),this.reviseVisible(!0))}},{key:"hide",value:function(){this.layer&&(!1===this._conf.alone&&this.layer.hide(),this.reviseVisible(!1))}},{key:"isVisible",value:function(){return!0===this._visible}},{key:"bindMethods",value:function(t){var e=this;t.forEach((function(t){e[t]=e[t].bind(e)}))}},{key:"mergeSourceURL",value:function(t){return"string"!=typeof t?(console.error('mergeSourceURL param "url" must be Sting'),null):t.startsWith("http")||t.startsWith(".")?t:"".concat(this._baseURL).concat(t)}},{key:"getResolution",value:function(){return"function"==typeof this.map.getResolution?this.map.getResolution():null}}]);var n,r}(),ue=le,ce=function(){return jt((function t(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};Gt(this,t),this._list=e.data||[]}),[{key:"getList",value:function(){return this._list}},{key:"add",value:function(t){if(void 0!==t)if(void 0!==t.id){var e=t.id;this.findLayerById(e)?console.error("图层的id ".concat(e," 不是唯一标识，请更换")):this._list.push(t)}else console.error("缺少图层id");else console.error("缺少图层实例")}},{key:"findLayerById",value:function(t){return this._list.find((function(e){return e.id===t}))}},{key:"remove",value:function(t){t instanceof Array||(t=[t]);var e=this._list.filter((function(e){return 0==t.includes(e.id)}));return this._list=e,e}},{key:"destroyLayerById",value:function(t){var e=this.findLayerById(t);e&&(e.destroy&&e.destroy(),this.remove(t))}},{key:"clear",value:function(){this._list.forEach((function(t){t.destroy&&t.destroy(),console.log("销毁layer ".concat(t.id))})),this._list=[]}},{key:"show",value:function(){this._list.forEach((function(t){t.show()}))}},{key:"hide",value:function(){this._list.forEach((function(t){t.hide()}))}}])}(),he=function(t){return Object.prototype.toString.call(t).split(" ")[1].split("]")[0].toLocaleLowerCase()},de=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:1;return"rgba("+parseInt("0x"+t.slice(1,3))+","+parseInt("0x"+t.slice(3,5))+","+parseInt("0x"+t.slice(5,7))+","+e+")"},fe=function(){function e(t){var n;Gt(this,e);var r=qt({altitude:0,wallHeight:50,wallColor:"#00feff",data:null,animate:!0,alphaMap:"./static/texture/texture_1.png",speed:1},t);return Ht(n=zt(this,e,[r]),"_paths",[]),Ht(n,"_height",50),Ht(n,"_color",null),Ht(n,"_texture",null),Ht(n,"_texture_offset",0),n._height=r.wallHeight,n._color=r.wallColor,n.initData(r.data),n}return Yt(e,ue),jt(e,[{key:"onReady",value:function(){this.createWall()}},{key:"initData",value:function(t){var e=this;t.features.forEach((function(t){var n,r=t.geometry;switch(r.type){case"MultiPolygon":var i=r.coordinates[0].map((function(t){return e.customCoords.lngLatsToCoords(t)}));(n=e._paths).push.apply(n,ee(i));break;case"Polygon":var a=e.customCoords.lngLatsToCoords(r.coordinates[0]);e._paths.push(a)}}))}},{key:"generateVecData",value:function(t){for(var e=[],n=[],r=[],i=[0,0],a=[1,0],o=[1,1],s=[0,1],l=0;l<t.length;l++){var u=te(t[l],2),c=u[0],h=u[1];e.push([c,h,this._conf.altitude]),e.push([c,h,this._conf.altitude+this._height])}for(var d=0;d<e.length-2;d++)d%2==0?(n=[].concat(ee(n),ee(e[d]),ee(e[d+2]),ee(e[d+1])),r=[].concat(ee(r),i,a,s)):(n=[].concat(ee(n),ee(e[d]),ee(e[d+1]),ee(e[d+2])),r=[].concat(ee(r),s,a,o));return{face:n,uvs:r}}},{key:"createWall",value:function(){for(var e=this.scene,n=[],r=[],i=0;i<this._paths.length;i++){var a=this.generateVecData(this._paths[i]),o=a.face,s=a.uvs;n=[].concat(ee(n),ee(o)),r=[].concat(ee(r),ee(s))}var l=new t.BufferGeometry;l.setAttribute("position",new t.BufferAttribute(new Float32Array(n),3)),l.setAttribute("uv",new t.BufferAttribute(new Float32Array(r),2));var u=new t.MeshBasicMaterial({color:this._color,side:t.DoubleSide,transparent:!0,depthWrite:!0,alphaMap:(new t.TextureLoader).load(this.mergeSourceURL(this._conf.alphaMap),(function(){}),null,(function(t){console.error("alphaMap load error")}))}),c=new t.Mesh(l,u);if(e.add(c),this.mainMesh=c,this._conf.animate){var h=l.clone();this._texture=this.generateTexture(128,this._color),this._texture.wrapS=t.RepeatWrapping,this._texture.wrapT=t.RepeatWrapping;var d=new t.MeshBasicMaterial({side:t.DoubleSide,transparent:!0,depthWrite:!1,map:this._texture}),f=new t.Mesh(h,d);e.add(f),this.animateMesh=f}}},{key:"setColor",value:function(e){var n=this.generateTexture(128,e);n.wrapS=t.RepeatWrapping,n.wrapT=t.RepeatWrapping,this._color=e,this._texture_offset=0,this.mainMesh.material.color=e,this.animateMesh.material.map=n,this._texture=n}},{key:"generateTexture",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:64,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"#ff0000",r=document.createElement("canvas");r.width=e,r.height=e;var i=r.getContext("2d"),a=i.createLinearGradient(0,0,0,e);a.addColorStop(.2,de(n,0)),a.addColorStop(.8,de(n,.5)),a.addColorStop(1,de(n,1)),i.fillStyle=a,i.fillRect(0,0,e,e);var o=new t.Texture(r);return o.needsUpdate=!0,o}},{key:"update",value:function(){this._isAnimate&&(this._texture_offset<=0?this._texture_offset=1:this._texture_offset-=.03*this._conf.speed,this._texture&&this._texture.offset.set(0,this._texture_offset))}}])}();function pe(t){let e,r,i,a=-1,o=0;for(let n=0;n<t.length;++n){const s=t[n];if(s.isInterleavedBufferAttribute)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. InterleavedBufferAttributes are not supported."),null;if(void 0===e&&(e=s.array.constructor),e!==s.array.constructor)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.array must be of consistent array types across matching attributes."),null;if(void 0===r&&(r=s.itemSize),r!==s.itemSize)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.itemSize must be consistent across matching attributes."),null;if(void 0===i&&(i=s.normalized),i!==s.normalized)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.normalized must be consistent across matching attributes."),null;if(-1===a&&(a=s.gpuType),a!==s.gpuType)return console.error("THREE.BufferGeometryUtils: .mergeAttributes() failed. BufferAttribute.gpuType must be consistent across matching attributes."),null;o+=s.array.length}const s=new e(o);let l=0;for(let e=0;e<t.length;++e)s.set(t[e].array,l),l+=t[e].array.length;const u=new n(s,r,i);return void 0!==a&&(u.gpuType=a),u}function ve(t,e){if(e===r)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),t;if(e===i||e===a){let n=t.getIndex();if(null===n){const e=[],r=t.getAttribute("position");if(void 0===r)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),t;for(let t=0;t<r.count;t++)e.push(t);t.setIndex(e),n=t.getIndex()}const r=n.count-2,a=[];if(e===i)for(let t=1;t<=r;t++)a.push(n.getX(0)),a.push(n.getX(t)),a.push(n.getX(t+1));else for(let t=0;t<r;t++)t%2==0?(a.push(n.getX(t)),a.push(n.getX(t+1)),a.push(n.getX(t+2))):(a.push(n.getX(t+2)),a.push(n.getX(t+1)),a.push(n.getX(t)));a.length/3!==r&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const o=t.clone();return o.setIndex(a),o.clearGroups(),o}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",e),t}function me(t,n=!1){return console.warn("THREE.BufferGeometryUtils: mergeBufferGeometries() has been renamed to mergeGeometries()."),function(t,n=!1){const r=null!==t[0].index,i=new Set(Object.keys(t[0].attributes)),a=new Set(Object.keys(t[0].morphAttributes)),o={},s={},l=t[0].morphTargetsRelative,u=new e;let c=0;for(let e=0;e<t.length;++e){const h=t[e];let d=0;if(r!==(null!==h.index))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+". All geometries must have compatible attributes; make sure index attribute exists among all geometries, or in none of them."),null;for(const t in h.attributes){if(!i.has(t))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+'. All geometries must have compatible attributes; make sure "'+t+'" attribute exists among all geometries, or in none of them.'),null;void 0===o[t]&&(o[t]=[]),o[t].push(h.attributes[t]),d++}if(d!==i.size)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+". Make sure all geometries have the same number of attributes."),null;if(l!==h.morphTargetsRelative)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+". .morphTargetsRelative must be consistent throughout all geometries."),null;for(const t in h.morphAttributes){if(!a.has(t))return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+".  .morphAttributes must be consistent throughout all geometries."),null;void 0===s[t]&&(s[t]=[]),s[t].push(h.morphAttributes[t])}if(n){let t;if(r)t=h.index.count;else{if(void 0===h.attributes.position)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed with geometry at index "+e+". The geometry must have either an index or a position attribute"),null;t=h.attributes.position.count}u.addGroup(c,t,e),c+=t}}if(r){let e=0;const n=[];for(let r=0;r<t.length;++r){const i=t[r].index;for(let t=0;t<i.count;++t)n.push(i.getX(t)+e);e+=t[r].attributes.position.count}u.setIndex(n)}for(const t in o){const e=pe(o[t]);if(!e)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+t+" attribute."),null;u.setAttribute(t,e)}for(const t in s){const e=s[t][0].length;if(0===e)break;u.morphAttributes=u.morphAttributes||{},u.morphAttributes[t]=[];for(let n=0;n<e;++n){const e=[];for(let r=0;r<s[t].length;++r)e.push(s[t][r][n]);const r=pe(e);if(!r)return console.error("THREE.BufferGeometryUtils: .mergeGeometries() failed while trying to merge the "+t+" morphAttribute."),null;u.morphAttributes[t].push(r)}}return u}(t,n)}var ge="\n      varying vec2 vUv;\n      varying vec3 v_position;\n      varying vec3 vNormal; //点法线向量\n      void main() {\n          vUv = uv;\n          vNormal = normal;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n          v_position = vec3(modelMatrix * vec4(position, 1.0));\n      }\n  ",ye="   \n     varying vec2 vUv;\n     varying vec3 v_position;\n     varying vec3 vNormal;\n\n     uniform float innerCircleWidth;\n     uniform float circleWidth;\n     uniform float opacity;\n     uniform vec3 center;\n\n     uniform vec3 color;\n     uniform sampler2D topMap;\n     uniform sampler2D sideMap;\n\n     void main() {\n       float dis = length(v_position - center);\n\n       // 与波动有交集\n       if(dis < (innerCircleWidth + circleWidth) && dis > innerCircleWidth) {\n          float r = (dis - innerCircleWidth) / circleWidth;\n          if (vNormal.z > 0.0) {\n            gl_FragColor = mix(texture2D(topMap, vUv), vec4(color, opacity), r); //位于顶部\n          }else{\n            gl_FragColor = mix(texture2D(sideMap, vUv), vec4(color, opacity), r); //位于侧面\n          }          \n       }else {         \n          if (vNormal.z > 0.0) {\n            gl_FragColor = texture2D( topMap, vUv);\n          }else{\n            gl_FragColor = texture2D( sideMap, vUv);\n          }\n       }  \n     }\n  ",_e=function(){function e(t){var n;Gt(this,e);var r=qt({animate:!0,zooms:[5,14],data:null,sideMap:null,topMap:null,color:null,circleWidth:50,maxRadius:1e3,circleCenter:[0,0],pulseSpeed:1,heightField:"height"},t);return Ht(n=zt(this,e,[r]),"_data",[]),Ht(n,"_map",null),Ht(n,"_defaultHeight",50),Ht(n,"_uniforms",{topMap:{value:null},sideMap:{value:null},innerCircleWidth:{value:0},circleWidth:{value:null},color:{value:null},opacity:{value:.8},center:{value:null}}),Ht(n,"_mt",{side:null,top:null}),Ht(n,"_limitCount",0),Ht(n,"_limitMax",5e4),n.initData(r.data),n.initProps(),n}return Yt(e,ue),jt(e,[{key:"initData",value:function(t){var e=this,n=t.features,r=this._conf.heightField;this._data=JSON.parse(JSON.stringify(n)),this._data.forEach((function(t,n){var i=t.geometry,a=t.properties,o=i.type,s=i.coordinates;"MultiPolygon"===o&&(t.geometry.coordinates=s.map((function(t){return e.customCoords.lngLatsToCoords(t)}))),"Polygon"===o&&(t.geometry.coordinates=e.customCoords.lngLatsToCoords(s)),t.properties.height=a[r]})),console.log(this._data)}},{key:"initProps",value:function(){var e=this._conf,n=this._uniforms;if(this._baseURL,e.sideMap?n.sideMap.value=e.sideMap:n.sideMap.value=(new t.TextureLoader).load(this.mergeSourceURL("./static/texture/texture_building_1.png")),e.topMap)n.topMap.value=e.topMap;else{var r=(new t.TextureLoader).load(this.mergeSourceURL("./static/texture/texture_building_2.png"));n.topMap.value=r}n.color.value=e.color||new t.Color(5563129),n.circleWidth.value=e.circleWidth,n.center.value=new t.Vector3(this._conf.circleCenter[0],this._conf.circleCenter[1],0)}},{key:"onReady",value:function(){this.initMt(),this.createPolygon()}},{key:"initMt",value:function(){var e=ge,n=ye,r=this._uniforms,i=r.sideMap,a=r.topMap,o=r.innerCircleWidth,s=r.circleWidth,l=r.color,u=r.opacity,c=r.center;this._mt=new t.ShaderMaterial({uniforms:{topMap:a,sideMap:i,innerCircleWidth:o,circleWidth:s,color:l,opacity:u,center:c},vertexShader:e,fragmentShader:n,side:t.DoubleSide,depthTest:!0,transparent:!0})}},{key:"createPolygon",value:function(){var e=this,n=[],r=[];this._data.forEach((function(t,i){var a=t.geometry,o=t.properties,s=a.type,l=a.coordinates;if("Polygon"===s){var u=e._createPolygon(l,o),c=u.sides,h=u.tops;n=n.concat(c),r=r.concat(h)}"MultiPolygon"===s&&l.forEach((function(t){var i=e._createPolygon(t,o),a=i.sides,s=i.tops;n=n.concat(a),r=r.concat(s)}))}));var i=new t.Mesh(me(n,!1),this._mt);this.scene.add(i);var a=new t.Mesh(me(r,!1),this._mt);this.scene.add(a)}},{key:"_createPolygon",value:function(){var t=this,e=arguments.length>1?arguments[1]:void 0,n=[],r=[];return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).forEach((function(i){if(!(t._limitCount>=t._limitMax)){var a=t.drawSide(i,e);n.push(a);var o=t.drawTop(i,e);r.push(o),t._limitCount++}})),{sides:n,tops:r}}},{key:"drawSide",value:function(t,e){var n=e.height;return e.name,e.fill,this.createSideGeometry(t,n||this._defaultHeight)}},{key:"drawTop",value:function(e,n){var r=n.height;n.name;var i=new t.Shape;e.forEach((function(t,e){var n=te(t,2),r=n[0],a=n[1];0===e?i.moveTo(r,a):i.lineTo(r,a)}));var a=new t.ShapeGeometry(i),o=r||this._defaultHeight;return a.attributes.position.array.forEach((function(t,e){(e+1)%3==0&&(a.attributes.position.array[e]=o)})),a}},{key:"createSideGeometry",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(e instanceof Array==!1)throw"createSideGeometry: path must be array";e[0].toString()!==e[e.length-1].toString()&&e.push(e[0]);for(var r=[],i=[],a=[],o=[0,0],s=[1,0],l=[1,1],u=[0,1],c=0;c<e.length;c++){var h=te(e[c],2),d=h[0],f=h[1];r.push([d,f,0]),r.push([d,f,n])}for(var p=0;p<r.length-2;p++)p%2==0?(i=[].concat(ee(i),ee(r[p]),ee(r[p+2]),ee(r[p+1])),a=[].concat(ee(a),o,s,u)):(i=[].concat(ee(i),ee(r[p]),ee(r[p+1]),ee(r[p+2])),a=[].concat(ee(a),u,s,l));var v=new t.BufferGeometry;return v.setAttribute("position",new t.BufferAttribute(new Float32Array(i),3)),v.setAttribute("uv",new t.BufferAttribute(new Float32Array(a),2)),v}},{key:"update",value:function(){if(this._isAnimate){var t=this._uniforms,e=t.innerCircleWidth;t.circleWidth,t.opacity,e.value+=10*this._conf.pulseSpeed,e.value>this._conf.maxRadius&&(e.value=0)}}},{key:"setSweepStyle",value:function(t){this._uniforms.center.value=t.center}}])}(),xe=function(){function e(t){var n;Gt(this,e);var r=qt({animate:!0,zooms:[5,14],data:null,interact:!0,style:{initial:{color:"#ffffff",opacity:.3},hover:{color:"#ff0000",opacity:.8}}},t);return Ht(n=zt(this,e,[r]),"_data",[]),Ht(n,"_map",null),Ht(n,"_mt",null),n.initData(r.data),n}return Yt(e,ue),jt(e,[{key:"initData",value:function(t){var e=this,n=t.features;this._data=JSON.parse(JSON.stringify(n)),this._data.forEach((function(t,n){var r=t.geometry,i=r.type,a=r.coordinates;"MultiPolygon"===i&&(t.geometry.coordinates=a.map((function(t){return e.customCoords.lngLatsToCoords(t)}))),"Polygon"===i&&(t.geometry.coordinates=e.customCoords.lngLatsToCoords(a))})),console.log(this._data)}},{key:"onReady",value:function(){this.initMaterial(),this.createPolygon()}},{key:"onPicked",value:function(t){var e,n,r=t.targets,i=t.event,a=null;if(r.length>0){var o,s=null===(o=r[0])||void 0===o?void 0:o.object;"Mesh"==(null==s?void 0:s.type)?(this.setLastPick(s),a=s._attrs):this.removeLastPick()}else this.removeLastPick();this.handleEvent("pick",{screenX:null==i||null===(e=i.pixel)||void 0===e?void 0:e.x,screenY:null==i||null===(n=i.pixel)||void 0===n?void 0:n.y,attrs:a})}},{key:"setLastPick",value:function(t){var e=this._lastPick;this.scene,t&&(e&&e&&JSON.stringify(null==e?void 0:e._attrs)===JSON.stringify(null==t?void 0:t._attrs)||(this.removeLastPick(),t.material=this._mt.hover,this._lastPick=t))}},{key:"removeLastPick",value:function(){var t=this._lastPick;this.scene,t&&(t.material=this._mt.initial,this._lastPick=null)}},{key:"initMaterial",value:function(){var e=this._conf.style,n=e.initial,r=e.hover;this._mt={},this._mt.initial=new t.MeshBasicMaterial({color:n.color,transparent:!0,opacity:n.opacity,side:t.DoubleSide,wireframe:!1}),this._mt.hover=new t.MeshBasicMaterial({color:r.color,transparent:!0,opacity:r.opacity,side:t.DoubleSide})}},{key:"createPolygon",value:function(){var e=this,n=this._mt.initial,r=[],i=[];this._data.forEach((function(t,n){var a=t.geometry,o=t.properties,s=a.type,l=a.coordinates;if("Polygon"===s){var u=e._createPolygon(l,o),c=u.sides,h=u.tops;r=r.concat(c),i=i.concat(h)}"MultiPolygon"===s&&l.forEach((function(t){var n=e._createPolygon(t,o),a=n.sides,s=n.tops;r=r.concat(a),i=i.concat(s)}))})),r.forEach((function(r){var i=new t.Mesh(r,n);i._attrs=r._attrs,delete r._attrs,e.scene.add(i)}))}},{key:"_createPolygon",value:function(){var t=this,e=arguments.length>1?arguments[1]:void 0,n=[],r=[];return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).forEach((function(i){var a=t.drawSide(i,e);n=[].concat(ee(n),ee(a));var o=t.drawTop(i,e);r=[].concat(ee(r),ee(o))})),{sides:n,tops:r}}},{key:"drawSide",value:function(t,e){for(var n=e.regions,r=[],i=0;i<=n.length-1;i++){var a=this.createSideGeometry(t,n[i]);a._attrs=qt({},n[i]),r.push(a)}return r}},{key:"drawTop",value:function(e,n){for(var r=n.regions,i=[],a=function(){var n=new t.Shape,a=r[o],s=a.bottomAltitude,l=a.extendAltitude;e.forEach((function(t,e){var r=te(t,2),i=r[0],a=r[1];0===e?n.moveTo(i,a):n.lineTo(i,a)}));var u=new t.ShapeGeometry(n),c=s+l;u.attributes.position.array.forEach((function(t,e){(e+1)%3==0&&(u.attributes.position.array[e]=c)})),i.push(u)},o=0;o<=r.length-1;o++)a();return i}},{key:"createSideGeometry",value:function(e,n){if(e instanceof Array==!1)throw"createSideGeometry: path must be array";n.id;var r=n.bottomAltitude,i=n.extendAltitude;e[0].toString()!==e[e.length-1].toString()&&e.push(e[0]);for(var a=[],o=[],s=[],l=[0,0],u=[1,0],c=[1,1],h=[0,1],d=0;d<e.length;d++){var f=te(e[d],2),p=f[0],v=f[1];a.push([p,v,r]),a.push([p,v,r+i])}for(var m=0;m<a.length-2;m++)m%2==0?(o=[].concat(ee(o),ee(a[m]),ee(a[m+2]),ee(a[m+1])),s=[].concat(ee(s),l,u,h)):(o=[].concat(ee(o),ee(a[m]),ee(a[m+1]),ee(a[m+2])),s=[].concat(ee(s),h,u,c));var g=new t.BufferGeometry;return g.setAttribute("position",new t.BufferAttribute(new Float32Array(o),3)),g.setAttribute("uv",new t.BufferAttribute(new Float32Array(s),2)),g}},{key:"update",value:function(){}}])}(),we=Object.defineProperty,be=function(t,e,n){return function(t,e,n){e in t?we(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n}(t,"symbol"!==re(e)?e+"":e,n),n};function Ae(t,e,n,r,i){var a;if(t=t.subarray||t.slice?t:t.buffer,n=n.subarray||n.slice?n:n.buffer,t=e?t.subarray?t.subarray(e,i&&e+i):t.slice(e,i&&e+i):t,n.set)n.set(t,r);else for(a=0;a<t.length;a++)n[a+r]=t[a];return n}var Me=function(){function e(){var n;return Gt(this,e),n=zt(this,e),be(n,"type","MeshLine"),be(n,"isMeshLine",!0),be(n,"positions",[]),be(n,"previous",[]),be(n,"next",[]),be(n,"side",[]),be(n,"width",[]),be(n,"indices_array",[]),be(n,"uvs",[]),be(n,"counters",[]),be(n,"widthCallback",null),be(n,"_attributes"),be(n,"_points",[]),be(n,"points"),be(n,"matrixWorld",new t.Matrix4),Object.defineProperties(n,{points:{enumerable:!0,get:function(){return this._points},set:function(t){this.setPoints(t,this.widthCallback)}}}),n}return Yt(e,t.BufferGeometry),jt(e,[{key:"setMatrixWorld",value:function(t){this.matrixWorld=t}},{key:"setPoints",value:function(e,n){if(e=function(e){return e instanceof Float32Array?e:e instanceof t.BufferGeometry?e.getAttribute("position").array:e.map((function(e){var n=Array.isArray(e);return e instanceof t.Vector3?[e.x,e.y,e.z]:e instanceof t.Vector2?[e.x,e.y,0]:n&&3===e.length?[e[0],e[1],e[2]]:n&&2===e.length?[e[0],e[1],0]:e})).flat()}(e),this._points=e,this.widthCallback=null!=n?n:null,this.positions=[],this.counters=[],e.length&&e[0]instanceof t.Vector3)for(var r=0;r<e.length;r++){var i=e[r],a=r/(e.length-1);this.positions.push(i.x,i.y,i.z),this.positions.push(i.x,i.y,i.z),this.counters.push(a),this.counters.push(a)}else for(var o=0;o<e.length;o+=3){var s=o/(e.length-1);this.positions.push(e[o],e[o+1],e[o+2]),this.positions.push(e[o],e[o+1],e[o+2]),this.counters.push(s),this.counters.push(s)}this.process()}},{key:"compareV3",value:function(t,e){var n=6*t,r=6*e;return this.positions[n]===this.positions[r]&&this.positions[n+1]===this.positions[r+1]&&this.positions[n+2]===this.positions[r+2]}},{key:"copyV3",value:function(t){var e=6*t;return[this.positions[e],this.positions[e+1],this.positions[e+2]]}},{key:"process",value:function(){var e,n,r=this.positions.length/6;this.previous=[],this.next=[],this.side=[],this.width=[],this.indices_array=[],this.uvs=[],n=this.compareV3(0,r-1)?this.copyV3(r-2):this.copyV3(0),this.previous.push(n[0],n[1],n[2]),this.previous.push(n[0],n[1],n[2]);for(var i=0;i<r;i++){if(this.side.push(1),this.side.push(-1),e=this.widthCallback?this.widthCallback(i/(r-1)):1,this.width.push(e),this.width.push(e),this.uvs.push(i/(r-1),0),this.uvs.push(i/(r-1),1),i<r-1){n=this.copyV3(i),this.previous.push(n[0],n[1],n[2]),this.previous.push(n[0],n[1],n[2]);var a=2*i;this.indices_array.push(a,a+1,a+2),this.indices_array.push(a+2,a+1,a+3)}i>0&&(n=this.copyV3(i),this.next.push(n[0],n[1],n[2]),this.next.push(n[0],n[1],n[2]))}n=this.compareV3(r-1,0)?this.copyV3(1):this.copyV3(r-1),this.next.push(n[0],n[1],n[2]),this.next.push(n[0],n[1],n[2]),this._attributes&&this._attributes.position.count===this.positions.length?(this._attributes.position.copyArray(new Float32Array(this.positions)),this._attributes.position.needsUpdate=!0,this._attributes.previous.copyArray(new Float32Array(this.previous)),this._attributes.previous.needsUpdate=!0,this._attributes.next.copyArray(new Float32Array(this.next)),this._attributes.next.needsUpdate=!0,this._attributes.side.copyArray(new Float32Array(this.side)),this._attributes.side.needsUpdate=!0,this._attributes.width.copyArray(new Float32Array(this.width)),this._attributes.width.needsUpdate=!0,this._attributes.uv.copyArray(new Float32Array(this.uvs)),this._attributes.uv.needsUpdate=!0,this._attributes.index.copyArray(new Uint16Array(this.indices_array)),this._attributes.index.needsUpdate=!0):this._attributes={position:new t.BufferAttribute(new Float32Array(this.positions),3),previous:new t.BufferAttribute(new Float32Array(this.previous),3),next:new t.BufferAttribute(new Float32Array(this.next),3),side:new t.BufferAttribute(new Float32Array(this.side),1),width:new t.BufferAttribute(new Float32Array(this.width),1),uv:new t.BufferAttribute(new Float32Array(this.uvs),2),index:new t.BufferAttribute(new Uint16Array(this.indices_array),1),counters:new t.BufferAttribute(new Float32Array(this.counters),1)},this.setAttribute("position",this._attributes.position),this.setAttribute("previous",this._attributes.previous),this.setAttribute("next",this._attributes.next),this.setAttribute("side",this._attributes.side),this.setAttribute("width",this._attributes.width),this.setAttribute("uv",this._attributes.uv),this.setAttribute("counters",this._attributes.counters),this.setAttribute("position",this._attributes.position),this.setAttribute("previous",this._attributes.previous),this.setAttribute("next",this._attributes.next),this.setAttribute("side",this._attributes.side),this.setAttribute("width",this._attributes.width),this.setAttribute("uv",this._attributes.uv),this.setAttribute("counters",this._attributes.counters),this.setIndex(this._attributes.index),this.computeBoundingSphere(),this.computeBoundingBox()}},{key:"advance",value:function(t){var e=t.x,n=t.y,r=t.z,i=this._attributes.position.array,a=this._attributes.previous.array,o=this._attributes.next.array,s=i.length;Ae(i,0,a,0,s),Ae(i,6,i,0,s-6),i[s-6]=e,i[s-5]=n,i[s-4]=r,i[s-3]=e,i[s-2]=n,i[s-1]=r,Ae(i,6,o,0,s-6),o[s-6]=e,o[s-5]=n,o[s-4]=r,o[s-3]=e,o[s-2]=n,o[s-1]=r,this._attributes.position.needsUpdate=!0,this._attributes.previous.needsUpdate=!0,this._attributes.next.needsUpdate=!0}}])}(),Te=function(){function e(n){var r;return Gt(this,e),r=zt(this,e,[{uniforms:qt(qt({},t.UniformsLib.fog),{},{lineWidth:{value:1},map:{value:null},useMap:{value:0},alphaMap:{value:null},useAlphaMap:{value:0},color:{value:new t.Color(16777215)},opacity:{value:1},resolution:{value:new t.Vector2(1,1)},sizeAttenuation:{value:1},dashArray:{value:0},dashOffset:{value:0},dashRatio:{value:.5},useDash:{value:0},visibility:{value:1},alphaTest:{value:0},repeat:{value:new t.Vector2(1,1)},offset:{value:new t.Vector2(1,1)}}),vertexShader:"\n  #include <common>\n  #include <logdepthbuf_pars_vertex>\n  #include <fog_pars_vertex>\n\n  attribute vec3 previous;\n  attribute vec3 next;\n  attribute float side;\n  attribute float width;\n  attribute float counters;\n  \n  uniform vec2 resolution;\n  uniform float lineWidth;\n  uniform vec3 color;\n  uniform float opacity;\n  uniform float sizeAttenuation;\n  uniform vec2 offset;\n  \n  varying vec2 vUV;\n  varying vec4 vColor;\n  varying float vCounters;\n  \n  vec2 fix(vec4 i, float aspect) {\n    vec2 res = i.xy / i.w;\n    res.x *= aspect;\n  \tvCounters = counters;\n    return res;\n  }\n  \n  void main() {\n    float aspect = resolution.x / resolution.y;\n    vColor = vec4(color, opacity);\n    vUV = uv + offset;\n  \n    mat4 m = projectionMatrix * modelViewMatrix;\n    vec4 finalPosition = m * vec4(position, 1.0);\n    vec4 prevPos = m * vec4(previous, 1.0);\n    vec4 nextPos = m * vec4(next, 1.0);\n  \n    vec2 currentP = fix(finalPosition, aspect);\n    vec2 prevP = fix(prevPos, aspect);\n    vec2 nextP = fix(nextPos, aspect);\n  \n    float w = lineWidth * width;\n  \n    vec2 dir;\n    if (nextP == currentP) dir = normalize(currentP - prevP);\n    else if (prevP == currentP) dir = normalize(nextP - currentP);\n    else {\n      vec2 dir1 = normalize(currentP - prevP);\n      vec2 dir2 = normalize(nextP - currentP);\n      dir = normalize(dir1 + dir2);\n  \n      vec2 perp = vec2(-dir1.y, dir1.x);\n      vec2 miter = vec2(-dir.y, dir.x);\n      //w = clamp(w / dot(miter, perp), 0., 4. * lineWidth * width);\n    }\n  \n    //vec2 normal = (cross(vec3(dir, 0.), vec3(0., 0., 1.))).xy;\n    vec4 normal = vec4(-dir.y, dir.x, 0., 1.);\n    normal.xy *= .5 * w;\n    //normal *= projectionMatrix;\n    if (sizeAttenuation == 0.) {\n      normal.xy *= finalPosition.w;\n      normal.xy /= (vec4(resolution, 0., 1.) * projectionMatrix).xy;\n    }\n  \n    finalPosition.xy += normal.xy * side;\n    gl_Position = finalPosition;\n    #include <logdepthbuf_vertex>\n    #include <fog_vertex>\n    vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);\n    #include <fog_vertex>\n  }\n",fragmentShader:"\n  #include <fog_pars_fragment>\n  #include <logdepthbuf_pars_fragment>\n  \n  uniform sampler2D map;\n  uniform sampler2D alphaMap;\n  uniform float useMap;\n  uniform float useAlphaMap;\n  uniform float useDash;\n  uniform float dashArray;\n  uniform float dashOffset;\n  uniform float dashRatio;\n  uniform float visibility;\n  uniform float alphaTest;\n  uniform vec2 repeat;\n  \n  varying vec2 vUV;\n  varying vec4 vColor;\n  varying float vCounters;\n  \n  void main() {\n    #include <logdepthbuf_fragment>\n    vec4 c = vColor;\n    if (useMap == 1.) c *= texture2D(map, vUV * repeat);\n    if (useAlphaMap == 1.) c.a *= texture2D(alphaMap, vUV * repeat).a;\n    if (c.a < alphaTest) discard;\n    if (useDash == 1.) {\n      c.a *= ceil(mod(vCounters + dashOffset, dashArray) - (dashArray * dashRatio));\n    }\n    gl_FragColor = c;\n    gl_FragColor.a *= step(vCounters, visibility);\n    #include <fog_fragment>\n    #include <tonemapping_fragment>\n    #include <encodings_fragment>\n  }\n"}]),be(r,"lineWidth"),be(r,"map"),be(r,"useMap"),be(r,"alphaMap"),be(r,"useAlphaMap"),be(r,"color"),be(r,"resolution"),be(r,"sizeAttenuation"),be(r,"dashArray"),be(r,"dashOffset"),be(r,"dashRatio"),be(r,"useDash"),be(r,"visibility"),be(r,"repeat"),r.type="MeshLineMaterial",Object.defineProperties(r,{lineWidth:{enumerable:!0,get:function(){return this.uniforms.lineWidth.value},set:function(t){this.uniforms.lineWidth.value=t}},map:{enumerable:!0,get:function(){return this.uniforms.map.value},set:function(t){this.uniforms.map.value=t}},useMap:{enumerable:!0,get:function(){return this.uniforms.useMap.value},set:function(t){this.uniforms.useMap.value=t}},alphaMap:{enumerable:!0,get:function(){return this.uniforms.alphaMap.value},set:function(t){this.uniforms.alphaMap.value=t}},useAlphaMap:{enumerable:!0,get:function(){return this.uniforms.useAlphaMap.value},set:function(t){this.uniforms.useAlphaMap.value=t}},color:{enumerable:!0,get:function(){return this.uniforms.color.value},set:function(t){this.uniforms.color.value=t}},opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(t){this.uniforms.opacity.value=t}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(t){this.uniforms.resolution.value.copy(t)}},sizeAttenuation:{enumerable:!0,get:function(){return this.uniforms.sizeAttenuation.value},set:function(t){this.uniforms.sizeAttenuation.value=t}},dashArray:{enumerable:!0,get:function(){return this.uniforms.dashArray.value},set:function(t){this.uniforms.dashArray.value=t,this.useDash=0!==t?1:0}},dashOffset:{enumerable:!0,get:function(){return this.uniforms.dashOffset.value},set:function(t){this.uniforms.dashOffset.value=t}},dashRatio:{enumerable:!0,get:function(){return this.uniforms.dashRatio.value},set:function(t){this.uniforms.dashRatio.value=t}},useDash:{enumerable:!0,get:function(){return this.uniforms.useDash.value},set:function(t){this.uniforms.useDash.value=t}},visibility:{enumerable:!0,get:function(){return this.uniforms.visibility.value},set:function(t){this.uniforms.visibility.value=t}},alphaTest:{enumerable:!0,get:function(){return this.uniforms.alphaTest.value},set:function(t){this.uniforms.alphaTest.value=t}},repeat:{enumerable:!0,get:function(){return this.uniforms.repeat.value},set:function(t){this.uniforms.repeat.value.copy(t)}}}),r.setValues(n),r}return Yt(e,t.ShaderMaterial),jt(e,[{key:"copy",value:function(t){var n,r,i,a,o;return(n=e,r="copy",i=this,o=Wt(Xt(1&(a=3)?n.prototype:n),r,i),2&a&&"function"==typeof o?function(t){return o.apply(i,t)}:o)([t]),this.lineWidth=t.lineWidth,this.map=t.map,this.useMap=t.useMap,this.alphaMap=t.alphaMap,this.useAlphaMap=t.useAlphaMap,this.color.copy(t.color),this.opacity=t.opacity,this.resolution.copy(t.resolution),this.sizeAttenuation=t.sizeAttenuation,this.dashArray=t.dashArray,this.dashOffset=t.dashOffset,this.dashRatio=t.dashRatio,this.useDash=t.useDash,this.visibility=t.visibility,this.alphaTest=t.alphaTest,this.repeat.copy(t.repeat),this}}])}(),Se=function(){function e(t){var n;Gt(this,e);var r=qt({data:null,opacity:1,altitude:0,animate:!1,speed:2,topMap:"./static/texture/rock1.jpg",topMapNormal:"./static/texture/rock1-normal.jpg",topColor:"#0d8ce7",topMapRepeat:[1e-4,1e-4],sideMap:"./static/texture/texture_cake_1.png",borderColor:"#10ecda",borderWidth:300,borderMap:void 0},t);return Ht(n=zt(this,e,[r]),"_paths",[]),Ht(n,"_borderMaterial",null),void 0===r.data?(console.log("props data is required"),Zt(n)):(n.initData(r.data),n._data=r.data,n)}return Yt(e,ue),jt(e,[{key:"initLight",value:function(){var e=new t.AmbientLight(16777215,.2);this.scene.add(e)}},{key:"onReady",value:function(){this.initLight(),this.initArea()}},{key:"initData",value:function(t){var e=this;t.features.forEach((function(t){t.geometry.coordinates.forEach((function(t){var n=t[0][0]instanceof Array?t[0]:t,r=e.customCoords.lngLatsToCoords(n);e._paths.push(r)}))}))}},{key:"initArea",value:function(){var t=this,e=this._data.features,n=this._conf.borderWidth;e.forEach((function(e,r){var i=t._paths[r],a=e.properties;t.drawSide(i,a),t.drawOneArea(i,a),n>0&&t.drawBorder(i,a)}))}},{key:"drawOneArea",value:function(e,n){var r=n.height;n.name;var i=this.scene,a=this._conf.altitude,o=new t.Shape;e.forEach((function(t,e){var n=te(t,2),r=n[0],i=n[1];0===e?o.moveTo(r,i):o.lineTo(r,i)}));var s=new t.ShapeGeometry(o),l=new t.Mesh(s,this.getMaterial());l.position.z=a+r||0,i.add(l)}},{key:"getMaterial",value:function(){var e=this._conf,n=e.topColor,r=e.topMap,i=e.topMapNormal,a=e.opacity,o=e.topMapRepeat,s=new t.MeshPhongMaterial({side:t.DoubleSide,transparent:!0,depthWrite:!0,color:n,opacity:a});if(r){var l=te(o,2),u=l[0],c=l[1],h=(new t.TextureLoader).load(this.mergeSourceURL(r),(function(){}),null,(function(){console.error("topMap load error")}));h.wrapS=t.RepeatWrapping,h.wrapT=t.RepeatWrapping,h.repeat.set(u,c);var d=(new t.TextureLoader).load(this.mergeSourceURL(i),(function(){}),null,(function(){console.error("topMapNormal load error")}));h.wrapS=t.RepeatWrapping,h.wrapT=t.RepeatWrapping,h.repeat.set(u,c),s.map=h,s.normalMap=d}return s}},{key:"drawSide",value:function(e,n){var r=n.height,i=void 0===r?0:r;if(n.name,!(i<=0)){var a=this._conf.altitude,o=e;o[0].toString()!==o[o.length-1].toString()&&o.push(o[0]);for(var s=[],l=[],u=[],c=[0,0],h=[1,0],d=[1,1],f=[0,1],p=0;p<o.length;p++){var v=te(o[p],2),m=v[0],g=v[1];s.push([m,g,a]),s.push([m,g,a+i])}for(var y=0;y<s.length-2;y++)y%2==0?(l=[].concat(ee(l),ee(s[y]),ee(s[y+2]),ee(s[y+1])),u=[].concat(ee(u),c,h,f)):(l=[].concat(ee(l),ee(s[y]),ee(s[y+1]),ee(s[y+2])),u=[].concat(ee(u),f,h,d));var _=new t.BufferGeometry;_.setAttribute("position",new t.BufferAttribute(new Float32Array(l),3)),_.setAttribute("uv",new t.BufferAttribute(new Float32Array(u),2));var x=new t.MeshBasicMaterial({side:t.DoubleSide,transparent:!0,depthWrite:!0});if(this._conf.sideMap){var w=(new t.TextureLoader).load(this._conf.sideMap,(function(){}),null,(function(){console.error("sideMap load error")}));w.wrapS=t.RepeatWrapping,w.wrapT=t.RepeatWrapping,w.offset.set(0,1),x.map=w}var b=new t.Mesh(_,x);this.scene.add(b)}}},{key:"drawBorder",value:function(e,n){var r=n.height;n.name;var i=this._conf.altitude,a=e.map((function(e){var n=te(e,2),a=n[0],o=n[1];return new t.Vector3(a,o,i+1.01*r)})),o=new Me;o.setPoints(a);var s=new t.Mesh(o,this.getBorderMaterial());this.scene.add(s)}},{key:"getBorderMaterial",value:function(){if(null==this._borderMaterial){var e,n=this._conf,r=n.borderWidth,i=n.borderColor,a=n.borderMap,o=new Te({lineWidth:r,sizeAttenuation:1,useMap:a?1:0,opacity:1,transparent:!1});a?((e=(new t.TextureLoader).load(this._conf.borderMap,(function(){}),null,(function(){console.error("borderMap load error")}))).wrapS=t.RepeatWrapping,e.wrapT=t.RepeatWrapping,o.map=e):o.color=new t.Color(i),this._borderMaterial=o}return this._borderMaterial}},{key:"update",value:function(){this._isAnimate&&this._borderMaterial&&(this._borderMaterial.uniforms.offset.value.x+=.005)}}])}();class ke extends o{constructor(t){super(t),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(t){return new Ie(t)})),this.register((function(t){return new Ge(t)})),this.register((function(t){return new Ve(t)})),this.register((function(t){return new je(t)})),this.register((function(t){return new De(t)})),this.register((function(t){return new Ne(t)})),this.register((function(t){return new Ue(t)})),this.register((function(t){return new Fe(t)})),this.register((function(t){return new Re(t)})),this.register((function(t){return new Be(t)})),this.register((function(t){return new Oe(t)})),this.register((function(t){return new ze(t)})),this.register((function(t){return new Le(t)})),this.register((function(t){return new He(t)})),this.register((function(t){return new We(t)}))}load(t,e,n,r){const i=this;let a;a=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:s.extractUrlBase(t),this.manager.itemStart(t);const o=function(e){r?r(e):console.error(e),i.manager.itemError(t),i.manager.itemEnd(t)},u=new l(this.manager);u.setPath(this.path),u.setResponseType("arraybuffer"),u.setRequestHeader(this.requestHeader),u.setWithCredentials(this.withCredentials),u.load(t,(function(n){try{i.parse(n,a,(function(n){e(n),i.manager.itemEnd(t)}),o)}catch(t){o(t)}}),n,o)}setDRACOLoader(t){return this.dracoLoader=t,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(t){return this.ktx2Loader=t,this}setMeshoptDecoder(t){return this.meshoptDecoder=t,this}register(t){return-1===this.pluginCallbacks.indexOf(t)&&this.pluginCallbacks.push(t),this}unregister(t){return-1!==this.pluginCallbacks.indexOf(t)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(t),1),this}parse(t,e,n,r){let i;const a={},o={},s=new TextDecoder;if("string"==typeof t)i=JSON.parse(t);else if(t instanceof ArrayBuffer){if(s.decode(new Uint8Array(t,0,4))===Xe){try{a[Ee.KHR_BINARY_GLTF]=new Qe(t)}catch(t){return void(r&&r(t))}i=JSON.parse(a[Ee.KHR_BINARY_GLTF].content)}else i=JSON.parse(s.decode(t))}else i=t;if(void 0===i.asset||i.asset.version[0]<2)return void(r&&r(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new wn(i,{path:e||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let t=0;t<this.pluginCallbacks.length;t++){const e=this.pluginCallbacks[t](l);o[e.name]=e,a[e.name]=!0}if(i.extensionsUsed)for(let t=0;t<i.extensionsUsed.length;++t){const e=i.extensionsUsed[t],n=i.extensionsRequired||[];switch(e){case Ee.KHR_MATERIALS_UNLIT:a[e]=new Pe;break;case Ee.KHR_DRACO_MESH_COMPRESSION:a[e]=new qe(i,this.dracoLoader);break;case Ee.KHR_TEXTURE_TRANSFORM:a[e]=new Ze;break;case Ee.KHR_MESH_QUANTIZATION:a[e]=new Je;break;default:n.indexOf(e)>=0&&void 0===o[e]&&console.warn('THREE.GLTFLoader: Unknown extension "'+e+'".')}}l.setExtensions(a),l.setPlugins(o),l.parse(n,r)}parseAsync(t,e){const n=this;return new Promise((function(r,i){n.parse(t,e,r,i)}))}}function Ce(){let t={};return{get:function(e){return t[e]},add:function(e,n){t[e]=n},remove:function(e){delete t[e]},removeAll:function(){t={}}}}const Ee={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class Le{constructor(t){this.parser=t,this.name=Ee.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const t=this.parser,e=this.parser.json.nodes||[];for(let n=0,r=e.length;n<r;n++){const r=e[n];r.extensions&&r.extensions[this.name]&&void 0!==r.extensions[this.name].light&&t._addNodeRef(this.cache,r.extensions[this.name].light)}}_loadLight(t){const e=this.parser,n="light:"+t;let r=e.cache.get(n);if(r)return r;const i=e.json,a=((i.extensions&&i.extensions[this.name]||{}).lights||[])[t];let o;const s=new u(16777215);void 0!==a.color&&s.setRGB(a.color[0],a.color[1],a.color[2],c);const l=void 0!==a.range?a.range:0;switch(a.type){case"directional":o=new f(s),o.target.position.set(0,0,-1),o.add(o.target);break;case"point":o=new d(s),o.distance=l;break;case"spot":o=new h(s),o.distance=l,a.spot=a.spot||{},a.spot.innerConeAngle=void 0!==a.spot.innerConeAngle?a.spot.innerConeAngle:0,a.spot.outerConeAngle=void 0!==a.spot.outerConeAngle?a.spot.outerConeAngle:Math.PI/4,o.angle=a.spot.outerConeAngle,o.penumbra=1-a.spot.innerConeAngle/a.spot.outerConeAngle,o.target.position.set(0,0,-1),o.add(o.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+a.type)}return o.position.set(0,0,0),o.decay=2,vn(o,a),void 0!==a.intensity&&(o.intensity=a.intensity),o.name=e.createUniqueName(a.name||"light_"+t),r=Promise.resolve(o),e.cache.add(n,r),r}getDependency(t,e){if("light"===t)return this._loadLight(e)}createNodeAttachment(t){const e=this,n=this.parser,r=n.json.nodes[t],i=(r.extensions&&r.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then((function(t){return n._getNodeRef(e.cache,i,t)}))}}class Pe{constructor(){this.name=Ee.KHR_MATERIALS_UNLIT}getMaterialType(){return p}extendParams(t,e,n){const r=[];t.color=new u(1,1,1),t.opacity=1;const i=e.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){const e=i.baseColorFactor;t.color.setRGB(e[0],e[1],e[2],c),t.opacity=e[3]}void 0!==i.baseColorTexture&&r.push(n.assignTexture(t,"map",i.baseColorTexture,v))}return Promise.all(r)}}class Re{constructor(t){this.parser=t,this.name=Ee.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(t,e){const n=this.parser.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name].emissiveStrength;return void 0!==r&&(e.emissiveIntensity=r),Promise.resolve()}}class Ie{constructor(t){this.parser=t,this.name=Ee.KHR_MATERIALS_CLEARCOAT}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?m:null}extendMaterialParams(t,e){const n=this.parser,r=n.json.materials[t];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],a=r.extensions[this.name];if(void 0!==a.clearcoatFactor&&(e.clearcoat=a.clearcoatFactor),void 0!==a.clearcoatTexture&&i.push(n.assignTexture(e,"clearcoatMap",a.clearcoatTexture)),void 0!==a.clearcoatRoughnessFactor&&(e.clearcoatRoughness=a.clearcoatRoughnessFactor),void 0!==a.clearcoatRoughnessTexture&&i.push(n.assignTexture(e,"clearcoatRoughnessMap",a.clearcoatRoughnessTexture)),void 0!==a.clearcoatNormalTexture&&(i.push(n.assignTexture(e,"clearcoatNormalMap",a.clearcoatNormalTexture)),void 0!==a.clearcoatNormalTexture.scale)){const t=a.clearcoatNormalTexture.scale;e.clearcoatNormalScale=new g(t,t)}return Promise.all(i)}}class Oe{constructor(t){this.parser=t,this.name=Ee.KHR_MATERIALS_IRIDESCENCE}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?m:null}extendMaterialParams(t,e){const n=this.parser,r=n.json.materials[t];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],a=r.extensions[this.name];return void 0!==a.iridescenceFactor&&(e.iridescence=a.iridescenceFactor),void 0!==a.iridescenceTexture&&i.push(n.assignTexture(e,"iridescenceMap",a.iridescenceTexture)),void 0!==a.iridescenceIor&&(e.iridescenceIOR=a.iridescenceIor),void 0===e.iridescenceThicknessRange&&(e.iridescenceThicknessRange=[100,400]),void 0!==a.iridescenceThicknessMinimum&&(e.iridescenceThicknessRange[0]=a.iridescenceThicknessMinimum),void 0!==a.iridescenceThicknessMaximum&&(e.iridescenceThicknessRange[1]=a.iridescenceThicknessMaximum),void 0!==a.iridescenceThicknessTexture&&i.push(n.assignTexture(e,"iridescenceThicknessMap",a.iridescenceThicknessTexture)),Promise.all(i)}}class De{constructor(t){this.parser=t,this.name=Ee.KHR_MATERIALS_SHEEN}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?m:null}extendMaterialParams(t,e){const n=this.parser,r=n.json.materials[t];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[];e.sheenColor=new u(0,0,0),e.sheenRoughness=0,e.sheen=1;const a=r.extensions[this.name];if(void 0!==a.sheenColorFactor){const t=a.sheenColorFactor;e.sheenColor.setRGB(t[0],t[1],t[2],c)}return void 0!==a.sheenRoughnessFactor&&(e.sheenRoughness=a.sheenRoughnessFactor),void 0!==a.sheenColorTexture&&i.push(n.assignTexture(e,"sheenColorMap",a.sheenColorTexture,v)),void 0!==a.sheenRoughnessTexture&&i.push(n.assignTexture(e,"sheenRoughnessMap",a.sheenRoughnessTexture)),Promise.all(i)}}class Ne{constructor(t){this.parser=t,this.name=Ee.KHR_MATERIALS_TRANSMISSION}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?m:null}extendMaterialParams(t,e){const n=this.parser,r=n.json.materials[t];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],a=r.extensions[this.name];return void 0!==a.transmissionFactor&&(e.transmission=a.transmissionFactor),void 0!==a.transmissionTexture&&i.push(n.assignTexture(e,"transmissionMap",a.transmissionTexture)),Promise.all(i)}}class Ue{constructor(t){this.parser=t,this.name=Ee.KHR_MATERIALS_VOLUME}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?m:null}extendMaterialParams(t,e){const n=this.parser,r=n.json.materials[t];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],a=r.extensions[this.name];e.thickness=void 0!==a.thicknessFactor?a.thicknessFactor:0,void 0!==a.thicknessTexture&&i.push(n.assignTexture(e,"thicknessMap",a.thicknessTexture)),e.attenuationDistance=a.attenuationDistance||1/0;const o=a.attenuationColor||[1,1,1];return e.attenuationColor=(new u).setRGB(o[0],o[1],o[2],c),Promise.all(i)}}class Fe{constructor(t){this.parser=t,this.name=Ee.KHR_MATERIALS_IOR}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?m:null}extendMaterialParams(t,e){const n=this.parser.json.materials[t];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const r=n.extensions[this.name];return e.ior=void 0!==r.ior?r.ior:1.5,Promise.resolve()}}class Be{constructor(t){this.parser=t,this.name=Ee.KHR_MATERIALS_SPECULAR}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?m:null}extendMaterialParams(t,e){const n=this.parser,r=n.json.materials[t];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],a=r.extensions[this.name];e.specularIntensity=void 0!==a.specularFactor?a.specularFactor:1,void 0!==a.specularTexture&&i.push(n.assignTexture(e,"specularIntensityMap",a.specularTexture));const o=a.specularColorFactor||[1,1,1];return e.specularColor=(new u).setRGB(o[0],o[1],o[2],c),void 0!==a.specularColorTexture&&i.push(n.assignTexture(e,"specularColorMap",a.specularColorTexture,v)),Promise.all(i)}}class ze{constructor(t){this.parser=t,this.name=Ee.KHR_MATERIALS_ANISOTROPY}getMaterialType(t){const e=this.parser.json.materials[t];return e.extensions&&e.extensions[this.name]?m:null}extendMaterialParams(t,e){const n=this.parser,r=n.json.materials[t];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const i=[],a=r.extensions[this.name];return void 0!==a.anisotropyStrength&&(e.anisotropy=a.anisotropyStrength),void 0!==a.anisotropyRotation&&(e.anisotropyRotation=a.anisotropyRotation),void 0!==a.anisotropyTexture&&i.push(n.assignTexture(e,"anisotropyMap",a.anisotropyTexture)),Promise.all(i)}}class Ge{constructor(t){this.parser=t,this.name=Ee.KHR_TEXTURE_BASISU}loadTexture(t){const e=this.parser,n=e.json,r=n.textures[t];if(!r.extensions||!r.extensions[this.name])return null;const i=r.extensions[this.name],a=e.options.ktx2Loader;if(!a){if(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return e.loadTextureImage(t,i.source,a)}}class Ve{constructor(t){this.parser=t,this.name=Ee.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(t){const e=this.name,n=this.parser,r=n.json,i=r.textures[t];if(!i.extensions||!i.extensions[e])return null;const a=i.extensions[e],o=r.images[a.source];let s=n.textureLoader;if(o.uri){const t=n.options.manager.getHandler(o.uri);null!==t&&(s=t)}return this.detectSupport().then((function(i){if(i)return n.loadTextureImage(t,a.source,s);if(r.extensionsRequired&&r.extensionsRequired.indexOf(e)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return n.loadTexture(t)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(t){const e=new Image;e.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",e.onload=e.onerror=function(){t(1===e.height)}}))),this.isSupported}}class je{constructor(t){this.parser=t,this.name=Ee.EXT_TEXTURE_AVIF,this.isSupported=null}loadTexture(t){const e=this.name,n=this.parser,r=n.json,i=r.textures[t];if(!i.extensions||!i.extensions[e])return null;const a=i.extensions[e],o=r.images[a.source];let s=n.textureLoader;if(o.uri){const t=n.options.manager.getHandler(o.uri);null!==t&&(s=t)}return this.detectSupport().then((function(i){if(i)return n.loadTextureImage(t,a.source,s);if(r.extensionsRequired&&r.extensionsRequired.indexOf(e)>=0)throw new Error("THREE.GLTFLoader: AVIF required by asset but unsupported.");return n.loadTexture(t)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(t){const e=new Image;e.src="data:image/avif;base64,AAAAIGZ0eXBhdmlmAAAAAGF2aWZtaWYxbWlhZk1BMUIAAADybWV0YQAAAAAAAAAoaGRscgAAAAAAAAAAcGljdAAAAAAAAAAAAAAAAGxpYmF2aWYAAAAADnBpdG0AAAAAAAEAAAAeaWxvYwAAAABEAAABAAEAAAABAAABGgAAABcAAAAoaWluZgAAAAAAAQAAABppbmZlAgAAAAABAABhdjAxQ29sb3IAAAAAamlwcnAAAABLaXBjbwAAABRpc3BlAAAAAAAAAAEAAAABAAAAEHBpeGkAAAAAAwgICAAAAAxhdjFDgQAMAAAAABNjb2xybmNseAACAAIABoAAAAAXaXBtYQAAAAAAAAABAAEEAQKDBAAAAB9tZGF0EgAKCBgABogQEDQgMgkQAAAAB8dSLfI=",e.onload=e.onerror=function(){t(1===e.height)}}))),this.isSupported}}class He{constructor(t){this.name=Ee.EXT_MESHOPT_COMPRESSION,this.parser=t}loadBufferView(t){const e=this.parser.json,n=e.bufferViews[t];if(n.extensions&&n.extensions[this.name]){const t=n.extensions[this.name],r=this.parser.getDependency("buffer",t.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported){if(e.extensionsRequired&&e.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return r.then((function(e){const n=t.byteOffset||0,r=t.byteLength||0,a=t.count,o=t.byteStride,s=new Uint8Array(e,n,r);return i.decodeGltfBufferAsync?i.decodeGltfBufferAsync(a,o,s,t.mode,t.filter).then((function(t){return t.buffer})):i.ready.then((function(){const e=new ArrayBuffer(a*o);return i.decodeGltfBuffer(new Uint8Array(e),a,o,s,t.mode,t.filter),e}))}))}return null}}class We{constructor(t){this.name=Ee.EXT_MESH_GPU_INSTANCING,this.parser=t}createNodeMesh(t){const e=this.parser.json,n=e.nodes[t];if(!n.extensions||!n.extensions[this.name]||void 0===n.mesh)return null;const r=e.meshes[n.mesh];for(const t of r.primitives)if(t.mode!==nn.TRIANGLES&&t.mode!==nn.TRIANGLE_STRIP&&t.mode!==nn.TRIANGLE_FAN&&void 0!==t.mode)return null;const i=n.extensions[this.name].attributes,a=[],o={};for(const t in i)a.push(this.parser.getDependency("accessor",i[t]).then((e=>(o[t]=e,o[t]))));return a.length<1?null:(a.push(this.parser.createNodeMesh(t)),Promise.all(a).then((t=>{const e=t.pop(),n=e.isGroup?e.children:[e],r=t[0].count,i=[];for(const t of n){const e=new y,n=new _,a=new x,s=new _(1,1,1),l=new w(t.geometry,t.material,r);for(let t=0;t<r;t++)o.TRANSLATION&&n.fromBufferAttribute(o.TRANSLATION,t),o.ROTATION&&a.fromBufferAttribute(o.ROTATION,t),o.SCALE&&s.fromBufferAttribute(o.SCALE,t),l.setMatrixAt(t,e.compose(n,a,s));for(const e in o)"TRANSLATION"!==e&&"ROTATION"!==e&&"SCALE"!==e&&t.geometry.setAttribute(e,o[e]);b.prototype.copy.call(l,t),this.parser.assignFinalMaterial(l),i.push(l)}return e.isGroup?(e.clear(),e.add(...i),e):i[0]})))}}const Xe="glTF",Ye=1313821514,Ke=5130562;class Qe{constructor(t){this.name=Ee.KHR_BINARY_GLTF,this.content=null,this.body=null;const e=new DataView(t,0,12),n=new TextDecoder;if(this.header={magic:n.decode(new Uint8Array(t.slice(0,4))),version:e.getUint32(4,!0),length:e.getUint32(8,!0)},this.header.magic!==Xe)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const r=this.header.length-12,i=new DataView(t,12);let a=0;for(;a<r;){const e=i.getUint32(a,!0);a+=4;const r=i.getUint32(a,!0);if(a+=4,r===Ye){const r=new Uint8Array(t,12+a,e);this.content=n.decode(r)}else if(r===Ke){const n=12+a;this.body=t.slice(n,n+e)}a+=e}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class qe{constructor(t,e){if(!e)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=Ee.KHR_DRACO_MESH_COMPRESSION,this.json=t,this.dracoLoader=e,this.dracoLoader.preload()}decodePrimitive(t,e){const n=this.json,r=this.dracoLoader,i=t.extensions[this.name].bufferView,a=t.extensions[this.name].attributes,o={},s={},l={};for(const t in a){const e=ln[t]||t.toLowerCase();o[e]=a[t]}for(const e in t.attributes){const r=ln[e]||e.toLowerCase();if(void 0!==a[e]){const i=n.accessors[t.attributes[e]],a=rn[i.componentType];l[r]=a.name,s[r]=!0===i.normalized}}return e.getDependency("bufferView",i).then((function(t){return new Promise((function(e){r.decodeDracoFile(t,(function(t){for(const e in t.attributes){const n=t.attributes[e],r=s[e];void 0!==r&&(n.normalized=r)}e(t)}),o,l)}))}))}}class Ze{constructor(){this.name=Ee.KHR_TEXTURE_TRANSFORM}extendTexture(t,e){return void 0!==e.texCoord&&e.texCoord!==t.channel||void 0!==e.offset||void 0!==e.rotation||void 0!==e.scale?(t=t.clone(),void 0!==e.texCoord&&(t.channel=e.texCoord),void 0!==e.offset&&t.offset.fromArray(e.offset),void 0!==e.rotation&&(t.rotation=e.rotation),void 0!==e.scale&&t.repeat.fromArray(e.scale),t.needsUpdate=!0,t):t}}class Je{constructor(){this.name=Ee.KHR_MESH_QUANTIZATION}}class $e extends ht{constructor(t,e,n,r){super(t,e,n,r)}copySampleValue_(t){const e=this.resultBuffer,n=this.sampleValues,r=this.valueSize,i=t*r*3+r;for(let t=0;t!==r;t++)e[t]=n[i+t];return e}interpolate_(t,e,n,r){const i=this.resultBuffer,a=this.sampleValues,o=this.valueSize,s=2*o,l=3*o,u=r-e,c=(n-e)/u,h=c*c,d=h*c,f=t*l,p=f-l,v=-2*d+3*h,m=d-h,g=1-v,y=m-h+c;for(let t=0;t!==o;t++){const e=a[p+t+o],n=a[p+t+s]*u,r=a[f+t+o],l=a[f+t]*u;i[t]=g*e+y*n+v*r+m*l}return i}}const tn=new x;class en extends $e{interpolate_(t,e,n,r){const i=super.interpolate_(t,e,n,r);return tn.fromArray(i).normalize().toArray(i),i}}const nn={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},rn={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},an={9728:Z,9729:k,9984:J,9985:$,9986:tt,9987:C},on={33071:et,33648:nt,10497:E},sn={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ln={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},un={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},cn={CUBICSPLINE:void 0,LINEAR:Q,STEP:rt},hn="OPAQUE",dn="MASK",fn="BLEND";function pn(t,e,n){for(const r in n.extensions)void 0===t[r]&&(e.userData.gltfExtensions=e.userData.gltfExtensions||{},e.userData.gltfExtensions[r]=n.extensions[r])}function vn(t,e){void 0!==e.extras&&("object"==typeof e.extras?Object.assign(t.userData,e.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+e.extras))}function mn(t,e){if(t.updateMorphTargets(),void 0!==e.weights)for(let n=0,r=e.weights.length;n<r;n++)t.morphTargetInfluences[n]=e.weights[n];if(e.extras&&Array.isArray(e.extras.targetNames)){const n=e.extras.targetNames;if(t.morphTargetInfluences.length===n.length){t.morphTargetDictionary={};for(let e=0,r=n.length;e<r;e++)t.morphTargetDictionary[n[e]]=e}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function gn(t){let e;const n=t.extensions&&t.extensions[Ee.KHR_DRACO_MESH_COMPRESSION];if(e=n?"draco:"+n.bufferView+":"+n.indices+":"+yn(n.attributes):t.indices+":"+yn(t.attributes)+":"+t.mode,void 0!==t.targets)for(let n=0,r=t.targets.length;n<r;n++)e+=":"+yn(t.targets[n]);return e}function yn(t){let e="";const n=Object.keys(t).sort();for(let r=0,i=n.length;r<i;r++)e+=n[r]+":"+t[n[r]]+";";return e}function _n(t){switch(t){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const xn=new y;class wn{constructor(t={},e={}){this.json=t,this.extensions={},this.plugins={},this.options=e,this.cache=new Ce,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let n=!1,r=!1,i=-1;"undefined"!=typeof navigator&&(n=!0===/^((?!chrome|android).)*safari/i.test(navigator.userAgent),r=navigator.userAgent.indexOf("Firefox")>-1,i=r?navigator.userAgent.match(/Firefox\/([0-9]+)\./)[1]:-1),"undefined"==typeof createImageBitmap||n||r&&i<98?this.textureLoader=new A(this.options.manager):this.textureLoader=new M(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new l(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(t){this.extensions=t}setPlugins(t){this.plugins=t}parse(t,e){const n=this,r=this.json,i=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(t){return t._markDefs&&t._markDefs()})),Promise.all(this._invokeAll((function(t){return t.beforeRoot&&t.beforeRoot()}))).then((function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])})).then((function(e){const a={scene:e[0][r.scene||0],scenes:e[0],animations:e[1],cameras:e[2],asset:r.asset,parser:n,userData:{}};return pn(i,a,r),vn(a,r),Promise.all(n._invokeAll((function(t){return t.afterRoot&&t.afterRoot(a)}))).then((function(){t(a)}))})).catch(e)}_markDefs(){const t=this.json.nodes||[],e=this.json.skins||[],n=this.json.meshes||[];for(let n=0,r=e.length;n<r;n++){const r=e[n].joints;for(let e=0,n=r.length;e<n;e++)t[r[e]].isBone=!0}for(let e=0,r=t.length;e<r;e++){const r=t[e];void 0!==r.mesh&&(this._addNodeRef(this.meshCache,r.mesh),void 0!==r.skin&&(n[r.mesh].isSkinnedMesh=!0)),void 0!==r.camera&&this._addNodeRef(this.cameraCache,r.camera)}}_addNodeRef(t,e){void 0!==e&&(void 0===t.refs[e]&&(t.refs[e]=t.uses[e]=0),t.refs[e]++)}_getNodeRef(t,e,n){if(t.refs[e]<=1)return n;const r=n.clone(),i=(t,e)=>{const n=this.associations.get(t);null!=n&&this.associations.set(e,n);for(const[n,r]of t.children.entries())i(r,e.children[n])};return i(n,r),r.name+="_instance_"+t.uses[e]++,r}_invokeOne(t){const e=Object.values(this.plugins);e.push(this);for(let n=0;n<e.length;n++){const r=t(e[n]);if(r)return r}return null}_invokeAll(t){const e=Object.values(this.plugins);e.unshift(this);const n=[];for(let r=0;r<e.length;r++){const i=t(e[r]);i&&n.push(i)}return n}getDependency(t,e){const n=t+":"+e;let r=this.cache.get(n);if(!r){switch(t){case"scene":r=this.loadScene(e);break;case"node":r=this._invokeOne((function(t){return t.loadNode&&t.loadNode(e)}));break;case"mesh":r=this._invokeOne((function(t){return t.loadMesh&&t.loadMesh(e)}));break;case"accessor":r=this.loadAccessor(e);break;case"bufferView":r=this._invokeOne((function(t){return t.loadBufferView&&t.loadBufferView(e)}));break;case"buffer":r=this.loadBuffer(e);break;case"material":r=this._invokeOne((function(t){return t.loadMaterial&&t.loadMaterial(e)}));break;case"texture":r=this._invokeOne((function(t){return t.loadTexture&&t.loadTexture(e)}));break;case"skin":r=this.loadSkin(e);break;case"animation":r=this._invokeOne((function(t){return t.loadAnimation&&t.loadAnimation(e)}));break;case"camera":r=this.loadCamera(e);break;default:if(r=this._invokeOne((function(n){return n!=this&&n.getDependency&&n.getDependency(t,e)})),!r)throw new Error("Unknown type: "+t)}this.cache.add(n,r)}return r}getDependencies(t){let e=this.cache.get(t);if(!e){const n=this,r=this.json[t+("mesh"===t?"es":"s")]||[];e=Promise.all(r.map((function(e,r){return n.getDependency(t,r)}))),this.cache.add(t,e)}return e}loadBuffer(t){const e=this.json.buffers[t],n=this.fileLoader;if(e.type&&"arraybuffer"!==e.type)throw new Error("THREE.GLTFLoader: "+e.type+" buffer type is not supported.");if(void 0===e.uri&&0===t)return Promise.resolve(this.extensions[Ee.KHR_BINARY_GLTF].body);const r=this.options;return new Promise((function(t,i){n.load(s.resolveURL(e.uri,r.path),t,void 0,(function(){i(new Error('THREE.GLTFLoader: Failed to load buffer "'+e.uri+'".'))}))}))}loadBufferView(t){const e=this.json.bufferViews[t];return this.getDependency("buffer",e.buffer).then((function(t){const n=e.byteLength||0,r=e.byteOffset||0;return t.slice(r,r+n)}))}loadAccessor(t){const e=this,r=this.json,i=this.json.accessors[t];if(void 0===i.bufferView&&void 0===i.sparse){const t=sn[i.type],e=rn[i.componentType],r=!0===i.normalized,a=new e(i.count*t);return Promise.resolve(new n(a,t,r))}const a=[];return void 0!==i.bufferView?a.push(this.getDependency("bufferView",i.bufferView)):a.push(null),void 0!==i.sparse&&(a.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),a.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(a).then((function(t){const a=t[0],o=sn[i.type],s=rn[i.componentType],l=s.BYTES_PER_ELEMENT,u=l*o,c=i.byteOffset||0,h=void 0!==i.bufferView?r.bufferViews[i.bufferView].byteStride:void 0,d=!0===i.normalized;let f,p;if(h&&h!==u){const t=Math.floor(c/h),n="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+t+":"+i.count;let r=e.cache.get(n);r||(f=new s(a,t*h,i.count*h/l),r=new T(f,h/l),e.cache.add(n,r)),p=new S(r,o,c%h/l,d)}else f=null===a?new s(i.count*o):new s(a,c,i.count*o),p=new n(f,o,d);if(void 0!==i.sparse){const e=sn.SCALAR,r=rn[i.sparse.indices.componentType],l=i.sparse.indices.byteOffset||0,u=i.sparse.values.byteOffset||0,c=new r(t[1],l,i.sparse.count*e),h=new s(t[2],u,i.sparse.count*o);null!==a&&(p=new n(p.array.slice(),p.itemSize,p.normalized));for(let t=0,e=c.length;t<e;t++){const e=c[t];if(p.setX(e,h[t*o]),o>=2&&p.setY(e,h[t*o+1]),o>=3&&p.setZ(e,h[t*o+2]),o>=4&&p.setW(e,h[t*o+3]),o>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return p}))}loadTexture(t){const e=this.json,n=this.options,r=e.textures[t].source,i=e.images[r];let a=this.textureLoader;if(i.uri){const t=n.manager.getHandler(i.uri);null!==t&&(a=t)}return this.loadTextureImage(t,r,a)}loadTextureImage(t,e,n){const r=this,i=this.json,a=i.textures[t],o=i.images[e],s=(o.uri||o.bufferView)+":"+a.sampler;if(this.textureCache[s])return this.textureCache[s];const l=this.loadImageSource(e,n).then((function(e){e.flipY=!1,e.name=a.name||o.name||"",""===e.name&&"string"==typeof o.uri&&!1===o.uri.startsWith("data:image/")&&(e.name=o.uri);const n=(i.samplers||{})[a.sampler]||{};return e.magFilter=an[n.magFilter]||k,e.minFilter=an[n.minFilter]||C,e.wrapS=on[n.wrapS]||E,e.wrapT=on[n.wrapT]||E,r.associations.set(e,{textures:t}),e})).catch((function(){return null}));return this.textureCache[s]=l,l}loadImageSource(t,e){const n=this,r=this.json,i=this.options;if(void 0!==this.sourceCache[t])return this.sourceCache[t].then((t=>t.clone()));const a=r.images[t],o=self.URL||self.webkitURL;let l=a.uri||"",u=!1;if(void 0!==a.bufferView)l=n.getDependency("bufferView",a.bufferView).then((function(t){u=!0;const e=new Blob([t],{type:a.mimeType});return l=o.createObjectURL(e),l}));else if(void 0===a.uri)throw new Error("THREE.GLTFLoader: Image "+t+" is missing URI and bufferView");const c=Promise.resolve(l).then((function(t){return new Promise((function(n,r){let a=n;!0===e.isImageBitmapLoader&&(a=function(t){const e=new at(t);e.needsUpdate=!0,n(e)}),e.load(s.resolveURL(t,i.path),a,void 0,r)}))})).then((function(t){var e;return!0===u&&o.revokeObjectURL(l),t.userData.mimeType=a.mimeType||((e=a.uri).search(/\.jpe?g($|\?)/i)>0||0===e.search(/^data\:image\/jpeg/)?"image/jpeg":e.search(/\.webp($|\?)/i)>0||0===e.search(/^data\:image\/webp/)?"image/webp":"image/png"),t})).catch((function(t){throw console.error("THREE.GLTFLoader: Couldn't load texture",l),t}));return this.sourceCache[t]=c,c}assignTexture(t,e,n,r){const i=this;return this.getDependency("texture",n.index).then((function(a){if(!a)return null;if(void 0!==n.texCoord&&n.texCoord>0&&((a=a.clone()).channel=n.texCoord),i.extensions[Ee.KHR_TEXTURE_TRANSFORM]){const t=void 0!==n.extensions?n.extensions[Ee.KHR_TEXTURE_TRANSFORM]:void 0;if(t){const e=i.associations.get(a);a=i.extensions[Ee.KHR_TEXTURE_TRANSFORM].extendTexture(a,t),i.associations.set(a,e)}}return void 0!==r&&(a.colorSpace=r),t[e]=a,a}))}assignFinalMaterial(t){const e=t.geometry;let n=t.material;const r=void 0===e.attributes.tangent,i=void 0!==e.attributes.color,a=void 0===e.attributes.normal;if(t.isPoints){const t="PointsMaterial:"+n.uuid;let e=this.cache.get(t);e||(e=new L,P.prototype.copy.call(e,n),e.color.copy(n.color),e.map=n.map,e.sizeAttenuation=!1,this.cache.add(t,e)),n=e}else if(t.isLine){const t="LineBasicMaterial:"+n.uuid;let e=this.cache.get(t);e||(e=new R,P.prototype.copy.call(e,n),e.color.copy(n.color),e.map=n.map,this.cache.add(t,e)),n=e}if(r||i||a){let t="ClonedMaterial:"+n.uuid+":";r&&(t+="derivative-tangents:"),i&&(t+="vertex-colors:"),a&&(t+="flat-shading:");let e=this.cache.get(t);e||(e=n.clone(),i&&(e.vertexColors=!0),a&&(e.flatShading=!0),r&&(e.normalScale&&(e.normalScale.y*=-1),e.clearcoatNormalScale&&(e.clearcoatNormalScale.y*=-1)),this.cache.add(t,e),this.associations.set(e,this.associations.get(n))),n=e}t.material=n}getMaterialType(){return I}loadMaterial(t){const e=this,n=this.json,r=this.extensions,i=n.materials[t];let a;const o={},s=[];if((i.extensions||{})[Ee.KHR_MATERIALS_UNLIT]){const t=r[Ee.KHR_MATERIALS_UNLIT];a=t.getMaterialType(),s.push(t.extendParams(o,i,e))}else{const n=i.pbrMetallicRoughness||{};if(o.color=new u(1,1,1),o.opacity=1,Array.isArray(n.baseColorFactor)){const t=n.baseColorFactor;o.color.setRGB(t[0],t[1],t[2],c),o.opacity=t[3]}void 0!==n.baseColorTexture&&s.push(e.assignTexture(o,"map",n.baseColorTexture,v)),o.metalness=void 0!==n.metallicFactor?n.metallicFactor:1,o.roughness=void 0!==n.roughnessFactor?n.roughnessFactor:1,void 0!==n.metallicRoughnessTexture&&(s.push(e.assignTexture(o,"metalnessMap",n.metallicRoughnessTexture)),s.push(e.assignTexture(o,"roughnessMap",n.metallicRoughnessTexture))),a=this._invokeOne((function(e){return e.getMaterialType&&e.getMaterialType(t)})),s.push(Promise.all(this._invokeAll((function(e){return e.extendMaterialParams&&e.extendMaterialParams(t,o)}))))}!0===i.doubleSided&&(o.side=O);const l=i.alphaMode||hn;if(l===fn?(o.transparent=!0,o.depthWrite=!1):(o.transparent=!1,l===dn&&(o.alphaTest=void 0!==i.alphaCutoff?i.alphaCutoff:.5)),void 0!==i.normalTexture&&a!==p&&(s.push(e.assignTexture(o,"normalMap",i.normalTexture)),o.normalScale=new g(1,1),void 0!==i.normalTexture.scale)){const t=i.normalTexture.scale;o.normalScale.set(t,t)}if(void 0!==i.occlusionTexture&&a!==p&&(s.push(e.assignTexture(o,"aoMap",i.occlusionTexture)),void 0!==i.occlusionTexture.strength&&(o.aoMapIntensity=i.occlusionTexture.strength)),void 0!==i.emissiveFactor&&a!==p){const t=i.emissiveFactor;o.emissive=(new u).setRGB(t[0],t[1],t[2],c)}return void 0!==i.emissiveTexture&&a!==p&&s.push(e.assignTexture(o,"emissiveMap",i.emissiveTexture,v)),Promise.all(s).then((function(){const n=new a(o);return i.name&&(n.name=i.name),vn(n,i),e.associations.set(n,{materials:t}),i.extensions&&pn(r,n,i),n}))}createUniqueName(t){const e=D.sanitizeNodeName(t||"");return e in this.nodeNamesUsed?e+"_"+ ++this.nodeNamesUsed[e]:(this.nodeNamesUsed[e]=0,e)}loadGeometries(t){const n=this,r=this.extensions,i=this.primitiveCache;function a(t){return r[Ee.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(t,n).then((function(e){return bn(e,t,n)}))}const o=[];for(let r=0,s=t.length;r<s;r++){const s=t[r],l=gn(s),u=i[l];if(u)o.push(u.promise);else{let t;t=s.extensions&&s.extensions[Ee.KHR_DRACO_MESH_COMPRESSION]?a(s):bn(new e,s,n),i[l]={primitive:s,promise:t},o.push(t)}}return Promise.all(o)}loadMesh(t){const e=this,n=this.json,r=this.extensions,o=n.meshes[t],s=o.primitives,l=[];for(let t=0,e=s.length;t<e;t++){const e=void 0===s[t].material?(void 0===(u=this.cache).DefaultMaterial&&(u.DefaultMaterial=new I({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:it})),u.DefaultMaterial):this.getDependency("material",s[t].material);l.push(e)}var u;return l.push(e.loadGeometries(s)),Promise.all(l).then((function(n){const l=n.slice(0,n.length-1),u=n[n.length-1],c=[];for(let n=0,h=u.length;n<h;n++){const h=u[n],d=s[n];let f;const p=l[n];if(d.mode===nn.TRIANGLES||d.mode===nn.TRIANGLE_STRIP||d.mode===nn.TRIANGLE_FAN||void 0===d.mode)f=!0===o.isSkinnedMesh?new N(h,p):new U(h,p),!0===f.isSkinnedMesh&&f.normalizeSkinWeights(),d.mode===nn.TRIANGLE_STRIP?f.geometry=ve(f.geometry,a):d.mode===nn.TRIANGLE_FAN&&(f.geometry=ve(f.geometry,i));else if(d.mode===nn.LINES)f=new F(h,p);else if(d.mode===nn.LINE_STRIP)f=new B(h,p);else if(d.mode===nn.LINE_LOOP)f=new z(h,p);else{if(d.mode!==nn.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+d.mode);f=new G(h,p)}Object.keys(f.geometry.morphAttributes).length>0&&mn(f,o),f.name=e.createUniqueName(o.name||"mesh_"+t),vn(f,o),d.extensions&&pn(r,f,d),e.assignFinalMaterial(f),c.push(f)}for(let n=0,r=c.length;n<r;n++)e.associations.set(c[n],{meshes:t,primitives:n});if(1===c.length)return o.extensions&&pn(r,c[0],o),c[0];const h=new V;o.extensions&&pn(r,h,o),e.associations.set(h,{meshes:t});for(let t=0,e=c.length;t<e;t++)h.add(c[t]);return h}))}loadCamera(t){let e;const n=this.json.cameras[t],r=n[n.type];if(r)return"perspective"===n.type?e=new j(H.radToDeg(r.yfov),r.aspectRatio||1,r.znear||1,r.zfar||2e6):"orthographic"===n.type&&(e=new W(-r.xmag,r.xmag,r.ymag,-r.ymag,r.znear,r.zfar)),n.name&&(e.name=this.createUniqueName(n.name)),vn(e,n),Promise.resolve(e);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(t){const e=this.json.skins[t],n=[];for(let t=0,r=e.joints.length;t<r;t++)n.push(this._loadNodeShallow(e.joints[t]));return void 0!==e.inverseBindMatrices?n.push(this.getDependency("accessor",e.inverseBindMatrices)):n.push(null),Promise.all(n).then((function(t){const n=t.pop(),r=t,i=[],a=[];for(let t=0,o=r.length;t<o;t++){const o=r[t];if(o){i.push(o);const e=new y;null!==n&&e.fromArray(n.array,16*t),a.push(e)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',e.joints[t])}return new X(i,a)}))}loadAnimation(t){const e=this.json,n=this,r=e.animations[t],i=r.name?r.name:"animation_"+t,a=[],o=[],s=[],l=[],u=[];for(let t=0,e=r.channels.length;t<e;t++){const e=r.channels[t],n=r.samplers[e.sampler],i=e.target,c=i.node,h=void 0!==r.parameters?r.parameters[n.input]:n.input,d=void 0!==r.parameters?r.parameters[n.output]:n.output;void 0!==i.node&&(a.push(this.getDependency("node",c)),o.push(this.getDependency("accessor",h)),s.push(this.getDependency("accessor",d)),l.push(n),u.push(i))}return Promise.all([Promise.all(a),Promise.all(o),Promise.all(s),Promise.all(l),Promise.all(u)]).then((function(t){const e=t[0],r=t[1],a=t[2],o=t[3],s=t[4],l=[];for(let t=0,i=e.length;t<i;t++){const i=e[t],u=r[t],c=a[t],h=o[t],d=s[t];if(void 0===i)continue;i.updateMatrix&&i.updateMatrix();const f=n._createAnimationTracks(i,u,c,h,d);if(f)for(let t=0;t<f.length;t++)l.push(f[t])}return new Y(i,void 0,l)}))}createNodeMesh(t){const e=this.json,n=this,r=e.nodes[t];return void 0===r.mesh?null:n.getDependency("mesh",r.mesh).then((function(t){const e=n._getNodeRef(n.meshCache,r.mesh,t);return void 0!==r.weights&&e.traverse((function(t){if(t.isMesh)for(let e=0,n=r.weights.length;e<n;e++)t.morphTargetInfluences[e]=r.weights[e]})),e}))}loadNode(t){const e=this,n=this.json.nodes[t],r=e._loadNodeShallow(t),i=[],a=n.children||[];for(let t=0,n=a.length;t<n;t++)i.push(e.getDependency("node",a[t]));const o=void 0===n.skin?Promise.resolve(null):e.getDependency("skin",n.skin);return Promise.all([r,Promise.all(i),o]).then((function(t){const e=t[0],n=t[1],r=t[2];null!==r&&e.traverse((function(t){t.isSkinnedMesh&&t.bind(r,xn)}));for(let t=0,r=n.length;t<r;t++)e.add(n[t]);return e}))}_loadNodeShallow(t){const e=this.json,n=this.extensions,r=this;if(void 0!==this.nodeCache[t])return this.nodeCache[t];const i=e.nodes[t],a=i.name?r.createUniqueName(i.name):"",o=[],s=r._invokeOne((function(e){return e.createNodeMesh&&e.createNodeMesh(t)}));return s&&o.push(s),void 0!==i.camera&&o.push(r.getDependency("camera",i.camera).then((function(t){return r._getNodeRef(r.cameraCache,i.camera,t)}))),r._invokeAll((function(e){return e.createNodeAttachment&&e.createNodeAttachment(t)})).forEach((function(t){o.push(t)})),this.nodeCache[t]=Promise.all(o).then((function(e){let o;if(o=!0===i.isBone?new K:e.length>1?new V:1===e.length?e[0]:new b,o!==e[0])for(let t=0,n=e.length;t<n;t++)o.add(e[t]);if(i.name&&(o.userData.name=i.name,o.name=a),vn(o,i),i.extensions&&pn(n,o,i),void 0!==i.matrix){const t=new y;t.fromArray(i.matrix),o.applyMatrix4(t)}else void 0!==i.translation&&o.position.fromArray(i.translation),void 0!==i.rotation&&o.quaternion.fromArray(i.rotation),void 0!==i.scale&&o.scale.fromArray(i.scale);return r.associations.has(o)||r.associations.set(o,{}),r.associations.get(o).nodes=t,o})),this.nodeCache[t]}loadScene(t){const e=this.extensions,n=this.json.scenes[t],r=this,i=new V;n.name&&(i.name=r.createUniqueName(n.name)),vn(i,n),n.extensions&&pn(e,i,n);const a=n.nodes||[],o=[];for(let t=0,e=a.length;t<e;t++)o.push(r.getDependency("node",a[t]));return Promise.all(o).then((function(t){for(let e=0,n=t.length;e<n;e++)i.add(t[e]);return r.associations=(t=>{const e=new Map;for(const[t,n]of r.associations)(t instanceof P||t instanceof at)&&e.set(t,n);return t.traverse((t=>{const n=r.associations.get(t);null!=n&&e.set(t,n)})),e})(i),i}))}_createAnimationTracks(t,e,n,r,i){const a=[],o=t.name?t.name:t.uuid,s=[];let l;switch(un[i.path]===un.weights?t.traverse((function(t){t.morphTargetInfluences&&s.push(t.name?t.name:t.uuid)})):s.push(o),un[i.path]){case un.weights:l=st;break;case un.rotation:l=lt;break;case un.position:case un.scale:l=ot;break;default:if(1===n.itemSize)l=st;else l=ot}const u=void 0!==r.interpolation?cn[r.interpolation]:Q,c=this._getArrayFromAccessor(n);for(let t=0,n=s.length;t<n;t++){const n=new l(s[t]+"."+un[i.path],e.array,c,u);"CUBICSPLINE"===r.interpolation&&this._createCubicSplineTrackInterpolant(n),a.push(n)}return a}_getArrayFromAccessor(t){let e=t.array;if(t.normalized){const t=_n(e.constructor),n=new Float32Array(e.length);for(let r=0,i=e.length;r<i;r++)n[r]=e[r]*t;e=n}return e}_createCubicSplineTrackInterpolant(t){t.createInterpolant=function(t){return new(this instanceof lt?en:$e)(this.times,this.values,this.getValueSize()/3,t)},t.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function bn(t,e,n){const r=e.attributes,i=[];function a(e,r){return n.getDependency("accessor",e).then((function(e){t.setAttribute(r,e)}))}for(const e in r){const n=ln[e]||e.toLowerCase();n in t.attributes||i.push(a(r[e],n))}if(void 0!==e.indices&&!t.index){const r=n.getDependency("accessor",e.indices).then((function(e){t.setIndex(e)}));i.push(r)}return q.workingColorSpace!==c&&"COLOR_0"in r&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${q.workingColorSpace}" not supported.`),vn(t,e),function(t,e,n){const r=e.attributes,i=new ut;if(void 0===r.POSITION)return;{const t=n.json.accessors[r.POSITION],e=t.min,a=t.max;if(void 0===e||void 0===a)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(i.set(new _(e[0],e[1],e[2]),new _(a[0],a[1],a[2])),t.normalized){const e=_n(rn[t.componentType]);i.min.multiplyScalar(e),i.max.multiplyScalar(e)}}const a=e.targets;if(void 0!==a){const t=new _,e=new _;for(let r=0,i=a.length;r<i;r++){const i=a[r];if(void 0!==i.POSITION){const r=n.json.accessors[i.POSITION],a=r.min,o=r.max;if(void 0!==a&&void 0!==o){if(e.setX(Math.max(Math.abs(a[0]),Math.abs(o[0]))),e.setY(Math.max(Math.abs(a[1]),Math.abs(o[1]))),e.setZ(Math.max(Math.abs(a[2]),Math.abs(o[2]))),r.normalized){const t=_n(rn[r.componentType]);e.multiplyScalar(t)}t.max(e)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}i.expandByVector(t)}t.boundingBox=i;const o=new ct;i.getCenter(o.center),o.radius=i.min.distanceTo(i.max)/2,t.boundingSphere=o}(t,e,n),Promise.all(i).then((function(){return void 0!==e.targets?function(t,e,n){let r=!1,i=!1,a=!1;for(let t=0,n=e.length;t<n;t++){const n=e[t];if(void 0!==n.POSITION&&(r=!0),void 0!==n.NORMAL&&(i=!0),void 0!==n.COLOR_0&&(a=!0),r&&i&&a)break}if(!r&&!i&&!a)return Promise.resolve(t);const o=[],s=[],l=[];for(let u=0,c=e.length;u<c;u++){const c=e[u];if(r){const e=void 0!==c.POSITION?n.getDependency("accessor",c.POSITION):t.attributes.position;o.push(e)}if(i){const e=void 0!==c.NORMAL?n.getDependency("accessor",c.NORMAL):t.attributes.normal;s.push(e)}if(a){const e=void 0!==c.COLOR_0?n.getDependency("accessor",c.COLOR_0):t.attributes.color;l.push(e)}}return Promise.all([Promise.all(o),Promise.all(s),Promise.all(l)]).then((function(e){const n=e[0],o=e[1],s=e[2];return r&&(t.morphAttributes.position=n),i&&(t.morphAttributes.normal=o),a&&(t.morphAttributes.color=s),t.morphTargetsRelative=!0,t}))}(t,e.targets,n):t}))}var An=function(){function e(t){var n;Gt(this,e);var r=qt({zooms:[4,22],interact:!0,models:[],impactName:"灯杆",animate:!0},t);return Ht(n=zt(this,e,[r]),"_lastPick",null),Ht(n,"_data",[]),Ht(n,"_group",null),Ht(n,"_models",[]),Ht(n,"_impactName",""),Ht(n,"_mixers",[]),n._impactName=r.impactName,r.models.length<=0?(console.error("缺少模型配置"),Zt(n)):(n._models=ee(r.models),n.loader=null,r.data&&(n.data=r.data),n)}return Yt(e,ue),jt(e,[{key:"data",get:function(){return this._data},set:function(t){var e=t.features,n=[];e?(this._data=e.map((function(t){var e=t.properties,n=t.geometry;return qt(qt({},e),{},{lngLat:n.coordinates})})),n=this.customCoords.lngLatsToCoords(e.map((function(t){return t.geometry.coordinates})))):t instanceof Array&&(this._data=t,n=this.customCoords.lngLatsToCoords(t.map((function(t){return t.lngLat})))),this._data.forEach((function(t,e){t.coords=n[e]})),this.updateModel()}},{key:"init",value:function(){}},{key:"onReady",value:function(){this.updateModel(),this.initMouseEvent()}},{key:"onPicked",value:function(t){var e,n,r=t.targets,i=t.event,a=null;if(r.length>0){var o=this.getParentObject(r[0],{name:this._impactName});o?(this.setLastPick(o),a=o._attrs):this.removeLastPick()}else this.removeLastPick();this.handleEvent("pick",{screenX:null==i||null===(e=i.pixel)||void 0===e?void 0:e.x,screenY:null==i||null===(n=i.pixel)||void 0===n?void 0:n.y,attrs:a})}},{key:"loadOneModel",value:function(t,e){var n=this,r=this._models,i=t.modelId,a=t.size,o=t.sourceUrl;return new Promise((function(t){void 0!==(r.find((function(t){return t.modelId===i}))||{}).model?t():n.loader.load(o,(function(n){var i=n.scene.children[0];i.scale.set(a,a,a),i.rotateX(Math.PI/2),r[e].model=i,r[e].animations=n.animations,t()}),(function(t){console.log(t.loaded/t.total*100+"% loaded")}),(function(t){console.log("An error happened"+t)}))}))}},{key:"loadModel",value:(r=Bt(Jt().mark((function e(){var n,r;return Jt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:null===this.loader&&(this.loader=new ke),null===this._group&&(this._group=new t.Group,this.scene.add(this._group)),n=this._models,r=0;case 4:if(!(r<n.length)){e.next=10;break}return e.next=7,this.loadOneModel(n[r],r);case 7:r++,e.next=4;break;case 10:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"clearModel",value:function(){if(this._group){var t=this._group.children;do{this._group.remove(t[0])}while(t.length>0);this._mixers.length&&(this._mixers.forEach((function(t){t.stopAllAction(),t.uncacheRoot()})),this._mixers=[])}}},{key:"getModelConfById",value:function(t){return this._models.find((function(e){return e.modelId===t}))}},{key:"initMouseEvent",value:function(){var t=this;this.container.addEventListener("click",(function(e){var n=t._lastPick;n&&t.handleEvent("click",{screenX:null==e?void 0:e.clientX,screenY:null==e?void 0:e.clientY,attrs:n._attrs})}))}},{key:"updateModel",value:(n=Bt(Jt().mark((function e(){var n,r,i,a,o=this;return Jt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this.scene){e.next=2;break}return e.abrupt("return");case 2:return e.next=4,this.loadModel();case 4:n=this._group,r=this._data,i=this._isAnimate,a=this._mixers,this.clearModel(),r.forEach((function(e,r){var s=e.id,l=e.modelId,u=e.altitude,c=e.angle,h=e.coords,d=e.lngLat,f=o.getModelConfById(l),p=f.model,v=f.animations,m=f.upAxis,g=p.clone();if(g._attrs={id:s,altitude:u,angle:c,coords:h,modelId:l,lngLat:d},g.position.set(h[0],h[1],void 0===u?0:u),void 0!==c&&g["x"===m?"rotateX":"z"===m?"rotateZ":"rotateY"](-c/180*Math.PI),i&&v.length){var y=new t.AnimationMixer(g),_=y.clipAction(v[0]);_.loop=t.LoopRepeat,_.play(),a.push(y)}n.add(g)}));case 7:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"getModelById",value:function(t){return this._group.children.find((function(e){return e._attrs.id===t}))||null}},{key:"getParentObject",value:function(t,e){var n=t.object,r=e.name;do{var i;if(n.name===r||"Scene"===(null===(i=n.parent)||void 0===i||null===(i=i.parent)||void 0===i?void 0:i.type))return n;n=n.parent}while(n)}},{key:"setLastPick",value:function(e){var n=this._lastPick,r=this.scene;if(e&&(!n||JSON.stringify(null==n?void 0:n._attrs)!==JSON.stringify(null==e?void 0:e._attrs))){this.removeLastPick();var i=new t.BoxHelper(e,"#00ff00");r.add(i),i._attrs=null==e?void 0:e._attrs,this._lastPick=i}}},{key:"removeLastPick",value:function(){var t=this._lastPick,e=this.scene;t&&(e.remove(t),this._lastPick=null)}},{key:"update",value:function(){this._isAnimate&&this._mixers.forEach((function(t){t.update(.02)}))}}]);var n,r}(),Mn=function(){function e(t){var n;Gt(this,e);var r=qt({zooms:[4,22],interact:!0,models:[],animate:!0},t);return Ht(n=zt(this,e,[r]),"_lastPickIndex",{index:null,modelId:null}),Ht(n,"_data",{}),Ht(n,"_group",null),Ht(n,"_models",[]),r.models.length<=0?(console.error("缺少模型配置"),Zt(n)):(n._models=ee(r.models),n.loader=null,r.data&&(n.data=r.data),n)}return Yt(e,ue),jt(e,[{key:"data",get:function(){return this._data},set:function(t){var e=this,n=t.features,r=[];n?this._data=n.map((function(t){var e=t.properties,n=t.geometry;return qt(qt({},e),{},{lngLat:n.coordinates})})):t instanceof Array&&t.forEach((function(t){var n=t.modelId;void 0===r[n]&&(r[n]=[]);var i=e.customCoords.lngLatsToCoords([t.lngLat]);r[n].push(qt({coords:i[0]},t))})),this._data=r,this.updateModel()}},{key:"init",value:function(){}},{key:"onReady",value:function(){this.updateModel(),this.initMouseEvent()}},{key:"onPicked",value:function(t){var e,n,r=t.targets,i=t.event,a=null;if(r.length>0){var o=r[0].object;if(null!=o&&o.isInstancedMesh){var s=o.attrs.modelId,l=this._raycaster.intersectObject(o,!1)[0].instanceId;this.setLastPick({index:l,modelId:s}),a=this._data[s][l]}}else this.removeLastPick();this.handleEvent("pick",{screenX:null==i||null===(e=i.pixel)||void 0===e?void 0:e.x,screenY:null==i||null===(n=i.pixel)||void 0===n?void 0:n.y,attrs:a})}},{key:"loadOneModel",value:function(t,e){var n=this,r=this._models,i=t.modelId,a=t.sourceUrl;return new Promise((function(t){void 0!==(r.find((function(t){return t.modelId===i}))||{}).model?t():n.loader.load(a,(function(n){var i=n.scene.children[0];r[e].model=i,t()}),(function(t){console.log(t.loaded/t.total*100+"% loaded")}),(function(t){console.log("loader model fail"+t)}))}))}},{key:"loadModel",value:(r=Bt(Jt().mark((function e(){var n;return Jt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:null===this.loader&&(this.loader=new ke),null===this._group&&(this._group=new t.Group,this.scene.add(this._group)),n=0;case 3:if(!(n<this._models.length)){e.next=9;break}return e.next=6,this.loadOneModel(this._models[n],n);case 6:n++,e.next=3;break;case 9:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"clearModel",value:function(){if(this._group){var t=this._group.children;do{this._group.remove(t[0])}while(t.length>0)}}},{key:"getModelConfById",value:function(t){return this._models.find((function(e){return e.modelId===t}))}},{key:"initMouseEvent",value:function(){}},{key:"updateModel",value:(n=Bt(Jt().mark((function t(){var e,n,r,i,a,o;return Jt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.scene){t.next=2;break}return t.abrupt("return");case 2:return t.next=4,this.loadModel();case 4:for(e=this._group,n=this._data,this.clearModel(),r=Object.keys(n),i=0;i<r.length;i++)a=r[i],o=this.createInstancedMesh(this.getModelConfById(a),n[a]),e.add(o);case 8:case"end":return t.stop()}}),t,this)}))),function(){return n.apply(this,arguments)})},{key:"createInstancedMesh",value:function(e,n){var r=e.model,i=e.size,a=e.name,o=e.modelId,s=n.length,l=r.geometry,u=r.material,c=new t.InstancedMesh(l,u,s);c.attrs={name:a,modelId:o};var h=new t.Object3D;h.scale.set(i,i,i),h.rotateX(Math.PI/2);for(var d=new t.Color,f=0;f<s;f++){var p=n[f];p.id,p.modelId;var v=p.altitude,m=p.angle,g=p.coords;h.position.set(g[0],g[1],void 0===v?0:v),h.updateMatrix(),void 0!==m&&h.rotateY(-m/180*Math.PI),c.setMatrixAt(f,h.matrix),c.setColorAt(f,d)}return c}},{key:"getModelById",value:function(t){return this._group.children.find((function(e){return e._attrs.id===t}))||null}},{key:"setLastPick",value:function(e){var n=e.index,r=e.modelId;if(this._lastPickIndex.index!==n||this._lastPickIndex.modelId!==r){var i=this.getMeshByModelId(r);i&&(null!==this._lastPickIndex.index&&(i.setColorAt(this._lastPickIndex.index,new t.Color),i.instanceColor.needsUpdate=!0),i.setColorAt(n,new t.Color(65535)),i.instanceColor.needsUpdate=!0,this._lastPickIndex={index:n,modelId:r})}}},{key:"getMeshByModelId",value:function(t){var e;return null===(e=this._group)||void 0===e?void 0:e.children.find((function(e){return e.attrs.modelId===t}))}},{key:"removeLastPick",value:function(){var e=this._lastPickIndex,n=e.index,r=e.modelId;if(null!==n&&null!==r){var i=this.getMeshByModelId(r);if(i){var a=new t.Color;i.setColorAt(n,a),i.instanceColor.needsUpdate=!0,this._lastPickIndex={index:null,modelId:null}}}}},{key:"update",value:function(){}}]);var n,r}(),Tn=function(){function e(t){var n;Gt(this,e);var r=qt({data:null,speed:1,animate:!0,lineWidth:20,altitude:0,sizeAttenuation:!0,uvMapURL:"./static/texture/road_bg1.png"},t);return Ht(n=zt(this,e,[r]),"_data",[]),Ht(n,"_material",null),Ht(n,"_meshes",[]),n.initData(r.data),n}return Yt(e,ue),jt(e,[{key:"onReady",value:function(){this.initLines()}},{key:"initData",value:function(t){var e=ee(null==t?void 0:t.features)||[],n=[];e.forEach((function(t){var e=t.geometry,r=e.type,i=e.coordinates;"MultiLineString"===r&&i.forEach((function(t){n.push(t)})),"LineString"===r&&n.push(i)}));var r=this.customCoords.lngLatsToCoords(n);this._data=r}},{key:"setData",value:function(t){this.reset(),this.initData(t),this.initLines()}},{key:"reset",value:function(){this._meshes.forEach((function(t){t.geometry.dispose(),t.material.dispose(),t.removeFromParent()})),this._material&&(this._material.dispose(),this._material=null),this._data=[]}},{key:"initLines",value:function(){var e=this,n=this.scene,r=(new t.TextureLoader).load(this.mergeSourceURL(this._conf.uvMapURL));r.wrapS=t.RepeatWrapping,r.wrapT=t.RepeatWrapping;var i=new Te({lineWidth:this._conf.lineWidth,sizeAttenuation:this._conf.sizeAttenuation?1:0,useMap:1,opacity:1,map:r,transparent:!0,depthTest:!0,repeat:new t.Vector2(2,1)});this._material=i,this._data.forEach((function(r){var a=[];r.forEach((function(n){var r=te(n,2),i=r[0],o=r[1];a.push(new t.Vector3(i,o,e._conf.altitude))}));var o=new Me;o.setPoints(a);var s=new t.Mesh(o,i);n.add(s),e._meshes.push(s)}))}},{key:"update",value:function(){var t;this._isAnimate&&null!==(t=this._material)&&void 0!==t&&null!==(t=t.uniforms)&&void 0!==t&&t.offset&&(this._material.uniforms.offset.value.x-=.01*this._conf.speed)}}])}(),Sn=function(){function e(t){var n;Gt(this,e);var r=qt({zooms:[10,22],data:null,icon:{src:"./static/texture/pole.svg",alphaMapURL:"./static/texture/pole.svg",color:"rgba(0,255,255,0.8)",size:[64,128]}},t);return Ht(n=zt(this,e,[r]),"_data",[]),Ht(n,"_features",[]),Ht(n,"_currIcon",null),n.initData(r.data),n}return Yt(e,ue),jt(e,[{key:"onReady",value:function(){this.initMaterial(),this.createMesh()}},{key:"onPicked",value:function(t){var e=t.targets,n=te(this._conf.icon.size,2),r=n[0],i=n[1];e.length>0?(e[0].object.scale.set(1.5*r,1.5*i,0),this._currIcon&&this._currIcon.object.scale.set(r,i,0),this._currIcon=e[0]):(this._currIcon&&this._currIcon.object.scale.set(r,i,0),this._currIcon=null)}},{key:"initData",value:function(t){var e=t.features,n=e.map((function(t){var e=te(t.geometry.coordinates,2);return[e[0],e[1]]}));this._features=e,this._data=this.customCoords.lngLatsToCoords(n)}},{key:"initMaterial",value:function(){var e=this._conf.icon,n=(new t.TextureLoader).load(e.src),r=new t.SpriteMaterial({map:n,transparent:!0,depthTest:!0});return e.alphaMapURL?r.alphaMap=(new t.TextureLoader).load(e.alphaMapURL):r.alphaMap=n,e.color&&(r.color=new t.Color(e.color)),r.blending=t.CustomBlending,r.blendDst=t.OneFactor,this._material=r,r}},{key:"createMesh",value:function(){for(var e=this.scene,n=te(this._conf.icon.size,2),r=n[0],i=n[1],a=0;a<this._data.length;a++){var o=te(this._data[a],2),s=o[0],l=o[1],u=new t.Sprite(this._material);u._attrs=this._features[a],u.scale.set(r,i,0),u.position.set(s,l,i/2),e.add(u)}}}])}(),kn="\n    attribute vec3 color;       // 每个顶点的颜色\n    attribute float angle;      // 每个顶点的旋转角度\n\n    varying vec2 vUv;           // 传递给片元着色器的UV坐标\n    varying vec3 vColor;        // 传递给片元着色器的颜色\n    varying float vAngle;       // 传递给片元着色器的旋转角度\n\n    void main() {\n      vUv = uv;                // 将几何体的 UV 坐标传递给片元着色器\n      vColor = color;          // 将颜色传递给片元着色器\n      vAngle = angle;          // 将旋转角度传递给片元着色器\n      \n      // 标准转换过程，将位置转换到投影空间\n      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n    }\n  ",Cn="\n    uniform sampler2D texture;  // 纹理贴图\n\n    varying vec2 vUv;           // 从顶点着色器传入的UV坐标\n    varying vec3 vColor;        // 从顶点着色器传入的颜色\n    varying float vAngle;       // 从顶点着色器传入的旋转角度\n\n    const float PI = 3.14159265358979323846;\n\n    void main() {\n      // 将角度转换为弧度\n      float angleInRadians = vAngle * PI/ 180.0;\n      float cosAngle = cos(angleInRadians);\n      float sinAngle = sin(angleInRadians);\n      \n      mat2 rotationMatrix = mat2(cosAngle, -sinAngle, sinAngle, cosAngle);\n\n      // 应用旋转矩阵到UV坐标 保持旋转中心为(0.5, 0.5)\n      vec2 rotatedUv = rotationMatrix * (vUv - 0.5) + 0.5;\n\n      // 使用旋转后的UV坐标采样纹理\n      vec4 texColor = texture2D(texture, rotatedUv);\n      \n      // 将纹理颜色和顶点颜色相乘，实现颜色叠加\n      gl_FragColor = vec4(texColor.rgb * vColor , texColor.a);\n    }\n  ",En=function(){function e(t){var n;Gt(this,e);var r=qt({data:null,size:20,textureURL:null,altitude:0,sizeAttenuation:!0},t);if(Ht(n=zt(this,e,[r]),"_data",[]),Ht(n,"_meshs",[]),Ht(n,"_frameX",1),Ht(n,"_texture",null),Ht(n,"_offset",0),!r.data)throw new Error("PointIconLayer 图层数据为必须");if(!r.textureURL)throw new Error("PointIconLayer 图片地址为必须");return n.bindMethods(["handelViewChange"]),n.initData(r.data),n}return Yt(e,ue),jt(e,[{key:"onReady",value:(i=Bt(Jt().mark((function t(){return Jt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.initPoints();case 2:0==this._conf.sizeAttenuation&&this.map.on("viewchange",this.handelViewChange);case 3:case"end":return t.stop()}}),t,this)}))),function(){return i.apply(this,arguments)})},{key:"handelViewChange",value:function(t){this.refreshTransformData()}},{key:"beforeDestroy",value:function(){var t=this;this.map&&this.map.off("viewchange",this.handelViewChange),this._meshs.forEach((function(e){return t.scene.remove(e)})),this._meshs=[]}},{key:"refreshTransformData",value:function(){var t=this.map.getResolution()/.8;this._meshs.forEach((function(e,n){e.scale.set(t,t,t)}))}},{key:"initData",value:function(t){var e=this,n=t.features;this._data=n.map((function(t){var n=t.geometry,r=t.properties;n.type;var i=n.coordinates;return{lngLat:i,coord:e.customCoords.lngLatsToCoords(i)[0],properties:r}}))}},{key:"initPoints",value:(r=Bt(Jt().mark((function e(){var n,r,i,a=this;return Jt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.scene,r=this._meshs,e.next=3,this.generateMaterial();case 3:i=e.sent,this._data.forEach((function(e,o){var s=e.coord,l=e.properties,u=te(s,2),c=u[0],h=u[1],d=a.generateGeometry(c,h,l),f=new t.Mesh(d,i);f._attrs={index:o},f.position.set(c,h,a._conf.altitude),n.add(f),r.push(f)})),this.refreshTransformData();case 6:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"generateMaterial",value:(n=Bt(Jt().mark((function e(){var n,r,i,a,o;return Jt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new t.TextureLoader,e.next=3,n.loadAsync(this.mergeSourceURL(this._conf.textureURL));case 3:return(r=e.sent).repeat.set(1,1),i=kn,a=Cn,o=new t.ShaderMaterial({uniforms:{texture:{value:r}},vertexShader:i,fragmentShader:a,transparent:!0,depthTest:!0,depthWrite:!1}),e.abrupt("return",o);case 8:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"generateGeometry",value:function(e,n,r){var i=this,a=this._conf,o=a.size,s=a.altitude,l=o/2,u=[new t.Vector3(e-l,n-l,s),new t.Vector3(e+l,n-l,s),new t.Vector3(e-l,n+l,s),new t.Vector3(e-l,n+l,s),new t.Vector3(e+l,n-l,s),new t.Vector3(e+l,n+l,s)],c=(new t.BufferGeometry).setFromPoints(u);c.setAttribute("uv",new t.BufferAttribute(new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),2));var h=Array.from({length:6},(function(){return i.hexToRGBNormalized(r.color)})).flat();c.setAttribute("color",new t.Float32BufferAttribute(h,3));var d=new Array(6).fill(-1*r.angle);return c.setAttribute("angle",new t.Float32BufferAttribute(d,1)),c.center(),c}},{key:"hexToRGBNormalized",value:function(t){t=t.replace("#","");var e=parseInt(t.substring(0,2),16),n=parseInt(t.substring(2,4),16),r=parseInt(t.substring(4,6),16);return[e/=255,n/=255,r/=255]}},{key:"onPicked",value:function(t){var e,n,r=t.targets,i=t.event,a=null;if(r.length>0){var o=this.getParentObject(r[0]);if(o){var s=o._attrs.index;a=this._data[s]}}this.handleEvent("pick",{screenX:null==i||null===(e=i.pixel)||void 0===e?void 0:e.x,screenY:null==i||null===(n=i.pixel)||void 0===n?void 0:n.y,attrs:a})}},{key:"setData",value:function(t){var e=this;this._meshs.forEach((function(t){return e.scene.remove(t)})),this._meshs=[],Array.isArray(t)&&(t={type:"FeatureCollection",features:t}),this.initData(t),this.initPoints()}},{key:"getParentObject",value:function(t){var e=t.object;do{var n;if(["Scene","Group"].includes(null===(n=e.parent)||void 0===n?void 0:n.type))return e;e=e.parent}while(e)}},{key:"update",value:function(){}}]);var n,r,i}(),Ln="\n    //初始透明度\n    // attribute float opacity;\n    //点尺寸\n    uniform float size;\n    \n    void main()\n    {  \n      // float m = mod( opacity + time , 2.0);\n      // uvOpacity = m >= 1.5 ? (2.0-m) : m ;    \n      gl_PointSize = size;\n      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n    }\n  ",Pn="\n    #define MOD3 vec3(.1031,.11369,.13787)\n    \n    uniform vec3 color;\n    uniform float time;\n    // varying float uvOpacity;   \n    \n    float hash12(vec2 p) \n    {\n      vec3 p3  = fract(vec3(p.xyx) * MOD3);\n      p3 += dot(p3, p3.yzx + 19.19);\n      return fract((p3.x + p3.y) * p3.z);\n    }\n   \n    float stars(vec2 uv, float t)\n    {     \n      //调整闪烁频率\n      t*= 1.0;     \n      // 调整噪点透明度\n      // float n1 = hash12(uv*10000.);\n      // float n2 = hash12(uv*11234.);\n      // float alpha1 = pow(n1, 20.);\n      // float alpha2 = pow(n2, 20.);\n\n      //随机性闪烁\n      float twinkle = sin((uv.x-t+cos(uv.y*20.+t))*10.);\n      twinkle *= cos((uv.y*.234-t*3.24+sin(uv.x*12.3+t*.243))*7.34);\n      twinkle = (twinkle + 1.)/2.;\n      return twinkle;\n    }\n   \n    void main() \n    {\n      //坐标原点为画布的左上角，x轴水平向右，y竖直向下\n      vec2 uv = vec2(gl_FragCoord.x, gl_FragCoord.y);\n      float uvOpacity = stars(uv, time);\n      gl_FragColor = vec4(color, uvOpacity);\n    }\n  ",Rn=function(){function e(n){var r;Gt(this,e);var i=qt({data:null,animate:!0},n);return Ht(r=zt(this,e,[i]),"_data",[]),Ht(r,"uniforms",{color:{type:"v3",value:new t.Color(16701210)},size:{type:"float",value:1},time:{type:"float",value:0}}),r.initData(i.data),r}return Yt(e,ue),jt(e,[{key:"onReady",value:function(){this.initPoints()}},{key:"initData",value:function(t){var e=t.features.map((function(t){var e=te(t.geometry.coordinates,2);return[e[0],e[1]]}));this._data=this.customCoords.lngLatsToCoords(e)}},{key:"initPoints",value:function(){var e=this.scene,n=[],r=[];this._data.forEach((function(t){var e=te(t,2),i=e[0],a=e[1];n.push(i,a,0),r.push(parseFloat(Math.random().toFixed(2)))}));var i=new t.BufferGeometry;i.setAttribute("position",new t.Float32BufferAttribute(n,3)),i.setAttribute("opacity",new t.Float32BufferAttribute(r,1));var a=Ln,o=Pn,s=new t.ShaderMaterial({uniforms:this.uniforms,vertexShader:a,fragmentShader:o,blending:t.AdditiveBlending,depthTest:!1,transparent:!0}),l=new t.Points(i,s);e.add(l)}},{key:"update",value:function(){this._isAnimate&&(this.uniforms.time.value+=.01)}}])}(),In=function(){function e(t){var n;Gt(this,e);var r=qt({data:null,speed:1,radius:1e3,animate:!0,textureURL:"./static/texture/texture_wave_circle.png"},t);return Ht(n=zt(this,e,[r]),"_data",[]),Ht(n,"_frameX",1),Ht(n,"_texture",null),Ht(n,"_offset",0),n.initData(r.data),n}return Yt(e,ue),jt(e,[{key:"onReady",value:(r=Bt(Jt().mark((function t(){return Jt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.initPoints();case 2:case"end":return t.stop()}}),t,this)}))),function(){return r.apply(this,arguments)})},{key:"initData",value:function(t){var e=t.features.map((function(t){return qt({lngLat:t.geometry.coordinates},t.properties)})),n=this.customCoords.lngLatsToCoords(e.map((function(t){return t.lngLat})));this._data=n}},{key:"initPoints",value:(n=Bt(Jt().mark((function e(){var n,r,i,a,o,s,l=this;return Jt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this.scene,r=new t.TextureLoader,e.next=4,r.loadAsync(this.mergeSourceURL(this._conf.textureURL));case 4:i=e.sent,a=i.image,o=a.width,s=a.height,this._frameX=o/s,i.wrapS=i.wrapT=t.RepeatWrapping,i.repeat.set(1/this._frameX,1),this._texture=i,this._data.forEach((function(e){var r=te(e,2),a=r[0],o=r[1],s=l.generateGeometry(a,o),u=new t.MeshBasicMaterial({map:i,transparent:!0,depthTest:!0,depthWrite:!1}),c=new t.Mesh(s,u);n.add(c)}));case 11:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"generateGeometry",value:function(e,n){var r=this._conf.radius,i=[new t.Vector3(e-r,n-r,0),new t.Vector3(e+r,n-r,0),new t.Vector3(e-r,n+r,0),new t.Vector3(e-r,n+r,0),new t.Vector3(e+r,n-r,0),new t.Vector3(e+r,n+r,0)],a=(new t.BufferGeometry).setFromPoints(i);return a.setAttribute("uv",new t.BufferAttribute(new Float32Array([0,0,1,0,0,1,0,1,1,0,1,1]),2)),a}},{key:"update",value:function(){this._isAnimate&&this._texture&&(this._offset+=this._conf.speed,this._texture.offset.x=Math.floor(this._offset)/this._frameX)}}]);var n,r}(),On=function(){function e(t){var n;Gt(this,e);var r=qt({data:null,scale:1,altitude:100,content:null,sizeAttenuation:!0},t);return Ht(n=zt(this,e,[r]),"_data",[]),Ht(n,"_feature",[]),Ht(n,"_size",1),Ht(n,"_content",null),n._content=r.content,n.initData(r.data),n}return Yt(e,ue),jt(e,[{key:"onReady",value:(i=Bt(Jt().mark((function t(){return Jt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.initSprites();case 2:case"end":return t.stop()}}),t,this)}))),function(){return i.apply(this,arguments)})},{key:"initData",value:function(t){var e=[],n=[];t.features.forEach((function(t){e.push(t.geometry.coordinates),n.push(qt({type:t.geometry.type},t.properties))}));var r=this.customCoords.lngLatsToCoords(e);this._data=r,this._feature=n}},{key:"setSource",value:function(t){}},{key:"setContent",value:function(t){}},{key:"generateMaterial",value:(r=Bt(Jt().mark((function e(n,r){var i,a,o,s,l,u,c,h;return Jt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(this._content){e.next=3;break}return console.error("SpriteLayer 参数content 不能为空"),e.abrupt("return");case 3:return"function"===(a=he(this._content))?i=this._content(n,r):"string"===a&&(i=this._content),o=(new DOMParser).parseFromString(i,"text/xml").childNodes[0],(s=document.createElement("div")).style.cssText=o.getAttribute("style"),s.innerHTML=o.innerHTML,document.body.append(s),l=s.offsetWidth/s.offsetHeight,e.next=13,Dt(s,{backgroundColor:null,dpi:window.devicePixelRatio});case 13:return u=e.sent,(c=new t.Texture(u)).needsUpdate=!0,document.body.removeChild(s),h=new t.SpriteMaterial({map:c,sizeAttenuation:this._conf.sizeAttenuation,transparent:!0}),e.abrupt("return",{material:h,ratio:l});case 19:case"end":return e.stop()}}),e,this)}))),function(t,e){return r.apply(this,arguments)})},{key:"initSprites",value:(n=Bt(Jt().mark((function e(){var n,r,i,a,o,s,l,u,c,h;return Jt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=this.scene,r=this._size*this._conf.scale,i=0;case 3:if(!(i<this._data.length)){e.next=17;break}return a=te(this._data[i],2),o=a[0],s=a[1],e.next=7,this.generateMaterial(i,this._feature[i]);case 7:l=e.sent,u=l.material,c=l.ratio,(h=new t.Sprite(u)).scale.set(c*r,1*r,0),h.position.set(o,s,this._conf.altitude),n.add(h);case 14:i++,e.next=3;break;case 17:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"update",value:function(){}}]);var n,r,i}();const Dn=new WeakMap;class Nn extends o{constructor(t){super(t),this.decoderPath="",this.decoderConfig={},this.decoderBinary=null,this.decoderPending=null,this.workerLimit=4,this.workerPool=[],this.workerNextTaskID=1,this.workerSourceURL="",this.defaultAttributeIDs={position:"POSITION",normal:"NORMAL",color:"COLOR",uv:"TEX_COORD"},this.defaultAttributeTypes={position:"Float32Array",normal:"Float32Array",color:"Float32Array",uv:"Float32Array"}}setDecoderPath(t){return this.decoderPath=t,this}setDecoderConfig(t){return this.decoderConfig=t,this}setWorkerLimit(t){return this.workerLimit=t,this}load(t,e,n,r){const i=new l(this.manager);i.setPath(this.path),i.setResponseType("arraybuffer"),i.setRequestHeader(this.requestHeader),i.setWithCredentials(this.withCredentials),i.load(t,(t=>{this.parse(t,e,r)}),n,r)}parse(t,e,n){this.decodeDracoFile(t,e,null,null,v).catch(n)}decodeDracoFile(t,e,n,r,i=c){const a={attributeIDs:n||this.defaultAttributeIDs,attributeTypes:r||this.defaultAttributeTypes,useUniqueIDs:!!n,vertexColorSpace:i};return this.decodeGeometry(t,a).then(e)}decodeGeometry(t,e){const n=JSON.stringify(e);if(Dn.has(t)){const e=Dn.get(t);if(e.key===n)return e.promise;if(0===t.byteLength)throw new Error("THREE.DRACOLoader: Unable to re-decode a buffer with different settings. Buffer has already been transferred.")}let r;const i=this.workerNextTaskID++,a=t.byteLength,o=this._getWorker(i,a).then((n=>(r=n,new Promise(((n,a)=>{r._callbacks[i]={resolve:n,reject:a},r.postMessage({type:"decode",id:i,taskConfig:e,buffer:t},[t])}))))).then((t=>this._createGeometry(t.geometry)));return o.catch((()=>!0)).then((()=>{r&&i&&this._releaseTask(r,i)})),Dn.set(t,{key:n,promise:o}),o}_createGeometry(t){const r=new e;t.index&&r.setIndex(new n(t.index.array,1));for(let e=0;e<t.attributes.length;e++){const i=t.attributes[e],a=i.name,o=i.array,s=i.itemSize,l=new n(o,s);"color"===a&&(this._assignVertexColorSpace(l,i.vertexColorSpace),l.normalized=o instanceof Float32Array==!1),r.setAttribute(a,l)}return r}_assignVertexColorSpace(t,e){if(e!==v)return;const n=new u;for(let e=0,r=t.count;e<r;e++)n.fromBufferAttribute(t,e).convertSRGBToLinear(),t.setXYZ(e,n.r,n.g,n.b)}_loadLibrary(t,e){const n=new l(this.manager);return n.setPath(this.decoderPath),n.setResponseType(e),n.setWithCredentials(this.withCredentials),new Promise(((e,r)=>{n.load(t,e,void 0,r)}))}preload(){return this._initDecoder(),this}_initDecoder(){if(this.decoderPending)return this.decoderPending;const t="object"!=typeof WebAssembly||"js"===this.decoderConfig.type,e=[];return t?e.push(this._loadLibrary("draco_decoder.js","text")):(e.push(this._loadLibrary("draco_wasm_wrapper.js","text")),e.push(this._loadLibrary("draco_decoder.wasm","arraybuffer"))),this.decoderPending=Promise.all(e).then((e=>{const n=e[0];t||(this.decoderConfig.wasmBinary=e[1]);const r=Un.toString(),i=["/* draco decoder */",n,"","/* worker */",r.substring(r.indexOf("{")+1,r.lastIndexOf("}"))].join("\n");this.workerSourceURL=URL.createObjectURL(new Blob([i]))})),this.decoderPending}_getWorker(t,e){return this._initDecoder().then((()=>{if(this.workerPool.length<this.workerLimit){const t=new Worker(this.workerSourceURL);t._callbacks={},t._taskCosts={},t._taskLoad=0,t.postMessage({type:"init",decoderConfig:this.decoderConfig}),t.onmessage=function(e){const n=e.data;switch(n.type){case"decode":t._callbacks[n.id].resolve(n);break;case"error":t._callbacks[n.id].reject(n);break;default:console.error('THREE.DRACOLoader: Unexpected message, "'+n.type+'"')}},this.workerPool.push(t)}else this.workerPool.sort((function(t,e){return t._taskLoad>e._taskLoad?-1:1}));const n=this.workerPool[this.workerPool.length-1];return n._taskCosts[t]=e,n._taskLoad+=e,n}))}_releaseTask(t,e){t._taskLoad-=t._taskCosts[e],delete t._callbacks[e],delete t._taskCosts[e]}debug(){console.log("Task load: ",this.workerPool.map((t=>t._taskLoad)))}dispose(){for(let t=0;t<this.workerPool.length;++t)this.workerPool[t].terminate();return this.workerPool.length=0,""!==this.workerSourceURL&&URL.revokeObjectURL(this.workerSourceURL),this}}function Un(){let t,e;function n(t,e,n,r,i,a){const o=a.num_components(),s=n.num_points()*o,l=s*i.BYTES_PER_ELEMENT,u=function(t,e){switch(e){case Float32Array:return t.DT_FLOAT32;case Int8Array:return t.DT_INT8;case Int16Array:return t.DT_INT16;case Int32Array:return t.DT_INT32;case Uint8Array:return t.DT_UINT8;case Uint16Array:return t.DT_UINT16;case Uint32Array:return t.DT_UINT32}}(t,i),c=t._malloc(l);e.GetAttributeDataArrayForAllPoints(n,a,u,l,c);const h=new i(t.HEAPF32.buffer,c,s).slice();return t._free(c),{name:r,array:h,itemSize:o}}onmessage=function(r){const i=r.data;switch(i.type){case"init":t=i.decoderConfig,e=new Promise((function(e){t.onModuleLoaded=function(t){e({draco:t})},DracoDecoderModule(t)}));break;case"decode":const r=i.buffer,a=i.taskConfig;e.then((t=>{const e=t.draco,o=new e.Decoder;try{const t=function(t,e,r,i){const a=i.attributeIDs,o=i.attributeTypes;let s,l;const u=e.GetEncodedGeometryType(r);if(u===t.TRIANGULAR_MESH)s=new t.Mesh,l=e.DecodeArrayToMesh(r,r.byteLength,s);else{if(u!==t.POINT_CLOUD)throw new Error("THREE.DRACOLoader: Unexpected geometry type.");s=new t.PointCloud,l=e.DecodeArrayToPointCloud(r,r.byteLength,s)}if(!l.ok()||0===s.ptr)throw new Error("THREE.DRACOLoader: Decoding failed: "+l.error_msg());const c={index:null,attributes:[]};for(const r in a){const l=self[o[r]];let u,h;if(i.useUniqueIDs)h=a[r],u=e.GetAttributeByUniqueId(s,h);else{if(h=e.GetAttributeId(s,t[a[r]]),-1===h)continue;u=e.GetAttribute(s,h)}const d=n(t,e,s,r,l,u);"color"===r&&(d.vertexColorSpace=i.vertexColorSpace),c.attributes.push(d)}u===t.TRIANGULAR_MESH&&(c.index=function(t,e,n){const r=n.num_faces(),i=3*r,a=4*i,o=t._malloc(a);e.GetTrianglesUInt32Array(n,a,o);const s=new Uint32Array(t.HEAPF32.buffer,o,i).slice();return t._free(o),{array:s,itemSize:1}}(t,e,s));return t.destroy(s),c}(e,o,new Int8Array(r),a),s=t.attributes.map((t=>t.array.buffer));t.index&&s.push(t.index.array.buffer),self.postMessage({type:"decode",id:i.id,geometry:t},s)}catch(t){console.error(t),self.postMessage({type:"error",id:i.id,error:t.message})}finally{e.destroy(o)}}))}}}var Fn,Bn=function(){function e(t){var n;return Gt(this,e),Ht(n=zt(this,e,[qt({zooms:[5,22],tilesURL:"",center:null,loaderURL:"./static/three/examples/js/libs/gltf/",altitude:0},t)]),"_tilesRendererArr",[]),n}return Yt(e,ue),jt(e,[{key:"onReady",value:function(){this.loadTiles()}},{key:"getCenter",value:function(){return this.customCoords.getCenter()}},{key:"loadTiles",value:function(){var t=new Nn;t.setDecoderPath(this.mergeSourceURL(this._conf.loaderURL));var e=new ke;e.setDRACOLoader(t);var n=new Nt(this._conf.tilesURL);n.manager.addHandler(/\.gltf$/,e),n.setCamera(this.camera),n.setResolutionFromRenderer(this.camera,this.renderer),n.group.position.z=this._conf.altitude,this.scene.add(n.group),this._tilesRendererArr.push(n),this._conf.needShadow&&(n.onLoadModel=function(){n.group.traverse((function(t){t.isMesh&&(t.castShadow=!0,t.receiveShadow=!0)}))})}},{key:"update",value:function(){var t,e=function(t,e){var n="undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(!n){if(Array.isArray(t)||(n=ie(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var r=0,i=function(){};return{s:i,n:function(){return r>=t.length?{done:!0}:{done:!1,value:t[r++]}},e:function(t){throw t},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,o=!0,s=!1;return{s:function(){n=n.call(t)},n:function(){var t=n.next();return o=t.done,t},e:function(t){s=!0,a=t},f:function(){try{o||null==n.return||n.return()}finally{if(s)throw a}}}}(this._tilesRendererArr);try{for(e.s();!(t=e.n()).done;){t.value.update()}}catch(t){e.e(t)}finally{e.f()}}},{key:"onPicked",value:function(t){var e=t.targets;t.event,e.length>0?(this.removeLastPick(),this.setLastPick(e[0].object)):this.removeLastPick()}},{key:"setLastPick",value:function(e){var n=this._lastPick;e&&"Mesh"===e.type&&(n&&JSON.stringify(null==n?void 0:n.uuid)===JSON.stringify(null==e?void 0:e.uuid)||(this.removeLastPick(),e.material.color=new t.Color(246/255,215/255,17/255),this._lastPick=e))}},{key:"removeLastPick",value:function(){this._lastPick&&(this._lastPick.material.color=new t.Color(1,1,1))}},{key:"getParentObject",value:function(t,e){var n=t.object,r=e.name;do{if(n.name===r)return n;n=n.parent}while(n)}}])}(),zn={uniforms:{normalSampler:{type:"t",value:null},mirrorSampler:{type:"t",value:null},alpha:{type:"f",value:1},time:{type:"f",value:0},distortionScale:{type:"f",value:20},noiseScale:{type:"f",value:1},textureMatrix:{type:"m4",value:new t.Matrix4},sunColor:{type:"c",value:new t.Color(8355711)},sunDirection:{type:"v3",value:new t.Vector3(.70707,.70707,0)},eye:{type:"v3",value:new t.Vector3(0,0,0)},waterColor:{type:"c",value:new t.Color(5592405)}},vertexShader:"\n    uniform mat4 textureMatrix;\n    uniform float time;\n    varying vec4 mirrorCoord;\n    varying vec3 worldPosition;\n    varying vec3 modelPosition;\n    varying vec3 surfaceX;\n    varying vec3 surfaceY;\n    varying vec3 surfaceZ;\n    void main()\n    {\n      mirrorCoord = modelMatrix * vec4(position, 1.0);\n      worldPosition = mirrorCoord.xyz;\n      modelPosition = position;\n      surfaceX = vec3( modelMatrix[0][0], modelMatrix[0][1], modelMatrix[0][2]);\n      surfaceY = vec3( modelMatrix[1][0], modelMatrix[1][1], modelMatrix[1][2]);\n      surfaceZ = vec3( modelMatrix[2][0], modelMatrix[2][1], modelMatrix[2][2]);\n      mirrorCoord = textureMatrix * mirrorCoord;\n      gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n    }\n  ",fragmentShader:["uniform sampler2D mirrorSampler;","uniform float alpha;","uniform float time;","uniform float distortionScale;","uniform float noiseScale;","uniform sampler2D normalSampler;","uniform vec3 sunColor;","uniform vec3 sunDirection;","uniform vec3 eye;","uniform vec3 waterColor;","varying vec4 mirrorCoord;","varying vec3 worldPosition;","varying vec3 modelPosition;","varying vec3 surfaceX;","varying vec3 surfaceY;","varying vec3 surfaceZ;","void sunLight(const vec3 surfaceNormal, const vec3 eyeDirection, in float shiny, in float spec, in float diffuse, inout vec3 diffuseColor, inout vec3 specularColor)","{","\tvec3 reflection = normalize(reflect(-sunDirection, surfaceNormal));","\tfloat direction = max(0.0, dot(eyeDirection, reflection));","\tspecularColor += pow(direction, shiny) * sunColor * spec;","\tdiffuseColor += max(dot(sunDirection, surfaceNormal), 0.0) * sunColor * diffuse;","}","vec3 getNoise(in vec2 uv)","{","\tvec2 uv0 = uv / (103.0 * noiseScale) + vec2(time / 17.0, time / 29.0);","\tvec2 uv1 = uv / (107.0 * noiseScale) - vec2(time / -19.0, time / 31.0);","\tvec2 uv2 = uv / (vec2(8907.0, 9803.0) * noiseScale) + vec2(time / 101.0, time /   97.0);","\tvec2 uv3 = uv / (vec2(1091.0, 1027.0) * noiseScale) - vec2(time / 109.0, time / -113.0);","\tvec4 noise = texture2D(normalSampler, uv0) +","\t\ttexture2D(normalSampler, uv1) +","\t\ttexture2D(normalSampler, uv2) +","\t\ttexture2D(normalSampler, uv3);","\treturn noise.xyz * 0.5 - 1.0;","}",t.ShaderChunk.common,t.ShaderChunk.fog_pars_fragment,"void main()","{","\tvec3 worldToEye = eye - worldPosition;","\tvec3 eyeDirection = normalize(worldToEye);","\tvec3 noise = getNoise(modelPosition.xy * 1.0);","\tvec3 distordCoord = noise.x * surfaceX + noise.y * surfaceY;","\tvec3 distordNormal = distordCoord + surfaceZ;","\tif(dot(eyeDirection, surfaceZ) < 0.0)","\t\tdistordNormal = distordNormal * -1.0;","\tvec3 diffuseLight = vec3(0.0);","\tvec3 specularLight = vec3(0.0);","\tsunLight(distordNormal, eyeDirection, 100.0, 2.0, 0.5, diffuseLight, specularLight);","\tfloat distance = length(worldToEye);","\tvec2 distortion = distordCoord.xy * distortionScale * sqrt(distance) * 0.07;"," vec3 mirrorDistord = mirrorCoord.xyz + vec3(distortion.x, distortion.y, 1.0);"," vec3 reflectionSample = texture2DProj(mirrorSampler, mirrorDistord).xyz;","\tfloat theta = max(dot(eyeDirection, distordNormal), 0.0);","\tfloat reflectance = 0.3 + (1.0 - 0.3) * pow((1.0 - theta), 3.0);","\tvec3 scatter = max(0.0, dot(distordNormal, eyeDirection)) * waterColor;","\tvec3 albedo = mix(sunColor * diffuseLight * 0.3 + scatter, (vec3(0.1) + reflectionSample * 0.9 + reflectionSample * specularLight), reflectance);"," vec3 outgoingLight = albedo;",t.ShaderChunk.fog_fragment," gl_FragColor = vec4( outgoingLight, alpha );","}"].join("\n")},Gn=function(){function e(n){var r;Gt(this,e);var i=qt({data:null,waterColor:"#78acd2",opacity:1,distortionScale:13.7,textureURL:"./static/texture/water_normals.jpg",altitude:0,animate:!0},n);Ht(r=zt(this,e,[i]),"_data",[]),Ht(r,"uniforms",t.UniformsUtils.merge([t.UniformsLib.fog,t.UniformsLib.lights,zn.uniforms]));var a=(new t.TextureLoader).load(r.mergeSourceURL(i.textureURL));return a.wrapS=t.RepeatWrapping,a.wrapT=t.RepeatWrapping,r.uniforms.normalSampler.value=a,r.uniforms.waterColor.value=new t.Color(i.waterColor),r.uniforms.distortionScale.value=i.distortionScale,r.uniforms.alpha.value=i.opacity,r.initData(i.data),r}return Yt(e,ue),jt(e,[{key:"onReady",value:function(){this.createMesh()}},{key:"initData",value:function(t){var e=this;t.features.forEach((function(t){var n=t.geometry,r=t.properties;switch(n.type){case"MultiPolygon":n.coordinates[0].forEach((function(t){e._data.push({path:e.customCoords.lngLatsToCoords(t),properties:r})}));break;case"Polygon":e._data.push({path:e.customCoords.lngLatsToCoords(n.coordinates[0]),properties:r})}})),console.log(this._data)}},{key:"createMesh",value:function(){var t=this;this._data.forEach((function(e){t.drawOneArea(e)}))}},{key:"drawOneArea",value:function(e){var n=e.path,r=this.scene,i=new t.Shape;n.forEach((function(t,e){var n=te(t,2),r=n[0],a=n[1];0===e?i.moveTo(r,a):i.lineTo(r,a)}));var a=new t.ShapeGeometry(i),o=new t.Mesh(a,this.getMaterial());o.position.z=this._conf.altitude,r.add(o)}},{key:"getMaterial",value:function(){var e=zn.vertexShader,n=zn.fragmentShader;return new t.ShaderMaterial({uniforms:this.uniforms,vertexShader:e,fragmentShader:n,depthTest:!0,transparent:!0})}},{key:"update",value:function(){this._isAnimate&&this.uniforms&&(this.uniforms.time.value+=.01,this.uniforms.eye.value.setFromMatrixPosition(this.camera.matrixWorld))}}])}(),Vn="\n       // 可配置变量：高度图纹理\n        uniform sampler2D bumpTexture;\n        // 可配置变量：形变程度，数值越大形变越明显\n        uniform float bumpScale;\n        \n        // 用于传递顶点的高度\n        varying float vAmount;\n        // 用于传递顶点的 UV 贴图坐标\n        varying vec2 vUV;\n        \n        void main()\n        {\n            // 将UV映射传递到片元着色器\n            vUV = uv;\n        \n            // 高度图纹理坐标\n            vec4 bumpData = texture2D(bumpTexture, uv);\n        \n            // 高程图是灰色的(每个点的r=b=g),用于获取顶点高度，因此取rgb中任意一个值即可，这里取r\n            vAmount = bumpData.r;\n        \n            // 将顶点朝着法线的方向移动，平面的法线向上，相当于垂直抬高\n            vec3 newPosition = position + normal * bumpScale * vAmount;\n        \n            // 使用标准公式计算顶点的位置\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(newPosition, 1.0);\n        }\n  ",jn="   \n        // 可配置变量：地形纹理图\n        uniform sampler2D terrainTexture;\n        // 获取从顶点着色器传来的UV\n        varying vec2 vUV;\n        // 获取从顶点着色器传来的 顶点高度\n        varying float vAmount;\n        \n        void main()\n        {\n            // 由UV来确定纹理图布局\n            gl_FragColor = texture2D(terrainTexture, vUV);\n        }\n\n  ",Hn=function(){function e(t){var n;return Gt(this,e),Ht(n=zt(this,e,[qt({animate:!1,zooms:[5,14],center:[0,0],style:{width:100,height:100,widthSegments:50,heightSegments:50},intensity:0,unitHeight:2,altitude:0,mapTexture:"./static/texture/terrain_terrain_texture.jpg",normalTexture:"./static/texture/terrain_map_normal.jpg",terrainTexture:"./static/texture/terrain_terrain_texture.jpg"},t)]),"_model",null),n.initData(),n}return Yt(e,ue),jt(e,[{key:"initData",value:function(){var t=te(this._conf.center,2),e=t[0],n=t[1];this._data=this.customCoords.lngLatsToCoords([e,n])}},{key:"onReady",value:(n=Bt(Jt().mark((function t(){return Jt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:this.createModel();case 1:case"end":return t.stop()}}),t,this)}))),function(){return n.apply(this,arguments)})},{key:"createModel",value:function(){var e=this.createPlaneGeometry(),n=(new t.TextureLoader).load(this.mergeSourceURL(this._conf.terrainTexture)),r=(new t.TextureLoader).load(this.mergeSourceURL(this._conf.mapTexture)),i=this.generateMaterial(n,r),a=new t.Mesh(e,i);this.scene.add(a);var o=te(this._data[0],2),s=o[0],l=o[1];a.position.set(s,l,this._conf.altitude),this._model=a}},{key:"generateMaterial",value:function(e,n){var r=Vn,i=jn;return new t.ShaderMaterial({vertexShader:r,fragmentShader:i,uniforms:{terrainTexture:{value:n},bumpTexture:{value:e},bumpScale:{value:100*this._conf.unitHeight}}})}},{key:"setMapTexture",value:function(e){var n;if("string"==typeof e)n=(new t.TextureLoader).load(e);else{if(!(e instanceof t.Texture))throw"setMapTexture value invalid";n=e}var r=(new t.TextureLoader).load(this.mergeSourceURL(this._conf.terrainTexture)),i=this.generateMaterial(r,n);this._model.material=i}},{key:"createPlaneGeometry",value:function(){var e=this._conf.style,n=e.width,r=e.height,i=e.widthSegments,a=e.heightSegments;return new t.PlaneGeometry(n,r,i,a)}},{key:"update",value:function(){}}]);var n}(),Wn=Object.freeze({Linear:Object.freeze({None:function(t){return t},In:function(t){return this.None(t)},Out:function(t){return this.None(t)},InOut:function(t){return this.None(t)}}),Quadratic:Object.freeze({In:function(t){return t*t},Out:function(t){return t*(2-t)},InOut:function(t){return(t*=2)<1?.5*t*t:-.5*(--t*(t-2)-1)}}),Cubic:Object.freeze({In:function(t){return t*t*t},Out:function(t){return--t*t*t+1},InOut:function(t){return(t*=2)<1?.5*t*t*t:.5*((t-=2)*t*t+2)}}),Quartic:Object.freeze({In:function(t){return t*t*t*t},Out:function(t){return 1- --t*t*t*t},InOut:function(t){return(t*=2)<1?.5*t*t*t*t:-.5*((t-=2)*t*t*t-2)}}),Quintic:Object.freeze({In:function(t){return t*t*t*t*t},Out:function(t){return--t*t*t*t*t+1},InOut:function(t){return(t*=2)<1?.5*t*t*t*t*t:.5*((t-=2)*t*t*t*t+2)}}),Sinusoidal:Object.freeze({In:function(t){return 1-Math.sin((1-t)*Math.PI/2)},Out:function(t){return Math.sin(t*Math.PI/2)},InOut:function(t){return.5*(1-Math.sin(Math.PI*(.5-t)))}}),Exponential:Object.freeze({In:function(t){return 0===t?0:Math.pow(1024,t-1)},Out:function(t){return 1===t?1:1-Math.pow(2,-10*t)},InOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?.5*Math.pow(1024,t-1):.5*(2-Math.pow(2,-10*(t-1)))}}),Circular:Object.freeze({In:function(t){return 1-Math.sqrt(1-t*t)},Out:function(t){return Math.sqrt(1- --t*t)},InOut:function(t){return(t*=2)<1?-.5*(Math.sqrt(1-t*t)-1):.5*(Math.sqrt(1-(t-=2)*t)+1)}}),Elastic:Object.freeze({In:function(t){return 0===t?0:1===t?1:-Math.pow(2,10*(t-1))*Math.sin(5*(t-1.1)*Math.PI)},Out:function(t){return 0===t?0:1===t?1:Math.pow(2,-10*t)*Math.sin(5*(t-.1)*Math.PI)+1},InOut:function(t){return 0===t?0:1===t?1:(t*=2)<1?-.5*Math.pow(2,10*(t-1))*Math.sin(5*(t-1.1)*Math.PI):.5*Math.pow(2,-10*(t-1))*Math.sin(5*(t-1.1)*Math.PI)+1}}),Back:Object.freeze({In:function(t){var e=1.70158;return 1===t?1:t*t*((e+1)*t-e)},Out:function(t){var e=1.70158;return 0===t?0:--t*t*((e+1)*t+e)+1},InOut:function(t){var e=2.5949095;return(t*=2)<1?t*t*((e+1)*t-e)*.5:.5*((t-=2)*t*((e+1)*t+e)+2)}}),Bounce:Object.freeze({In:function(t){return 1-Wn.Bounce.Out(1-t)},Out:function(t){return t<1/2.75?7.5625*t*t:t<2/2.75?7.5625*(t-=1.5/2.75)*t+.75:t<2.5/2.75?7.5625*(t-=2.25/2.75)*t+.9375:7.5625*(t-=2.625/2.75)*t+.984375},InOut:function(t){return t<.5?.5*Wn.Bounce.In(2*t):.5*Wn.Bounce.Out(2*t-1)+.5}}),generatePow:function(t){return void 0===t&&(t=4),t=(t=t<Number.EPSILON?Number.EPSILON:t)>1e4?1e4:t,{In:function(e){return Math.pow(e,t)},Out:function(e){return 1-Math.pow(1-e,t)},InOut:function(e){return e<.5?Math.pow(2*e,t)/2:(1-Math.pow(2-2*e,t))/2+.5}}}}),Xn=function(){return performance.now()},Yn=function(){function t(){this._tweens={},this._tweensAddedDuringUpdate={}}return t.prototype.getAll=function(){var t=this;return Object.keys(this._tweens).map((function(e){return t._tweens[e]}))},t.prototype.removeAll=function(){this._tweens={}},t.prototype.add=function(t){this._tweens[t.getId()]=t,this._tweensAddedDuringUpdate[t.getId()]=t},t.prototype.remove=function(t){delete this._tweens[t.getId()],delete this._tweensAddedDuringUpdate[t.getId()]},t.prototype.update=function(t,e){void 0===t&&(t=Xn()),void 0===e&&(e=!1);var n=Object.keys(this._tweens);if(0===n.length)return!1;for(;n.length>0;){this._tweensAddedDuringUpdate={};for(var r=0;r<n.length;r++){var i=this._tweens[n[r]],a=!e;i&&!1===i.update(t,a)&&!e&&delete this._tweens[n[r]]}n=Object.keys(this._tweensAddedDuringUpdate)}return!0},t}(),Kn={Linear:function(t,e){var n=t.length-1,r=n*e,i=Math.floor(r),a=Kn.Utils.Linear;return e<0?a(t[0],t[1],r):e>1?a(t[n],t[n-1],n-r):a(t[i],t[i+1>n?n:i+1],r-i)},Bezier:function(t,e){for(var n=0,r=t.length-1,i=Math.pow,a=Kn.Utils.Bernstein,o=0;o<=r;o++)n+=i(1-e,r-o)*i(e,o)*t[o]*a(r,o);return n},CatmullRom:function(t,e){var n=t.length-1,r=n*e,i=Math.floor(r),a=Kn.Utils.CatmullRom;return t[0]===t[n]?(e<0&&(i=Math.floor(r=n*(1+e))),a(t[(i-1+n)%n],t[i],t[(i+1)%n],t[(i+2)%n],r-i)):e<0?t[0]-(a(t[0],t[0],t[1],t[1],-r)-t[0]):e>1?t[n]-(a(t[n],t[n],t[n-1],t[n-1],r-n)-t[n]):a(t[i?i-1:0],t[i],t[n<i+1?n:i+1],t[n<i+2?n:i+2],r-i)},Utils:{Linear:function(t,e,n){return(e-t)*n+t},Bernstein:function(t,e){var n=Kn.Utils.Factorial;return n(t)/n(e)/n(t-e)},Factorial:(Fn=[1],function(t){var e=1;if(Fn[t])return Fn[t];for(var n=t;n>1;n--)e*=n;return Fn[t]=e,e}),CatmullRom:function(t,e,n,r,i){var a=.5*(n-t),o=.5*(r-e),s=i*i;return(2*e-2*n+a+o)*(i*s)+(-3*e+3*n-2*a-o)*s+a*i+e}}},Qn=function(){function t(){}return t.nextId=function(){return t._nextId++},t._nextId=0,t}(),qn=new Yn,Zn=function(){function t(t,e){void 0===e&&(e=qn),this._object=t,this._group=e,this._isPaused=!1,this._pauseStart=0,this._valuesStart={},this._valuesEnd={},this._valuesStartRepeat={},this._duration=1e3,this._isDynamic=!1,this._initialRepeat=0,this._repeat=0,this._yoyo=!1,this._isPlaying=!1,this._reversed=!1,this._delayTime=0,this._startTime=0,this._easingFunction=Wn.Linear.None,this._interpolationFunction=Kn.Linear,this._chainedTweens=[],this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._id=Qn.nextId(),this._isChainStopped=!1,this._propertiesAreSetUp=!1,this._goToEnd=!1}return t.prototype.getId=function(){return this._id},t.prototype.isPlaying=function(){return this._isPlaying},t.prototype.isPaused=function(){return this._isPaused},t.prototype.to=function(t,e){if(void 0===e&&(e=1e3),this._isPlaying)throw new Error("Can not call Tween.to() while Tween is already started or paused. Stop the Tween first.");return this._valuesEnd=t,this._propertiesAreSetUp=!1,this._duration=e,this},t.prototype.duration=function(t){return void 0===t&&(t=1e3),this._duration=t,this},t.prototype.dynamic=function(t){return void 0===t&&(t=!1),this._isDynamic=t,this},t.prototype.start=function(t,e){if(void 0===t&&(t=Xn()),void 0===e&&(e=!1),this._isPlaying)return this;if(this._group&&this._group.add(this),this._repeat=this._initialRepeat,this._reversed)for(var n in this._reversed=!1,this._valuesStartRepeat)this._swapEndStartRepeatValues(n),this._valuesStart[n]=this._valuesStartRepeat[n];if(this._isPlaying=!0,this._isPaused=!1,this._onStartCallbackFired=!1,this._onEveryStartCallbackFired=!1,this._isChainStopped=!1,this._startTime=t,this._startTime+=this._delayTime,!this._propertiesAreSetUp||e){if(this._propertiesAreSetUp=!0,!this._isDynamic){var r={};for(var i in this._valuesEnd)r[i]=this._valuesEnd[i];this._valuesEnd=r}this._setupProperties(this._object,this._valuesStart,this._valuesEnd,this._valuesStartRepeat,e)}return this},t.prototype.startFromCurrentValues=function(t){return this.start(t,!0)},t.prototype._setupProperties=function(t,e,n,r,i){for(var a in n){var o=t[a],s=Array.isArray(o),l=s?"array":typeof o,u=!s&&Array.isArray(n[a]);if("undefined"!==l&&"function"!==l){if(u){if(0===(m=n[a]).length)continue;for(var c=[o],h=0,d=m.length;h<d;h+=1){var f=this._handleRelativeValue(o,m[h]);if(isNaN(f)){u=!1,console.warn("Found invalid interpolation list. Skipping.");break}c.push(f)}u&&(n[a]=c)}if("object"!==l&&!s||!o||u)(void 0===e[a]||i)&&(e[a]=o),s||(e[a]*=1),r[a]=u?n[a].slice().reverse():e[a]||0;else{e[a]=s?[]:{};var p=o;for(var v in p)e[a][v]=p[v];r[a]=s?[]:{};var m=n[a];if(!this._isDynamic){var g={};for(var v in m)g[v]=m[v];n[a]=m=g}this._setupProperties(p,e[a],m,r[a],i)}}}},t.prototype.stop=function(){return this._isChainStopped||(this._isChainStopped=!0,this.stopChainedTweens()),this._isPlaying?(this._group&&this._group.remove(this),this._isPlaying=!1,this._isPaused=!1,this._onStopCallback&&this._onStopCallback(this._object),this):this},t.prototype.end=function(){return this._goToEnd=!0,this.update(1/0),this},t.prototype.pause=function(t){return void 0===t&&(t=Xn()),this._isPaused||!this._isPlaying||(this._isPaused=!0,this._pauseStart=t,this._group&&this._group.remove(this)),this},t.prototype.resume=function(t){return void 0===t&&(t=Xn()),this._isPaused&&this._isPlaying?(this._isPaused=!1,this._startTime+=t-this._pauseStart,this._pauseStart=0,this._group&&this._group.add(this),this):this},t.prototype.stopChainedTweens=function(){for(var t=0,e=this._chainedTweens.length;t<e;t++)this._chainedTweens[t].stop();return this},t.prototype.group=function(t){return void 0===t&&(t=qn),this._group=t,this},t.prototype.delay=function(t){return void 0===t&&(t=0),this._delayTime=t,this},t.prototype.repeat=function(t){return void 0===t&&(t=0),this._initialRepeat=t,this._repeat=t,this},t.prototype.repeatDelay=function(t){return this._repeatDelayTime=t,this},t.prototype.yoyo=function(t){return void 0===t&&(t=!1),this._yoyo=t,this},t.prototype.easing=function(t){return void 0===t&&(t=Wn.Linear.None),this._easingFunction=t,this},t.prototype.interpolation=function(t){return void 0===t&&(t=Kn.Linear),this._interpolationFunction=t,this},t.prototype.chain=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];return this._chainedTweens=t,this},t.prototype.onStart=function(t){return this._onStartCallback=t,this},t.prototype.onEveryStart=function(t){return this._onEveryStartCallback=t,this},t.prototype.onUpdate=function(t){return this._onUpdateCallback=t,this},t.prototype.onRepeat=function(t){return this._onRepeatCallback=t,this},t.prototype.onComplete=function(t){return this._onCompleteCallback=t,this},t.prototype.onStop=function(t){return this._onStopCallback=t,this},t.prototype.update=function(t,e){if(void 0===t&&(t=Xn()),void 0===e&&(e=!0),this._isPaused)return!0;var n,r,i=this._startTime+this._duration;if(!this._goToEnd&&!this._isPlaying){if(t>i)return!1;e&&this.start(t,!0)}if(this._goToEnd=!1,t<this._startTime)return!0;!1===this._onStartCallbackFired&&(this._onStartCallback&&this._onStartCallback(this._object),this._onStartCallbackFired=!0),!1===this._onEveryStartCallbackFired&&(this._onEveryStartCallback&&this._onEveryStartCallback(this._object),this._onEveryStartCallbackFired=!0),r=(t-this._startTime)/this._duration,r=0===this._duration||r>1?1:r;var a=this._easingFunction(r);if(this._updateProperties(this._object,this._valuesStart,this._valuesEnd,a),this._onUpdateCallback&&this._onUpdateCallback(this._object,r),1===r){if(this._repeat>0){for(n in isFinite(this._repeat)&&this._repeat--,this._valuesStartRepeat)this._yoyo||"string"!=typeof this._valuesEnd[n]||(this._valuesStartRepeat[n]=this._valuesStartRepeat[n]+parseFloat(this._valuesEnd[n])),this._yoyo&&this._swapEndStartRepeatValues(n),this._valuesStart[n]=this._valuesStartRepeat[n];return this._yoyo&&(this._reversed=!this._reversed),void 0!==this._repeatDelayTime?this._startTime=t+this._repeatDelayTime:this._startTime=t+this._delayTime,this._onRepeatCallback&&this._onRepeatCallback(this._object),this._onEveryStartCallbackFired=!1,!0}this._onCompleteCallback&&this._onCompleteCallback(this._object);for(var o=0,s=this._chainedTweens.length;o<s;o++)this._chainedTweens[o].start(this._startTime+this._duration,!1);return this._isPlaying=!1,!1}return!0},t.prototype._updateProperties=function(t,e,n,r){for(var i in n)if(void 0!==e[i]){var a=e[i]||0,o=n[i],s=Array.isArray(t[i]),l=Array.isArray(o);!s&&l?t[i]=this._interpolationFunction(o,r):"object"==typeof o&&o?this._updateProperties(t[i],a,o,r):"number"==typeof(o=this._handleRelativeValue(a,o))&&(t[i]=a+(o-a)*r)}},t.prototype._handleRelativeValue=function(t,e){return"string"!=typeof e?e:"+"===e.charAt(0)||"-"===e.charAt(0)?t+parseFloat(e):parseFloat(e)},t.prototype._swapEndStartRepeatValues=function(t){var e=this._valuesStartRepeat[t],n=this._valuesEnd[t];this._valuesStartRepeat[t]="string"==typeof n?this._valuesStartRepeat[t]+parseFloat(n):this._valuesEnd[t],this._valuesEnd[t]=e},t}(),Jn="20.0.3",$n=Qn.nextId,tr=qn,er=tr.getAll.bind(tr),nr=tr.removeAll.bind(tr),rr=tr.add.bind(tr),ir=tr.remove.bind(tr),ar=tr.update.bind(tr),or={Easing:Wn,Group:Yn,Interpolation:Kn,now:Xn,Sequence:Qn,nextId:$n,Tween:Zn,VERSION:Jn,getAll:er,removeAll:nr,add:rr,remove:ir,update:ar},sr=Object.freeze({__proto__:null,Easing:Wn,Group:Yn,Interpolation:Kn,Sequence:Qn,Tween:Zn,VERSION:Jn,add:rr,default:or,getAll:er,nextId:$n,now:Xn,remove:ir,removeAll:nr,update:ar}),lr=function(){function e(t){var n,r;Gt(this,e);var i=qt({path:null,NPC:null,speed:50,cameraFollow:!1,perspective:3},t);return Ht(r=zt(this,e,[i]),"_data",[]),Ht(r,"_PATH_COORDS",[]),Ht(r,"_PATH_LNG_LAT",[]),Ht(r,"_NPC_ALTITUDE",0),Ht(r,"_rayController",null),Ht(r,"npc_step",0),Ht(r,"_isMoving",!1),r._NPC_ALTITUDE=null!==(n=t.altitude)&&void 0!==n?n:0,r.initData(i.path),r}return Yt(e,ue),jt(e,[{key:"perspective",get:function(){return this._conf.perspective},set:function(t){this._conf.perspective=t,this.updateNPC()}},{key:"onReady",value:function(){this._conf.NPC&&this.initNPC(),this.initController()}},{key:"initData",value:function(t){var e=this,n=t.features;this._data=JSON.parse(JSON.stringify(n)),this._data.forEach((function(t,n){var r=t.geometry,i=r.type,a=r.coordinates;"MultiLineString"===i&&(t.geometry.coordinates=a.map((function(t){return e.handleOnePath(t)}))),"LineString"===i&&(t.geometry.coordinates=e.handleOnePath(a))}))}},{key:"setData",value:function(t){this.reset(),this.initData(t),this.initController()}},{key:"reset",value:function(){this.destroyController(),this._PATH_COORDS=[],this._PATH_LNG_LAT=[]}},{key:"handleOnePath",value:function(e){var n=this,r=this._PATH_LNG_LAT,i=this._PATH_COORDS,a=this._NPC_ALTITUDE,o=i.length,s=e.map((function(t){return[t[0],t[1],t[2]||n._NPC_ALTITUDE]}));if(o>0){var l=r[o-1],u=l.x,c=l.y,h=l.z;JSON.stringify([u,c,h])===JSON.stringify(s[0])&&s.shift()}r.push.apply(r,ee(s.map((function(e){return(new t.Vector3).fromArray(e)}))));var d=this.customCoords.lngLatsToCoords(s).map((function(t,e){return[t[0],t[1],s[e][2]||a]}));return i.push.apply(i,ee(d.map((function(e){return(new t.Vector3).fromArray(e)})))),s}},{key:"setPath",value:function(t){}},{key:"reStart",value:function(){null==this._rayController&&this.initController()}},{key:"stop",value:function(){this._rayController&&this.destroyController()}},{key:"resume",value:function(){this._isMoving=!0}},{key:"pause",value:function(){this._isMoving=!1}},{key:"locateNPC",value:function(){}},{key:"setSpeed",value:function(t){this._conf.speed=t}},{key:"setCameraFollow",value:function(t){this._conf.cameraFollow=!!t}},{key:"initNPC",value:function(){var t=this._PATH_COORDS,e=this.scene,n=this._conf.NPC;n.up.set(0,0,1),t.length>1&&(n.position.copy(t[0]),n.lookAt(t[1])),e.add(n)}},{key:"updateNPC",value:function(){var t=this._conf,e=t.perspective,n=t.NPC,r=this.map,i=this.scene,a=this._PATH_COORDS,o=this.npc_step;if(1===e)n&&i.remove(n),r.setZoom(22);else if(3===e){if(n){i.add(n);var s=a[o];n.position.copy(s)}r.setZoom(20)}}},{key:"getTotalDistance",value:function(t){for(var e=0,n=0;n<t.length-1;n++)e+=t[n].distanceTo(t[n+1]);return e}},{key:"initController",value:function(){var e=this,n={t:0},r=this._PATH_COORDS;this.map;var i=this.getTotalDistance(r),a=i/this._conf.speed*1e3;this._rayController=new Zn(n).to({t:1},a).easing(Wn.Linear.None).onUpdate((function(){for(var a=e._conf,o=a.NPC,s=a.cameraFollow,l=i*n.t,u=0,c=0,h=0,d=0;d<r.length-1;d++){var f=r[d].distanceTo(r[d+1]);if(u+f>=l){c=d,h=(l-u)/f;break}u+=f}var p=r[c],v=r[c+1],m=new t.Vector3;if(m.copy(p).lerp(v,h),o){o.position.copy(m);var g=r[Math.min(c+2,r.length-1)];o.lookAt(g),o.up.set(0,0,1)}if(s){var y=e.coordsToLngLat(m);e.updateMapCenter(y)}})).onStart((function(){})).onComplete((function(){})).repeat(1/0).start()}},{key:"destroyController",value:function(){this._rayController.stop(),ir(this._rayController),this._rayController=null}},{key:"updateMapCenter",value:function(t){this.map.panTo(t,0)}},{key:"updateMapRotation",value:function(t){Math.abs(t)>=1&&this.map.setRotation(t,!0,0)}},{key:"coordsToLngLat",value:function(t){var e=this.map,n=this.camera,r=this.container.getBoundingClientRect(),i=r.width,a=r.height,o=r.left,s=r.top;t.project(n),t.z=0;var l=(t.x+1)/2*i+o,u=(1-t.y)/2*a+s;return e.containerToLngLat([l,u])}},{key:"getAngle",value:function(t,e){var n=e.x-t.x,r=e.y-t.y,i=180*Math.atan2(r,n)/Math.PI;return-1*((i=90-(i=i>=0?i:360+i))>=-180?i:i+360)}},{key:"update",value:function(t){var e=this._rayController,n=this._isMoving;e&&n&&e.update(t)}}])}(),ur=function(){function e(n){var r;Gt(this,e);var i=qt({data:null,altitude:0,interact:!0,pickEvent:"click",moveStep:1},n);return Ht(r=zt(this,e,[i]),"_line",null),Ht(r,"_nodeData",[]),Ht(r,"_currNode",null),Ht(r,"_nodeGroup",[]),Ht(r,"_currNodeHelper",new t.AxesHelper(10)),Ht(r,"_nodeMt",new t.MeshBasicMaterial({color:65280})),Ht(r,"_currNodeMt",new t.MeshBasicMaterial({color:16711680})),r.initData(i.data),r}return Yt(e,ue),jt(e,[{key:"initData",value:function(e){var n,r=this,i=(null===(n=e.features[0])||void 0===n||null===(n=n.geometry)||void 0===n?void 0:n.coordinates[0])||[],a=this.customCoords.lngLatsToCoords(i);this._nodeData=a.map((function(e,n){var a=void 0===i[n][2]?r._conf.altitude:i[n][2];return new t.Vector3(e[0],e[1],a)})),this._data=a}},{key:"onReady",value:function(){this.initLine(),this.initNodes(),this.initInteract()}},{key:"initInteract",value:function(){var t=this;document.addEventListener("keydown",(function(e){if(t._currNode){var n=t._conf.moveStep,r=t._currNode.position,i=e.shiftKey?-1:1;switch(e.code){case"KeyX":t._currNode.position.set(r.x+n*i,r.y,r.z);break;case"KeyY":t._currNode.position.set(r.x,r.y+n*i,r.z);break;case"KeyZ":t._currNode.position.set(r.x,r.y,r.z+n*i)}t.reDraw()}}))}},{key:"reDraw",value:function(){this._nodeData=this._nodeGroup.map((function(e){return new t.Vector3(e.position.x,e.position.y,e.position.z)})),this.updateLine(this._nodeData)}},{key:"updateLine",value:function(t){var e=this._line.geometry;e.setFromPoints(t),e.attributes.position.needsUpdate=!0}},{key:"initLine",value:function(){var e=this.scene,n=new t.LineBasicMaterial({color:new t.Color("#00ff00")}),r=(new t.BufferGeometry).setFromPoints(this._nodeData),i=new t.Line(r,n);this._line=i,e.add(i)}},{key:"initNodes",value:function(){var e=this,n=new t.BoxGeometry(2,2,2),r=new t.Mesh(n,this._nodeMt);this._nodeData.forEach((function(t,n){var i=t.x,a=t.y,o=t.z,s=r.clone();s.position.set(i,a,o),s._attrs={index:n},e.scene.add(s),e._nodeGroup.push(s)}))}},{key:"onPicked",value:function(t){var e=t.targets;if(t.event,e.length>0){var n=e[0].object,r=n.geometry,i=n._attrs;"BoxGeometry"===(null==r?void 0:r.type)&&(console.log(JSON.stringify(i)),this.setCurrNode(e[0].object))}}},{key:"setCurrNode",value:function(t){var e=t._attrs;this._currNode&&this._currNode._attrs===e||(this._currNode&&(this._currNode.material=this._nodeMt,this._currNode.remove(this._currNodeHelper)),this._currNode=t,this._currNode.material=this._currNodeMt,this._currNode.add(this._currNodeHelper))}},{key:"getNodesLngLat",value:function(){var t=this;return this._nodeData.map((function(e){var n=t.coordsToLngLat(e.clone());return[n.lng,n.lat,e.z]}))}},{key:"coordsToLngLat",value:function(t){var e=this.map,n=this.camera,r=this.container.getBoundingClientRect(),i=r.width,a=r.height,o=r.left,s=r.top;t.z=0,t.project(n);var l=(t.x+1)/2*i+o,u=(1-t.y)/2*a+s;return e.containerToLngLat([l,u])}},{key:"update",value:function(){}}])}(),cr=function(){function e(n){var r;Gt(this,e);var i=qt({type:"cube",size:[500,500,500],altitude:0},n.bound),a=qt({size:1,ratio:.01,opacity:.5,textureURL:"./static/texture/rain_drop.png",count:1e4,speed:1},n.particleStyle),o=qt({windAngle:0,windPower:0},n.wind);return delete n.bound,delete n.particleStyle,delete n.wind,Ht(r=zt(this,e,[qt(qt({},n),{},{bound:i,particleStyle:a,wind:o})]),"_time",0),Ht(r,"_clock",new t.Clock),r}return Yt(e,ue),jt(e,[{key:"initData",value:function(t){}},{key:"onReady",value:function(){this.createScope()}},{key:"createScope",value:function(){var e=this.createMaterial(),n=this.createGeometry(),r=new t.Mesh(n,e);r.position.set(0,0,this._conf.bound.altitude),this.scene.add(r)}},{key:"createGeometry",value:function(){var e=this._conf.particleStyle,n=e.count,r=e.scale,i=e.ratio,a=this._conf.bound.size,o=new t.Box3(new t.Vector3(-a[0],-a[1],0),new t.Vector3(a[0],a[1],a[2])),s=this._conf.wind,l=s.windPower;s.windAngle;for(var u=new t.Vector3(1,1,0).normalize(),c=l*Math.PI/4,h=new t.BufferGeometry,d=[],f=[],p=[],v=[],m=0;m<n;m++){var g=new t.Vector3;g.x=Math.random()*(o.max.x-o.min.x)+o.min.x,g.y=Math.random()*(o.max.y-o.min.y)+o.min.y,g.z=Math.random()*(o.max.z-o.min.z)+o.min.z;for(var y=(o.max.z-o.min.z)*r/15,_=y*i,x=[g.x+_,g.y,g.z+y/2,g.x-_,g.y,g.z+y/2,g.x-_,g.y,g.z-y/2,g.x+_,g.y,g.z-y/2],w=(new t.Matrix4).makeRotationAxis(u,c),b=0;b<x.length;b+=3){var A=new t.Vector3(x[b],x[b+1],x[b+2]);A.sub(new t.Vector3(g.x,g.y,g.z)),A.applyMatrix4(w),A.add(new t.Vector3(g.x,g.y,g.z)),x[b]=A.x,x[b+1]=A.y,x[b+2]=A.z}d.push.apply(d,x),f.push(g.x,g.y,g.z,g.x,g.y,g.z,g.x,g.y,g.z,g.x,g.y,g.z),p.push(1,1,0,1,0,0,1,0),v.push(4*m+0,4*m+1,4*m+2,4*m+0,4*m+2,4*m+3)}return h.setAttribute("position",new t.BufferAttribute(new Float32Array(d),3)),h.setAttribute("normal",new t.BufferAttribute(new Float32Array(f),3)),h.setAttribute("uv",new t.BufferAttribute(new Float32Array(p),2)),h.setIndex(new t.BufferAttribute(new Uint32Array(v),1)),h}},{key:"createMaterial",value:function(){var e=this._conf.particleStyle,n=e.opacity,r=e.textureURL,i=this._conf.wind,a=i.windAngle,o=i.windPower,s=new t.MeshBasicMaterial({transparent:!0,opacity:n,alphaMap:(new t.TextureLoader).load(this.mergeSourceURL(r)),map:(new t.TextureLoader).load(this.mergeSourceURL(r)),depthWrite:!1,side:t.DoubleSide}),l=this._conf.bound.size[2],u=Math.ceil(Math.tan(o*Math.PI/4)*l),c=a*Math.PI/180;return s.onBeforeCompile=function(e,n){e.vertexShader=e.vertexShader.replace("#include <common>","\n            uniform float top; // 天花板高度\n            uniform float bottom; // 地面高度\n            uniform float time; // 时间轴进度\n            uniform float disX; // x轴移动距离\n            uniform float disY; // y轴移动距离\n            #include <common>\n            float angle(float x, float y){\n              return atan(y, x);\n            }\n            // 让所有面始终朝向相机\n            vec2 getFoot(vec2 camera,vec2 normal,vec2 pos){           \n                vec2 position;\n                //  计算法向量到点的距离\n                float distanceLen = distance(pos, normal);\n                // 计算相机位置与法向量之间的夹角\n                float a = angle(camera.x - normal.x, camera.y - normal.y);\n                // 根据点的位置和法向量的位置调整90度 \n                pos.x > normal.x ? a -= 0.785 : a += 0.785; \n                // 计算投影值\n                position.x = cos(a) * distanceLen;\n                position.y = sin(a) * distanceLen;\n                \n                return position + normal;\n            }\n            "),e.vertexShader=e.vertexShader.replace("#include <begin_vertex>","\n            vec2 foot = getFoot(vec2(cameraPosition.x, cameraPosition.y),  vec2(normal.x, normal.y), vec2(position.x, position.y));\n            float height = top - bottom;\n            // 计算目标当前高度\n            float z = normal.z - bottom - height * time;\n            // 落地后重新开始，保持运动循环\n            z = z + (z < 0.0 ? height : 0.0);\n            // 利用自由落体公式计算目标高度\n            float ratio = (1.0 - z / height) * (1.0 - z / height);\n            z = height * (1.0 - ratio);\n            float y = foot.y + disY * ratio;\n            float x = foot.x + disX * ratio;\n            // 调整坐标参考值\n            z += bottom;\n            z += position.z - normal.z;\n            // 生成变换矩阵\n            vec3 transformed = vec3( x, y, z );\n            "),e.uniforms.cameraPosition={value:new t.Vector3(0,0,0)},e.uniforms.top={value:l},e.uniforms.bottom={value:0},e.uniforms.time={value:0},e.uniforms.disX={value:u*Math.sin(c)},e.uniforms.disY={value:u*Math.cos(c)},s.uniforms=e.uniforms},this._material=s,s}},{key:"update",value:function(){var t=this._conf,e=this._time,n=this._clock,r=this._material,i=this.camera;t&&(this._time=n.getElapsedTime()*t.particleStyle.speed/2%1,r.uniforms&&(r.uniforms.cameraPosition.value=i.position,r.uniforms.time.value=e))}}])}(),hr=function(){function e(t){var n;Gt(this,e);var r=qt({data:null},t);return(n=zt(this,e,[r])).initData(r.data),n}return Yt(e,ue),jt(e,[{key:"initData",value:function(t){var e=this;this._data=JSON.parse(JSON.stringify(t)),this._data.forEach((function(t){t._center=e.customCoords.lngLatToCoord(t.center)})),console.log(this._data)}},{key:"onReady",value:function(){this.createPlanes()}},{key:"createPlanes",value:function(){var t=this;this._data.forEach((function(e){t.createOnePlane(e)}))}},{key:"createOnePlane",value:(n=Bt(Jt().mark((function e(n){var r,i,a,o,s,l,u,c,h;return Jt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=n.url,i=n.size,a=n._center,o=n.altitude,s=n.rotation,e.t0=t.VideoTexture,e.next=4,this.loadVideo(r);case 4:e.t1=e.sent,(l=new e.t0(e.t1)).colorSpace=t.SRGBColorSpace,u=new t.MeshLambertMaterial({map:l,side:t.DoubleSide,transparent:!0}),c=new t.PlaneGeometry(i[0],i[1]),(h=new t.Mesh(c,u)).position.set(a[0],a[1],o),h.rotation.z=t.MathUtils.degToRad(s),this.scene.add(h);case 13:case"end":return e.stop()}}),e,this)}))),function(t){return n.apply(this,arguments)})},{key:"loadVideo",value:function(t){return new Promise((function(e,n){var r=document.createElement("video");r.src=t,r.crossOrigin="anonymous",r.loop=!0,r.muted=!0,r.addEventListener("canplay",(function(){r.play(),e(r)}),!1),r.addEventListener("error",(function(t){n(t)}),!1),r.load()}))}},{key:"update",value:function(){}}]);var n}(),dr=function(){function e(n){var r;Gt(this,e);var i=Ot.merge({zooms:[4,22],interact:!0,intensity:1,animate:!0,scale:1,colorStyle:{map:{0:"#be393a",1:"#f97f17",2:"#ffe056",3:"#2f81f7"},fieldName:null},label:{fieldName:"label",altitude:30},models:[],maxMainAltitude:1,minMainAltitude:0,mainAltitudeSpeed:1,rotateSpeed:1,traySpeed:1,PDI:!1},n);return Ht(r=zt(this,e,[i]),"_lastPickIndex",{index:null,modelId:"main"}),Ht(r,"_data",[]),Ht(r,"_group",null),Ht(r,"_models",[]),Ht(r,"_mtMap",{}),Ht(r,"_offset",0),Ht(r,"_frameX",1),Ht(r,"_currentPosition",0),Ht(r,"_moveDirection",1),Ht(r,"_currentAngle",0),Ht(r,"_maxAngle",2*Math.PI),Ht(r,"_dummy",new t.Object3D),Ht(r,"_colorMap",{}),Ht(r,"_highLightIndexArray",[]),Ht(r,"_sizeMap",{}),Ht(r,"_altitudeMap",{}),Ht(r,"_maxMainAltitude",0),Ht(r,"_minMainAltitude",0),Ht(r,"_mainAltitudeSpeed",0),Ht(r,"_instancedMeshMap",{}),Ht(r,"_resolution",0),Ht(r,"_customRendererList",[]),Ht(r,"_customRendererIds",[]),r._models=Ot.merge([{modelId:"main",name:"主体",size:1,altitude:1,sourceUrl:"./static/gltf/taper1.glb"},{modelId:"tray",name:"托盘",size:2,altitude:0,sourceUrl:"./static/gltf/taper1-p.glb"}],i.models),r.loader=null,i.data&&(r.data=i.data),r.init(),r}return Yt(e,ue),jt(e,[{key:"data",get:function(){return this._data},set:function(t){var e=this,n=t.features,r=[];if(n)this._data=n.map((function(t){var e=t.properties,n=t.geometry;return qt(qt({},e),{},{lngLat:n.coordinates})})),r=this.customCoords.lngLatsToCoords(n.map((function(t){return t.geometry.coordinates})));else{if(!Array.isArray(t))return console.error("poi3dlayer: this._data invalid"),!1;this._data=t,r=this.customCoords.lngLatsToCoords(t.map((function(t){return t.lngLat})))}this._customRendererList=[],this._customRendererIds=[],this._data.forEach((function(t,n){t.coords=r[n],t.renderer&&(e._customRendererList.push({index:n,data:t}),e._customRendererIds.push(n))})),this._data.length>0?(this.resetHeightLightIndexArray(),this.updateModel()):this.clear()}},{key:"init",value:function(){this.initColorMap(),this.refreshTransformData(),this.bindMethods(["handleContainerClick","handelViewChange","handelZoomChange"])}},{key:"beforeDestroy",value:function(){this.container&&this.container.removeEventListener("click",this.handleContainerClick),this.map&&(this.map.off("zoomchange",this.handelViewChange),this.map.off("zoomend",this.handelZoomChange))}},{key:"onRender",value:function(){}},{key:"onReady",value:(s=Bt(Jt().mark((function t(){return Jt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.updateModel();case 2:this.initMouseEvent(),this.initLight(),this.handleEvent("ready",this);case 5:case"end":return t.stop()}}),t,this)}))),function(){return s.apply(this,arguments)})},{key:"initColorMap",value:function(){var e=this,n=this._conf.colorStyle.map;this._colorMap={},Object.keys(n).forEach((function(r){e._colorMap[r]=new t.Color(n[r])}))}},{key:"handelViewChange",value:function(){this._conf.PDI&&(this.refreshTransformData(),this.updatePOIMesh())}},{key:"refreshTransformData",value:function(){var t=this,e=this._conf;this._resolution=this.getResolution()*this._conf.scale,this._models.forEach((function(e){var n=e.size,r=e.altitude,i=e.modelId;t._sizeMap[i]=3*t._resolution*(void 0!==n?n:t._conf.scale),t._altitudeMap[i]=t._resolution*r/.08})),this._maxMainAltitude=this._altitudeMap.main+e.maxMainAltitude*this._resolution/.08,this._minMainAltitude=this._altitudeMap.main+e.minMainAltitude*this._resolution/.08,this._mainAltitudeSpeed=e.mainAltitudeSpeed*this._resolution}},{key:"handelZoomChange",value:function(){this._conf.PDI,this._visible&&this.isInZooms()}},{key:"getColorByColorField",value:function(e,n){var r=this._conf.colorStyle.fieldName,i=null==r?n%Object.keys(this._colorMap).length:e[r];return this._colorMap[i]||new t.Color("#ffffff")}},{key:"initLight",value:function(){var e=this._conf.intensity,n=new t.AmbientLight(16777215,1*e);this.scene.add(n);var r=new t.DirectionalLight(16777215,1.5*e);r.position.set(1,1,1),this.scene.add(r)}},{key:"onPicked",value:function(t){var e,n,r=t.targets,i=t.event,a=null;if(r.length>0){var o=r[0].object;if(null!=o&&o.isInstancedMesh){var s=this._raycaster.intersectObject(o,!1)[0].instanceId;this.setLastPick(s),a=this._data[s],this.container.style.cursor="pointer"}}else null!==this._lastPickIndex.index&&(this.container.style.cursor="default"),this.removeLastPick();this.handleEvent("pick",{screenX:null==i||null===(e=i.pixel)||void 0===e?void 0:e.x,screenY:null==i||null===(n=i.pixel)||void 0===n?void 0:n.y,attrs:a})}},{key:"setLastPick",value:function(t){this._lastPickIndex.index=t}},{key:"removeLastPick",value:function(){var t=this._lastPickIndex.index;if(null!==t){var e=this.getMeshByModelId("main"),n=te(this._data[t].coords,2),r=n[0],i=n[1];this.updateMatrixAt(e,{size:this._sizeMap.main,position:[r,i,this._altitudeMap.main],rotation:[0,0,0]},t)}this._lastPickIndex.index=null}},{key:"loadOneModel",value:function(t,e){var n=this,r=this._models,i=t.modelId,a=t.sourceUrl;return new Promise((function(t){void 0!==(r.find((function(t){return t.modelId===i}))||{}).model?t():n.loader.load(n.mergeSourceURL(a),(function(n){var i=n.scene.children[0];r[e].model=i,t()}),(function(t){}),(function(t){console.log("loader model fail"+t)}))}))}},{key:"loadModel",value:(o=Bt(Jt().mark((function e(){var n;return Jt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:null===this.loader&&(this.loader=new ke),null===this._group&&(this._group=new t.Group,this.scene.add(this._group)),n=0;case 3:if(!(n<this._models.length)){e.next=9;break}return e.next=6,this.loadOneModel(this._models[n],n);case 6:n++,e.next=3;break;case 9:this.handleEvent("loadModelCompleted",{modelsMap:this._models});case 10:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"clearModel",value:function(){if(this._group){var t=this._group.children;do{this._group.remove(t[0])}while(t.length>0)}}},{key:"getModelConfById",value:function(t){return this._models.find((function(e){return e.modelId===t}))}},{key:"initMouseEvent",value:function(){this.container.addEventListener("click",this.handleContainerClick),this.map.on("zoomchange",this.handelViewChange),this.map.on("zoomend",this.handelZoomChange)}},{key:"handleContainerClick",value:function(t){var e=this._lastPickIndex,n=this._data;null!=e.index&&this.handleEvent("click",{screenX:null==t?void 0:t.clientX,screenY:null==t?void 0:t.clientY,attrs:n[e.index]})}},{key:"updateModel",value:(a=Bt(Jt().mark((function t(){var e,n,r;return Jt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(this.scene){t.next=2;break}return t.abrupt("return");case 2:if(!(this._data.length<=0)){t.next=5;break}return this.clear(),t.abrupt("return");case 5:return t.next=7,this.loadModel();case 7:return this.createMainMaterial(),t.next=10,this.createTrayMaterial();case 10:return t.next=12,this.createInstancedMeshes();case 12:this.clearModel(),e=this._models,n=0;case 15:if(!(n<e.length)){t.next=24;break}return t.next=18,this.updateInstancedMesh(e[n],this._data);case 18:r=t.sent,this._instancedMeshMap[e[n].modelId]=r,this._group.add(r);case 21:n++,t.next=15;break;case 24:case"end":return t.stop()}}),t,this)}))),function(){return a.apply(this,arguments)})},{key:"updateMarker",value:function(){var t=this,e=this.map,n=this._conf.label.fieldName;this._data.forEach((function(r){if(r[n]<=0||["",void 0,null].includes(r[n]))t._labelMarkers.push(null);else{var i=te(r.lngLat,2),a=i[0],o=i[1],s=new AMap.Marker({offset:[-30,-15],position:[a,o,75*t._resolution],content:'<div class="gl-label-marker" style="width: 60px; color:#fff;text-align: center;font-weight: bold;">'.concat(r[n],"</div>"),map:e});t._labelMarkers.push(s)}}))}},{key:"clearLabelMarkers",value:function(){this.map&&this.map.remove(this._labelMarkers.filter((function(t){return null!==t}))),this._labelMarkers=[]}},{key:"setLabelMarkers",value:function(t){var e=t.altitude,n=void 0===e?0:e;this._labelMarkers.filter((function(t){return null!==t})).forEach((function(t){var e=t.getPosition(),r=e.lng,i=e.lat;t.setPosition([r,i,n])}))}},{key:"createTrayMaterial",value:(i=Bt(Jt().mark((function e(){var n,r,i,a,o,s;return Jt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=new t.TextureLoader,e.next=3,n.loadAsync(this.mergeSourceURL("./static/texture/texture_wave_circle4.png"));case 3:r=e.sent,i=r.image,a=i.width,o=i.height,this._frameX=a/o,r.wrapS=r.wrapT=t.RepeatWrapping,r.repeat.set(1/this._frameX,1),s=new t.MeshStandardMaterial({color:"#ffffff",map:r,transparent:!0,opacity:.8,metalness:0,roughness:.6,depthTest:!0,depthWrite:!1}),this._mtMap.tray=s;case 10:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"createMainMaterial",value:function(){var e=this.getModelConfById("main").model.material.map,n=new t.MeshStandardMaterial({color:"#ffffff",side:t.FrontSide,transparent:!0,opacity:1,map:e});this._mtMap.main=n}},{key:"createInstancedMeshes",value:(r=Bt(Jt().mark((function e(){var n,r,i,a,o,s,l,u,c;return Jt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(n=this._models,r=this._data,i=this._mtMap,a=0;a<n.length;a++)o=n[a],s=o.model,l=o.modelId,u=i[l],(c=new t.InstancedMesh(s.geometry,u,r.length)).attrs={modelId:l},n[a].instancedMesh=c;case 2:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"updateInstancedMesh",value:(n=Bt(Jt().mark((function t(e,n){var r,i,a,o,s,l,u;return Jt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:for(r=e.instancedMesh,i=e.modelId,a=n.length,o=this._sizeMap[i],this._dummy.scale.set(o,o,o),s=0;s<a;s++)(l=n[s]).id,u=l.coords,this._dummy.position.set(u[0],u[1],this._altitudeMap[i]),this._dummy.updateMatrix(),r.setMatrixAt(s,this._dummy.matrix),r.setColorAt(s,this.getColorByColorField(n[s],s));return t.abrupt("return",r);case 6:case"end":return t.stop()}}),t,this)}))),function(t,e){return n.apply(this,arguments)})},{key:"getModelById",value:function(t){return this._group.children.find((function(e){return e._attrs.id===t}))||null}},{key:"getMeshByModelId",value:function(t){return(null==this?void 0:this._instancedMeshMap[t])||null}},{key:"clear",value:function(){this._highLightIndexArray=[],this._lastPickIndex.index=null,this.clearModel(),this.renderer&&this.renderer.clear()}},{key:"update",value:function(t){var e,n=this,r=this._conf,i=this._maxAngle,a=this._highLightIndexArray,o=this._lastPickIndex,s=this._sizeMap;if(this._isAnimate){null!=this&&null!==(e=this._mtMap)&&void 0!==e&&null!==(e=e.tray)&&void 0!==e&&e.map&&(this._offset+=.6*r.traySpeed,this._mtMap.tray.map.offset.x=Math.floor(this._offset)/this._frameX);var l=this.getMeshByModelId("main");if(l){this._currentPosition+=this._moveDirection*this._mainAltitudeSpeed,this._currentPosition>=this._maxMainAltitude?(this._currentPosition=this._maxMainAltitude,this._moveDirection*=-1):this._currentPosition<=this._minMainAltitude&&(this._currentPosition=this._minMainAltitude,this._moveDirection*=-1),this._customRendererList.forEach((function(t){var e=t.data.renderer(Object.assign(r,{size:s.main,altitude:n._altitudeMap}));n.updateMatrixAt(l,e,t.index)})),this._currentAngle=(this._currentAngle+.05*r.rotateSpeed)%i;for(var u=0;u<a.length;u++){var c=a[u];if(!this._customRendererIds.includes(c)){var h=te(this._data[c].coords,2),d=h[0],f=h[1];this.updateMatrixAt(l,{size:s.main,position:[d,f,this._currentPosition],rotation:[0,0,this._currentAngle]},c)}}if(null!==o.index&&!this._customRendererIds.includes(o.index)){var p=te(this._data[o.index].coords,2),v=p[0],m=p[1];this.updateMatrixAt(l,{size:1.2*s.main,position:[v,m,this._currentPosition],rotation:[0,0,this._currentAngle]},o.index)}null!=l&&l.instanceMatrix&&(l.instanceMatrix.needsUpdate=!0)}}}},{key:"updatePOIMesh",value:function(){var t,e=this._sizeMap,n=this.getMeshByModelId("main"),r=this.getMeshByModelId("tray");null!=this&&null!==(t=this._mtMap)&&void 0!==t&&null!==(t=t.tray)&&void 0!==t&&t.map&&(this._mtMap.tray.map.offset.x=0),this._currentPosition=0;for(var i=0;i<this._data.length;i++){var a=te(this._data[i].coords,2),o=a[0],s=a[1];this.updateMatrixAt(n,{size:e.main,position:[o,s,this._altitudeMap.main+this.getRandomValue()],rotation:[0,0,0]},i),this.updateMatrixAt(r,{size:e.tray,position:[o,s,this._altitudeMap.tray+this.getRandomValue()],rotation:[0,0,0]},i)}null!=n&&n.instanceMatrix&&(n.instanceMatrix.needsUpdate=!0),null!=r&&r.instanceMatrix&&(r.instanceMatrix.needsUpdate=!0)}},{key:"getRandomValue",value:function(){return 2*Math.random()-1}},{key:"resetHeightLightIndexArray",value:function(){var t=this._highLightIndexArray;if(t.length>0)for(var e=this.getMeshByModelId("main"),n=this.getModelConfById("main").altitude,r=0;r<t.length;r++){var i=te(this._data[r].coords,2),a=i[0],o=i[1];this.updateMatrixAt(e,{size:this._sizeMap.main,position:[a,o,n],rotation:[0,0,0]},r)}this._highLightIndexArray=[]}},{key:"updateMatrixAt",value:function(t,e,n){if(t){var r=e.size,i=e.position,a=e.rotation,o=this._dummy;o.scale.set(r,r,r),o.position.set(i[0],i[1],i[2]),o.rotation.x=a[0],o.rotation.y=a[1],o.rotation.z=a[2],o.updateMatrix(),t.setMatrixAt(n,o.matrix)}}},{key:"lightUp",value:function(t){var e=this,n=t.map((function(t){return e._data.findIndex((function(e){return e.id===t}))}));this._highLightIndexArray=Ot.union(this._highLightIndexArray,Ot.without(n,-1))}},{key:"lightOff",value:function(t){var e=this,n=t.map((function(t){return e._data.findIndex((function(e){return e.id===t}))}));this._highLightIndexArray=Ot.difference(this._highLightIndexArray,n)}},{key:"switchLight",value:function(t){var e=this._data.findIndex((function(e){return e.id===t}));this._highLightIndexArray.includes(e)?this.lightOff([t]):this.lightUp([t])}},{key:"lightUpAll",value:function(){}},{key:"lightOffAll",value:function(){}}]);var n,r,i,a,o,s}();const fr={name:"CopyShader",uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform float opacity;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\t\t\tgl_FragColor = opacity * texel;\n\n\n\t\t}"};class pr{constructor(){this.isPass=!0,this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1}setSize(){}render(){console.error("THREE.Pass: .render() must be implemented in derived pass.")}dispose(){}}const vr=new W(-1,1,1,-1,0,1),mr=new e;mr.setAttribute("position",new dt([-1,3,0,-1,-1,0,3,-1,0],3)),mr.setAttribute("uv",new dt([0,2,0,0,2,0],2));class gr{constructor(t){this._mesh=new U(mr,t)}dispose(){this._mesh.geometry.dispose()}render(t){t.render(this._mesh,vr)}get material(){return this._mesh.material}set material(t){this._mesh.material=t}}class yr extends pr{constructor(t,e){super(),this.textureID=void 0!==e?e:"tDiffuse",t instanceof ft?(this.uniforms=t.uniforms,this.material=t):t&&(this.uniforms=pt.clone(t.uniforms),this.material=new ft({name:void 0!==t.name?t.name:"unspecified",defines:Object.assign({},t.defines),uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader})),this.fsQuad=new gr(this.material)}render(t,e,n){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=n.texture),this.fsQuad.material=this.material,this.renderToScreen?(t.setRenderTarget(null),this.fsQuad.render(t)):(t.setRenderTarget(e),this.clear&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),this.fsQuad.render(t))}dispose(){this.material.dispose(),this.fsQuad.dispose()}}class _r extends pr{constructor(t,e){super(),this.scene=t,this.camera=e,this.clear=!0,this.needsSwap=!1,this.inverse=!1}render(t,e,n){const r=t.getContext(),i=t.state;let a,o;i.buffers.color.setMask(!1),i.buffers.depth.setMask(!1),i.buffers.color.setLocked(!0),i.buffers.depth.setLocked(!0),this.inverse?(a=0,o=1):(a=1,o=0),i.buffers.stencil.setTest(!0),i.buffers.stencil.setOp(r.REPLACE,r.REPLACE,r.REPLACE),i.buffers.stencil.setFunc(r.ALWAYS,a,4294967295),i.buffers.stencil.setClear(o),i.buffers.stencil.setLocked(!0),t.setRenderTarget(n),this.clear&&t.clear(),t.render(this.scene,this.camera),t.setRenderTarget(e),this.clear&&t.clear(),t.render(this.scene,this.camera),i.buffers.color.setLocked(!1),i.buffers.depth.setLocked(!1),i.buffers.color.setMask(!0),i.buffers.depth.setMask(!0),i.buffers.stencil.setLocked(!1),i.buffers.stencil.setFunc(r.EQUAL,1,4294967295),i.buffers.stencil.setOp(r.KEEP,r.KEEP,r.KEEP),i.buffers.stencil.setLocked(!0)}}class xr extends pr{constructor(){super(),this.needsSwap=!1}render(t){t.state.buffers.stencil.setLocked(!1),t.state.buffers.stencil.setTest(!1)}}class wr{constructor(t,e){if(this.renderer=t,this._pixelRatio=t.getPixelRatio(),void 0===e){const n=t.getSize(new g);this._width=n.width,this._height=n.height,(e=new vt(this._width*this._pixelRatio,this._height*this._pixelRatio,{type:mt})).texture.name="EffectComposer.rt1"}else this._width=e.width,this._height=e.height;this.renderTarget1=e,this.renderTarget2=e.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.renderToScreen=!0,this.passes=[],this.copyPass=new yr(fr),this.copyPass.material.blending=gt,this.clock=new yt}swapBuffers(){const t=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=t}addPass(t){this.passes.push(t),t.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}insertPass(t,e){this.passes.splice(e,0,t),t.setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}removePass(t){const e=this.passes.indexOf(t);-1!==e&&this.passes.splice(e,1)}isLastEnabledPass(t){for(let e=t+1;e<this.passes.length;e++)if(this.passes[e].enabled)return!1;return!0}render(t){void 0===t&&(t=this.clock.getDelta());const e=this.renderer.getRenderTarget();let n=!1;for(let e=0,r=this.passes.length;e<r;e++){const r=this.passes[e];if(!1!==r.enabled){if(r.renderToScreen=this.renderToScreen&&this.isLastEnabledPass(e),r.render(this.renderer,this.writeBuffer,this.readBuffer,t,n),r.needsSwap){if(n){const e=this.renderer.getContext(),n=this.renderer.state.buffers.stencil;n.setFunc(e.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,t),n.setFunc(e.EQUAL,1,4294967295)}this.swapBuffers()}void 0!==_r&&(r instanceof _r?n=!0:r instanceof xr&&(n=!1))}}this.renderer.setRenderTarget(e)}reset(t){if(void 0===t){const e=this.renderer.getSize(new g);this._pixelRatio=this.renderer.getPixelRatio(),this._width=e.width,this._height=e.height,(t=this.renderTarget1.clone()).setSize(this._width*this._pixelRatio,this._height*this._pixelRatio)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=t,this.renderTarget2=t.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2}setSize(t,e){this._width=t,this._height=e;const n=this._width*this._pixelRatio,r=this._height*this._pixelRatio;this.renderTarget1.setSize(n,r),this.renderTarget2.setSize(n,r);for(let t=0;t<this.passes.length;t++)this.passes[t].setSize(n,r)}setPixelRatio(t){this._pixelRatio=t,this.setSize(this._width,this._height)}dispose(){this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.copyPass.dispose()}}class br extends pr{constructor(t,e,n=null,r=null,i=null){super(),this.scene=t,this.camera=e,this.overrideMaterial=n,this.clearColor=r,this.clearAlpha=i,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1,this._oldClearColor=new u}render(t,e,n){const r=t.autoClear;let i,a;t.autoClear=!1,null!==this.overrideMaterial&&(a=this.scene.overrideMaterial,this.scene.overrideMaterial=this.overrideMaterial),null!==this.clearColor&&(t.getClearColor(this._oldClearColor),t.setClearColor(this.clearColor)),null!==this.clearAlpha&&(i=t.getClearAlpha(),t.setClearAlpha(this.clearAlpha)),1==this.clearDepth&&t.clearDepth(),t.setRenderTarget(this.renderToScreen?null:n),!0===this.clear&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),t.render(this.scene,this.camera),null!==this.clearColor&&t.setClearColor(this._oldClearColor),null!==this.clearAlpha&&t.setClearAlpha(i),null!==this.overrideMaterial&&(this.scene.overrideMaterial=a),t.autoClear=r}}const Ar={shaderID:"luminosityHighPass",uniforms:{tDiffuse:{value:null},luminosityThreshold:{value:1},smoothWidth:{value:1},defaultColor:{value:new u(0)},defaultOpacity:{value:0}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\n\t\tuniform sampler2D tDiffuse;\n\t\tuniform vec3 defaultColor;\n\t\tuniform float defaultOpacity;\n\t\tuniform float luminosityThreshold;\n\t\tuniform float smoothWidth;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvec4 texel = texture2D( tDiffuse, vUv );\n\n\t\t\tvec3 luma = vec3( 0.299, 0.587, 0.114 );\n\n\t\t\tfloat v = dot( texel.xyz, luma );\n\n\t\t\tvec4 outputColor = vec4( defaultColor.rgb, defaultOpacity );\n\n\t\t\tfloat alpha = smoothstep( luminosityThreshold, luminosityThreshold + smoothWidth, v );\n\n\t\t\tgl_FragColor = mix( outputColor, texel, alpha );\n\n\t\t}"};class Mr extends pr{constructor(t,e,n,r){super(),this.strength=void 0!==e?e:1,this.radius=n,this.threshold=r,this.resolution=void 0!==t?new g(t.x,t.y):new g(256,256),this.clearColor=new u(0,0,0),this.renderTargetsHorizontal=[],this.renderTargetsVertical=[],this.nMips=5;let i=Math.round(this.resolution.x/2),a=Math.round(this.resolution.y/2);this.renderTargetBright=new vt(i,a,{type:mt}),this.renderTargetBright.texture.name="UnrealBloomPass.bright",this.renderTargetBright.texture.generateMipmaps=!1;for(let t=0;t<this.nMips;t++){const e=new vt(i,a,{type:mt});e.texture.name="UnrealBloomPass.h"+t,e.texture.generateMipmaps=!1,this.renderTargetsHorizontal.push(e);const n=new vt(i,a,{type:mt});n.texture.name="UnrealBloomPass.v"+t,n.texture.generateMipmaps=!1,this.renderTargetsVertical.push(n),i=Math.round(i/2),a=Math.round(a/2)}const o=Ar;this.highPassUniforms=pt.clone(o.uniforms),this.highPassUniforms.luminosityThreshold.value=r,this.highPassUniforms.smoothWidth.value=.01,this.materialHighPassFilter=new ft({uniforms:this.highPassUniforms,vertexShader:o.vertexShader,fragmentShader:o.fragmentShader}),this.separableBlurMaterials=[];const s=[3,5,7,9,11];i=Math.round(this.resolution.x/2),a=Math.round(this.resolution.y/2);for(let t=0;t<this.nMips;t++)this.separableBlurMaterials.push(this.getSeperableBlurMaterial(s[t])),this.separableBlurMaterials[t].uniforms.invSize.value=new g(1/i,1/a),i=Math.round(i/2),a=Math.round(a/2);this.compositeMaterial=this.getCompositeMaterial(this.nMips),this.compositeMaterial.uniforms.blurTexture1.value=this.renderTargetsVertical[0].texture,this.compositeMaterial.uniforms.blurTexture2.value=this.renderTargetsVertical[1].texture,this.compositeMaterial.uniforms.blurTexture3.value=this.renderTargetsVertical[2].texture,this.compositeMaterial.uniforms.blurTexture4.value=this.renderTargetsVertical[3].texture,this.compositeMaterial.uniforms.blurTexture5.value=this.renderTargetsVertical[4].texture,this.compositeMaterial.uniforms.bloomStrength.value=e,this.compositeMaterial.uniforms.bloomRadius.value=.1;this.compositeMaterial.uniforms.bloomFactors.value=[1,.8,.6,.4,.2],this.bloomTintColors=[new _(1,1,1),new _(1,1,1),new _(1,1,1),new _(1,1,1),new _(1,1,1)],this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors;const l=fr;this.copyUniforms=pt.clone(l.uniforms),this.blendMaterial=new ft({uniforms:this.copyUniforms,vertexShader:l.vertexShader,fragmentShader:l.fragmentShader,blending:_t,depthTest:!1,depthWrite:!1,transparent:!0}),this.enabled=!0,this.needsSwap=!1,this._oldClearColor=new u,this.oldClearAlpha=1,this.basic=new p,this.fsQuad=new gr(null)}dispose(){for(let t=0;t<this.renderTargetsHorizontal.length;t++)this.renderTargetsHorizontal[t].dispose();for(let t=0;t<this.renderTargetsVertical.length;t++)this.renderTargetsVertical[t].dispose();this.renderTargetBright.dispose();for(let t=0;t<this.separableBlurMaterials.length;t++)this.separableBlurMaterials[t].dispose();this.compositeMaterial.dispose(),this.blendMaterial.dispose(),this.basic.dispose(),this.fsQuad.dispose()}setSize(t,e){let n=Math.round(t/2),r=Math.round(e/2);this.renderTargetBright.setSize(n,r);for(let t=0;t<this.nMips;t++)this.renderTargetsHorizontal[t].setSize(n,r),this.renderTargetsVertical[t].setSize(n,r),this.separableBlurMaterials[t].uniforms.invSize.value=new g(1/n,1/r),n=Math.round(n/2),r=Math.round(r/2)}render(t,e,n,r,i){t.getClearColor(this._oldClearColor),this.oldClearAlpha=t.getClearAlpha();const a=t.autoClear;t.autoClear=!1,t.setClearColor(this.clearColor,0),i&&t.state.buffers.stencil.setTest(!1),this.renderToScreen&&(this.fsQuad.material=this.basic,this.basic.map=n.texture,t.setRenderTarget(null),t.clear(),this.fsQuad.render(t)),this.highPassUniforms.tDiffuse.value=n.texture,this.highPassUniforms.luminosityThreshold.value=this.threshold,this.fsQuad.material=this.materialHighPassFilter,t.setRenderTarget(this.renderTargetBright),t.clear(),this.fsQuad.render(t);let o=this.renderTargetBright;for(let e=0;e<this.nMips;e++)this.fsQuad.material=this.separableBlurMaterials[e],this.separableBlurMaterials[e].uniforms.colorTexture.value=o.texture,this.separableBlurMaterials[e].uniforms.direction.value=Mr.BlurDirectionX,t.setRenderTarget(this.renderTargetsHorizontal[e]),t.clear(),this.fsQuad.render(t),this.separableBlurMaterials[e].uniforms.colorTexture.value=this.renderTargetsHorizontal[e].texture,this.separableBlurMaterials[e].uniforms.direction.value=Mr.BlurDirectionY,t.setRenderTarget(this.renderTargetsVertical[e]),t.clear(),this.fsQuad.render(t),o=this.renderTargetsVertical[e];this.fsQuad.material=this.compositeMaterial,this.compositeMaterial.uniforms.bloomStrength.value=this.strength,this.compositeMaterial.uniforms.bloomRadius.value=this.radius,this.compositeMaterial.uniforms.bloomTintColors.value=this.bloomTintColors,t.setRenderTarget(this.renderTargetsHorizontal[0]),t.clear(),this.fsQuad.render(t),this.fsQuad.material=this.blendMaterial,this.copyUniforms.tDiffuse.value=this.renderTargetsHorizontal[0].texture,i&&t.state.buffers.stencil.setTest(!0),this.renderToScreen?(t.setRenderTarget(null),this.fsQuad.render(t)):(t.setRenderTarget(n),this.fsQuad.render(t)),t.setClearColor(this._oldClearColor,this.oldClearAlpha),t.autoClear=a}getSeperableBlurMaterial(t){const e=[];for(let n=0;n<t;n++)e.push(.39894*Math.exp(-.5*n*n/(t*t))/t);return new ft({defines:{KERNEL_RADIUS:t},uniforms:{colorTexture:{value:null},invSize:{value:new g(.5,.5)},direction:{value:new g(.5,.5)},gaussianCoefficients:{value:e}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <common>\n\t\t\t\tvarying vec2 vUv;\n\t\t\t\tuniform sampler2D colorTexture;\n\t\t\t\tuniform vec2 invSize;\n\t\t\t\tuniform vec2 direction;\n\t\t\t\tuniform float gaussianCoefficients[KERNEL_RADIUS];\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tfloat weightSum = gaussianCoefficients[0];\n\t\t\t\t\tvec3 diffuseSum = texture2D( colorTexture, vUv ).rgb * weightSum;\n\t\t\t\t\tfor( int i = 1; i < KERNEL_RADIUS; i ++ ) {\n\t\t\t\t\t\tfloat x = float(i);\n\t\t\t\t\t\tfloat w = gaussianCoefficients[i];\n\t\t\t\t\t\tvec2 uvOffset = direction * invSize * x;\n\t\t\t\t\t\tvec3 sample1 = texture2D( colorTexture, vUv + uvOffset ).rgb;\n\t\t\t\t\t\tvec3 sample2 = texture2D( colorTexture, vUv - uvOffset ).rgb;\n\t\t\t\t\t\tdiffuseSum += (sample1 + sample2) * w;\n\t\t\t\t\t\tweightSum += 2.0 * w;\n\t\t\t\t\t}\n\t\t\t\t\tgl_FragColor = vec4(diffuseSum/weightSum, 1.0);\n\t\t\t\t}"})}getCompositeMaterial(t){return new ft({defines:{NUM_MIPS:t},uniforms:{blurTexture1:{value:null},blurTexture2:{value:null},blurTexture3:{value:null},blurTexture4:{value:null},blurTexture5:{value:null},bloomStrength:{value:1},bloomFactors:{value:null},bloomTintColors:{value:null},bloomRadius:{value:0}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\n\t\t\t\tuniform sampler2D blurTexture1;\n\t\t\t\tuniform sampler2D blurTexture2;\n\t\t\t\tuniform sampler2D blurTexture3;\n\t\t\t\tuniform sampler2D blurTexture4;\n\t\t\t\tuniform sampler2D blurTexture5;\n\t\t\t\tuniform float bloomStrength;\n\t\t\t\tuniform float bloomRadius;\n\t\t\t\tuniform float bloomFactors[NUM_MIPS];\n\t\t\t\tuniform vec3 bloomTintColors[NUM_MIPS];\n\n\t\t\t\tfloat lerpBloomFactor(const in float factor) {\n\t\t\t\t\tfloat mirrorFactor = 1.2 - factor;\n\t\t\t\t\treturn mix(factor, mirrorFactor, bloomRadius);\n\t\t\t\t}\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tgl_FragColor = bloomStrength * ( lerpBloomFactor(bloomFactors[0]) * vec4(bloomTintColors[0], 1.0) * texture2D(blurTexture1, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[1]) * vec4(bloomTintColors[1], 1.0) * texture2D(blurTexture2, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[2]) * vec4(bloomTintColors[2], 1.0) * texture2D(blurTexture3, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[3]) * vec4(bloomTintColors[3], 1.0) * texture2D(blurTexture4, vUv) +\n\t\t\t\t\t\tlerpBloomFactor(bloomFactors[4]) * vec4(bloomTintColors[4], 1.0) * texture2D(blurTexture5, vUv) );\n\t\t\t\t}"})}}Mr.BlurDirectionX=new g(1,0),Mr.BlurDirectionY=new g(0,1);var Tr=function(){function e(t,n,r,i){return Gt(this,e),zt(this,e,[t,n,r,i])}return Yt(e,Mr),jt(e,[{key:"getSeperableBlurMaterial",value:function(e){for(var n=[],r=0;r<e;r++)n.push(.39894*Math.exp(-.5*r*r/(e*e))/e);return new t.ShaderMaterial({defines:{KERNEL_RADIUS:e},uniforms:{colorTexture:{value:null},invSize:{value:new t.Vector2(.5,.5)},direction:{value:new t.Vector2(.5,.5)},gaussianCoefficients:{value:n}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"#include <common>\n\t\t\t\tvarying vec2 vUv;\n\t\t\t\tuniform sampler2D colorTexture;\n\t\t\t\tuniform vec2 invSize;\n\t\t\t\tuniform vec2 direction;\n\t\t\t\tuniform float gaussianCoefficients[KERNEL_RADIUS];\n\n\t\t\t\tvoid main() {\n\t\t\t\t\tfloat weightSum = gaussianCoefficients[0];\n\t\t\t\t\tvec3 diffuseSum = texture2D( colorTexture, vUv ).rgb * weightSum;\n\t\t\t\t\tfloat alphaSum;\n\t\t\t\t\tfor( int i = 1; i < KERNEL_RADIUS; i ++ ) {\n\t\t\t\t\t\tfloat x = float(i);\n\t\t\t\t\t\tfloat w = gaussianCoefficients[i];\n\t\t\t\t\t\tvec2 uvOffset = direction * invSize * x;\n\t\t\t\t\t\tvec4 sample1 = texture2D( colorTexture, vUv + uvOffset );\n\t\t\t\t\t\tvec4 sample2 = texture2D( colorTexture, vUv - uvOffset );\n\t\t\t\t\t\tdiffuseSum += (sample1.rgb + sample2.rgb) * w;\n\t\t\t\t\t\talphaSum += (sample1.a + sample2.a) * w; //\n\t\t\t\t\t\tweightSum += 2.0 * w;\n\t\t\t\t\t}\n\t\t\t\t\t//gyrate: overwrite this line for alpha pass\n\t\t\t\t\t//gl_FragColor = vec4(diffuseSum/weightSum, 1.0);\n\t\t\t\t\tgl_FragColor = vec4(diffuseSum/weightSum, alphaSum/weightSum);\n\t\t\t\t}"})}}])}();const Sr={uniforms:{tDiffuse:{value:null},toneMappingExposure:{value:1}},vertexShader:"\n\t\tprecision highp float;\n\n\t\tuniform mat4 modelViewMatrix;\n\t\tuniform mat4 projectionMatrix;\n\n\t\tattribute vec3 position;\n\t\tattribute vec2 uv;\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\t\n\t\tprecision highp float;\n\n\t\tuniform sampler2D tDiffuse;\n\n\t\t"+xt.tonemapping_pars_fragment+xt.colorspace_pars_fragment+"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tgl_FragColor = texture2D( tDiffuse, vUv );\n\n\t\t\t// tone mapping\n\n\t\t\t#ifdef LINEAR_TONE_MAPPING\n\n\t\t\t\tgl_FragColor.rgb = LinearToneMapping( gl_FragColor.rgb );\n\n\t\t\t#elif defined( REINHARD_TONE_MAPPING )\n\n\t\t\t\tgl_FragColor.rgb = ReinhardToneMapping( gl_FragColor.rgb );\n\n\t\t\t#elif defined( CINEON_TONE_MAPPING )\n\n\t\t\t\tgl_FragColor.rgb = OptimizedCineonToneMapping( gl_FragColor.rgb );\n\n\t\t\t#elif defined( ACES_FILMIC_TONE_MAPPING )\n\n\t\t\t\tgl_FragColor.rgb = ACESFilmicToneMapping( gl_FragColor.rgb );\n\n\t\t\t#endif\n\n\t\t\t// color space\n\n\t\t\t#ifdef SRGB_TRANSFER\n\n\t\t\t\tgl_FragColor = sRGBTransferOETF( gl_FragColor );\n\n\t\t\t#endif\n\n\t\t}"};class kr extends pr{constructor(){super();const t=Sr;this.uniforms=pt.clone(t.uniforms),this.material=new wt({uniforms:this.uniforms,vertexShader:t.vertexShader,fragmentShader:t.fragmentShader}),this.fsQuad=new gr(this.material),this._outputColorSpace=null,this._toneMapping=null}render(t,e,n){this.uniforms.tDiffuse.value=n.texture,this.uniforms.toneMappingExposure.value=t.toneMappingExposure,this._outputColorSpace===t.outputColorSpace&&this._toneMapping===t.toneMapping||(this._outputColorSpace=t.outputColorSpace,this._toneMapping=t.toneMapping,this.material.defines={},q.getTransfer(this._outputColorSpace)===bt&&(this.material.defines.SRGB_TRANSFER=""),this._toneMapping===At?this.material.defines.LINEAR_TONE_MAPPING="":this._toneMapping===Mt?this.material.defines.REINHARD_TONE_MAPPING="":this._toneMapping===Tt?this.material.defines.CINEON_TONE_MAPPING="":this._toneMapping===St&&(this.material.defines.ACES_FILMIC_TONE_MAPPING=""),this.material.needsUpdate=!0),!0===this.renderToScreen?(t.setRenderTarget(null),this.fsQuad.render(t)):(t.setRenderTarget(e),this.clear&&t.clear(t.autoClearColor,t.autoClearDepth,t.autoClearStencil),this.fsQuad.render(t))}dispose(){this.material.dispose(),this.fsQuad.dispose()}}const Cr={uniforms:{tDiffuse:{value:null},resolution:{value:new g(1/1024,1/512)}},vertexShader:"\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\tvUv = uv;\n\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\n\t\t}",fragmentShader:"\n\tprecision highp float;\n\n\tuniform sampler2D tDiffuse;\n\n\tuniform vec2 resolution;\n\n\tvarying vec2 vUv;\n\n\t// FXAA 3.11 implementation by NVIDIA, ported to WebGL by Agost Biro (biro@archilogic.com)\n\n\t//----------------------------------------------------------------------------------\n\t// File:        es3-keplerFXAAassetsshaders/FXAA_DefaultES.frag\n\t// SDK Version: v3.00\n\t// Email:       gameworks@nvidia.com\n\t// Site:        http://developer.nvidia.com/\n\t//\n\t// Copyright (c) 2014-2015, NVIDIA CORPORATION. All rights reserved.\n\t//\n\t// Redistribution and use in source and binary forms, with or without\n\t// modification, are permitted provided that the following conditions\n\t// are met:\n\t//  * Redistributions of source code must retain the above copyright\n\t//    notice, this list of conditions and the following disclaimer.\n\t//  * Redistributions in binary form must reproduce the above copyright\n\t//    notice, this list of conditions and the following disclaimer in the\n\t//    documentation and/or other materials provided with the distribution.\n\t//  * Neither the name of NVIDIA CORPORATION nor the names of its\n\t//    contributors may be used to endorse or promote products derived\n\t//    from this software without specific prior written permission.\n\t//\n\t// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS ''AS IS'' AND ANY\n\t// EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE\n\t// IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR\n\t// PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR\n\t// CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,\n\t// EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,\n\t// PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR\n\t// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY\n\t// OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT\n\t// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE\n\t// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.\n\t//\n\t//----------------------------------------------------------------------------------\n\n\t#ifndef FXAA_DISCARD\n\t\t\t//\n\t\t\t// Only valid for PC OpenGL currently.\n\t\t\t// Probably will not work when FXAA_GREEN_AS_LUMA = 1.\n\t\t\t//\n\t\t\t// 1 = Use discard on pixels which don't need AA.\n\t\t\t//     For APIs which enable concurrent TEX+ROP from same surface.\n\t\t\t// 0 = Return unchanged color on pixels which don't need AA.\n\t\t\t//\n\t\t\t#define FXAA_DISCARD 0\n\t#endif\n\n\t/*--------------------------------------------------------------------------*/\n\t#define FxaaTexTop(t, p) texture2D(t, p, -100.0)\n\t#define FxaaTexOff(t, p, o, r) texture2D(t, p + (o * r), -100.0)\n\t/*--------------------------------------------------------------------------*/\n\n\t#define NUM_SAMPLES 5\n\n\t// assumes colors have premultipliedAlpha, so that the calculated color contrast is scaled by alpha\n\tfloat contrast( vec4 a, vec4 b ) {\n\t\t\tvec4 diff = abs( a - b );\n\t\t\treturn max( max( max( diff.r, diff.g ), diff.b ), diff.a );\n\t}\n\n\t/*============================================================================\n\n\t\t\t\t\t\t\t\t\tFXAA3 QUALITY - PC\n\n\t============================================================================*/\n\n\t/*--------------------------------------------------------------------------*/\n\tvec4 FxaaPixelShader(\n\t\t\tvec2 posM,\n\t\t\tsampler2D tex,\n\t\t\tvec2 fxaaQualityRcpFrame,\n\t\t\tfloat fxaaQualityEdgeThreshold,\n\t\t\tfloat fxaaQualityinvEdgeThreshold\n\t) {\n\t\t\tvec4 rgbaM = FxaaTexTop(tex, posM);\n\t\t\tvec4 rgbaS = FxaaTexOff(tex, posM, vec2( 0.0, 1.0), fxaaQualityRcpFrame.xy);\n\t\t\tvec4 rgbaE = FxaaTexOff(tex, posM, vec2( 1.0, 0.0), fxaaQualityRcpFrame.xy);\n\t\t\tvec4 rgbaN = FxaaTexOff(tex, posM, vec2( 0.0,-1.0), fxaaQualityRcpFrame.xy);\n\t\t\tvec4 rgbaW = FxaaTexOff(tex, posM, vec2(-1.0, 0.0), fxaaQualityRcpFrame.xy);\n\t\t\t// . S .\n\t\t\t// W M E\n\t\t\t// . N .\n\n\t\t\tbool earlyExit = max( max( max(\n\t\t\t\t\tcontrast( rgbaM, rgbaN ),\n\t\t\t\t\tcontrast( rgbaM, rgbaS ) ),\n\t\t\t\t\tcontrast( rgbaM, rgbaE ) ),\n\t\t\t\t\tcontrast( rgbaM, rgbaW ) )\n\t\t\t\t\t< fxaaQualityEdgeThreshold;\n\t\t\t// . 0 .\n\t\t\t// 0 0 0\n\t\t\t// . 0 .\n\n\t\t\t#if (FXAA_DISCARD == 1)\n\t\t\t\t\tif(earlyExit) FxaaDiscard;\n\t\t\t#else\n\t\t\t\t\tif(earlyExit) return rgbaM;\n\t\t\t#endif\n\n\t\t\tfloat contrastN = contrast( rgbaM, rgbaN );\n\t\t\tfloat contrastS = contrast( rgbaM, rgbaS );\n\t\t\tfloat contrastE = contrast( rgbaM, rgbaE );\n\t\t\tfloat contrastW = contrast( rgbaM, rgbaW );\n\n\t\t\tfloat relativeVContrast = ( contrastN + contrastS ) - ( contrastE + contrastW );\n\t\t\trelativeVContrast *= fxaaQualityinvEdgeThreshold;\n\n\t\t\tbool horzSpan = relativeVContrast > 0.;\n\t\t\t// . 1 .\n\t\t\t// 0 0 0\n\t\t\t// . 1 .\n\n\t\t\t// 45 deg edge detection and corners of objects, aka V/H contrast is too similar\n\t\t\tif( abs( relativeVContrast ) < .3 ) {\n\t\t\t\t\t// locate the edge\n\t\t\t\t\tvec2 dirToEdge;\n\t\t\t\t\tdirToEdge.x = contrastE > contrastW ? 1. : -1.;\n\t\t\t\t\tdirToEdge.y = contrastS > contrastN ? 1. : -1.;\n\t\t\t\t\t// . 2 .      . 1 .\n\t\t\t\t\t// 1 0 2  ~=  0 0 1\n\t\t\t\t\t// . 1 .      . 0 .\n\n\t\t\t\t\t// tap 2 pixels and see which ones are \"outside\" the edge, to\n\t\t\t\t\t// determine if the edge is vertical or horizontal\n\n\t\t\t\t\tvec4 rgbaAlongH = FxaaTexOff(tex, posM, vec2( dirToEdge.x, -dirToEdge.y ), fxaaQualityRcpFrame.xy);\n\t\t\t\t\tfloat matchAlongH = contrast( rgbaM, rgbaAlongH );\n\t\t\t\t\t// . 1 .\n\t\t\t\t\t// 0 0 1\n\t\t\t\t\t// . 0 H\n\n\t\t\t\t\tvec4 rgbaAlongV = FxaaTexOff(tex, posM, vec2( -dirToEdge.x, dirToEdge.y ), fxaaQualityRcpFrame.xy);\n\t\t\t\t\tfloat matchAlongV = contrast( rgbaM, rgbaAlongV );\n\t\t\t\t\t// V 1 .\n\t\t\t\t\t// 0 0 1\n\t\t\t\t\t// . 0 .\n\n\t\t\t\t\trelativeVContrast = matchAlongV - matchAlongH;\n\t\t\t\t\trelativeVContrast *= fxaaQualityinvEdgeThreshold;\n\n\t\t\t\t\tif( abs( relativeVContrast ) < .3 ) { // 45 deg edge\n\t\t\t\t\t\t\t// 1 1 .\n\t\t\t\t\t\t\t// 0 0 1\n\t\t\t\t\t\t\t// . 0 1\n\n\t\t\t\t\t\t\t// do a simple blur\n\t\t\t\t\t\t\treturn mix(\n\t\t\t\t\t\t\t\t\trgbaM,\n\t\t\t\t\t\t\t\t\t(rgbaN + rgbaS + rgbaE + rgbaW) * .25,\n\t\t\t\t\t\t\t\t\t.4\n\t\t\t\t\t\t\t);\n\t\t\t\t\t}\n\n\t\t\t\t\thorzSpan = relativeVContrast > 0.;\n\t\t\t}\n\n\t\t\tif(!horzSpan) rgbaN = rgbaW;\n\t\t\tif(!horzSpan) rgbaS = rgbaE;\n\t\t\t// . 0 .      1\n\t\t\t// 1 0 1  ->  0\n\t\t\t// . 0 .      1\n\n\t\t\tbool pairN = contrast( rgbaM, rgbaN ) > contrast( rgbaM, rgbaS );\n\t\t\tif(!pairN) rgbaN = rgbaS;\n\n\t\t\tvec2 offNP;\n\t\t\toffNP.x = (!horzSpan) ? 0.0 : fxaaQualityRcpFrame.x;\n\t\t\toffNP.y = ( horzSpan) ? 0.0 : fxaaQualityRcpFrame.y;\n\n\t\t\tbool doneN = false;\n\t\t\tbool doneP = false;\n\n\t\t\tfloat nDist = 0.;\n\t\t\tfloat pDist = 0.;\n\n\t\t\tvec2 posN = posM;\n\t\t\tvec2 posP = posM;\n\n\t\t\tint iterationsUsed = 0;\n\t\t\tint iterationsUsedN = 0;\n\t\t\tint iterationsUsedP = 0;\n\t\t\tfor( int i = 0; i < NUM_SAMPLES; i++ ) {\n\t\t\t\t\titerationsUsed = i;\n\n\t\t\t\t\tfloat increment = float(i + 1);\n\n\t\t\t\t\tif(!doneN) {\n\t\t\t\t\t\t\tnDist += increment;\n\t\t\t\t\t\t\tposN = posM + offNP * nDist;\n\t\t\t\t\t\t\tvec4 rgbaEndN = FxaaTexTop(tex, posN.xy);\n\t\t\t\t\t\t\tdoneN = contrast( rgbaEndN, rgbaM ) > contrast( rgbaEndN, rgbaN );\n\t\t\t\t\t\t\titerationsUsedN = i;\n\t\t\t\t\t}\n\n\t\t\t\t\tif(!doneP) {\n\t\t\t\t\t\t\tpDist += increment;\n\t\t\t\t\t\t\tposP = posM - offNP * pDist;\n\t\t\t\t\t\t\tvec4 rgbaEndP = FxaaTexTop(tex, posP.xy);\n\t\t\t\t\t\t\tdoneP = contrast( rgbaEndP, rgbaM ) > contrast( rgbaEndP, rgbaN );\n\t\t\t\t\t\t\titerationsUsedP = i;\n\t\t\t\t\t}\n\n\t\t\t\t\tif(doneN || doneP) break;\n\t\t\t}\n\n\n\t\t\tif ( !doneP && !doneN ) return rgbaM; // failed to find end of edge\n\n\t\t\tfloat dist = min(\n\t\t\t\t\tdoneN ? float( iterationsUsedN ) / float( NUM_SAMPLES - 1 ) : 1.,\n\t\t\t\t\tdoneP ? float( iterationsUsedP ) / float( NUM_SAMPLES - 1 ) : 1.\n\t\t\t);\n\n\t\t\t// hacky way of reduces blurriness of mostly diagonal edges\n\t\t\t// but reduces AA quality\n\t\t\tdist = pow(dist, .5);\n\n\t\t\tdist = 1. - dist;\n\n\t\t\treturn mix(\n\t\t\t\t\trgbaM,\n\t\t\t\t\trgbaN,\n\t\t\t\t\tdist * .5\n\t\t\t);\n\t}\n\n\tvoid main() {\n\t\t\tconst float edgeDetectionQuality = .2;\n\t\t\tconst float invEdgeDetectionQuality = 1. / edgeDetectionQuality;\n\n\t\t\tgl_FragColor = FxaaPixelShader(\n\t\t\t\t\tvUv,\n\t\t\t\t\ttDiffuse,\n\t\t\t\t\tresolution,\n\t\t\t\t\tedgeDetectionQuality, // [0,1] contrast needed, otherwise early discard\n\t\t\t\t\tinvEdgeDetectionQuality\n\t\t\t);\n\n\t}\n\t"};var Er=function(){function e(t){var n;Gt(this,e),Ht(n=zt(this,e,[t]),"id",null),Ht(n,"map",null),Ht(n,"_conf",{layer:null,zIndex:120}),Ht(n,"_customLayer",null),Ht(n,"_visible",!0),Ht(n,"_canvas",null),Ht(n,"_composer",null),Ht(n,"_bloomPass",null),Ht(n,"_renderer",null),Ht(n,"_composerList",[]),Ht(n,"_style",{threshold:0,strength:1,radius:1.5,fxxa:!0});var r=Ot.merge(n._conf,t);return n._style=Ot.merge(n._style,r.style),n.id=t.id||(new Date).getTime().toString(),n.map=t.map,n.map?(n.bindMethods(["animate","resizeLayer","setLayerVisible"]),n.init(),n):(console.error("缺少地图对象"),Zt(n))}return Yt(e,ae),jt(e,[{key:"bindMethods",value:function(t){var e=this;t.forEach((function(t){e[t]=e[t].bind(e)}))}},{key:"visible",get:function(){return this._visible},set:function(t){this._visible=t,this._customLayer[t?"show":"hide"]()}},{key:"init",value:(n=Bt(Jt().mark((function t(){return Jt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.createLayer();case 2:this.initComposer(),this.animate(),this.addModuleListener(),this.handleEvent("init",this);case 6:case"end":return t.stop()}}),t,this)}))),function(){return n.apply(this,arguments)})},{key:"add",value:function(t){var e=this.createComposer(t),n=this.createPassShader(e,{mode:0,visible:t.getVisible()});this._composerList.push(e);var r=this._composerList.length;this._composer.insertPass(n,r),t.on("visibleChange",this.setLayerVisible)}},{key:"remove",value:function(t){var e=this._composerList.findIndex((function(e){return e.passes[0].scene===t.scene}));e>-1&&(this._composerList.splice(e,1),this._composer.passes.splice(e+1,1)),0===this._composerList.length&&this._composer.renderer.clear(),t.off("visibleChange",this.setLayerVisible)}},{key:"setLayerVisible",value:function(t,e){var n=this._composerList.findIndex((function(t){return t.passes[0].scene===e.scene}));n>-1&&(this._composer.passes[n+1].enabled=t)}},{key:"clear",value:function(){this._composer&&(this._composer.passes.length=0),this._composerList.forEach((function(t){t.dispose()})),this._composerList=[],this._composer.renderer.clear()}},{key:"createComposer",value:function(t){var e=t.scene,n=t.camera,r=new wr(this._renderer);r.renderToScreen=!1;var i=new br(e,n);return i.clear=!0,i.clearDepth=!1,r.addPass(i),r}},{key:"createPassShader",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{mode:0,visible:!0},r=n.mode,i=new yr(new t.ShaderMaterial({uniforms:{baseTexture:{value:null},coverTexture:{value:null},mode:{value:r}},vertexShader:"\n          varying vec2 vUv;\n          void main() {\n              vUv = uv;\n              gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n          }\n      ",fragmentShader:"\n          uniform sampler2D baseTexture;\n          uniform sampler2D coverTexture;\n          uniform int mode;\n          varying vec2 vUv;\n          void main() {\n\n            vec4 baseColor = texture2D(baseTexture, vUv);\n            vec4 bloomColor = texture2D(coverTexture, vUv);\n\n            if(mode == 0){\n              gl_FragColor = ( baseColor + vec4( 1.0 ) * bloomColor );\n            }else if(mode == 1){\n              gl_FragColor = bloomColor * (1.0 - baseColor.a) + baseColor;\n            }else if(mode ==2){\n              gl_FragColor = baseColor * (1.0 - bloomColor.a) + bloomColor;\n            }\n          }\n      ",defines:{}}),"baseTexture");return i.uniforms.coverTexture.value=e.renderTarget2.texture,i.renderToScreen=!0,i.needsSwap=!0,i.enabled=n.visible,i}},{key:"createRenderer",value:function(){var e=this.getScale(),n=e.width,r=e.height,i=new t.WebGLRenderer({context:this._canvas.getContext("webgl"),alpha:!0,depth:!0});return i.autoClear=!0,i.setClearAlpha(0),i.setSize(n,r),i}},{key:"animate",value:function(t){if(void 0!==this){var e=this._composerList,n=this._composer;e&&e.length&&(e.forEach((function(t){t.render()})),n.render()),requestAnimationFrame(this.animate)}}},{key:"initComposer",value:function(){var e=this.createRenderer(),n=new wr(e),r=new br(new t.Scene,new t.Camera);r.clear=!0,n.addPass(r);var i=this.createBloomPass(this._conf.style);n.addPass(i),this._style.fxxa&&n.addPass(this.createFXAAPass()),n.addPass(this.createOutputPass()),this._bloomPass=i,this._composer=n,this._renderer=e}},{key:"createFXAAPass",value:function(){var t=this.getScale(),e=t.width,n=t.height,r=new yr(Cr);return r.uniforms.resolution.value.set(1/e,1/n),r}},{key:"createBloomPass",value:function(e){var n=e.threshold,r=e.strength,i=e.radius,a=this.getScale(),o=a.width,s=a.height;return new Tr(new t.Vector2(o,s),r,i,n)}},{key:"createOutputPass",value:function(){var t=new kr;return t.clear=!1,t}},{key:"createLayer",value:function(){var t=this;return new Promise((function(e,n){var r=t.getScale(),i=r.width,a=r.height,o=document.createElement("canvas");o.width=i,o.height=a,o.style.cssText="width: ".concat(i,"px; height: ").concat(a,"px;"),o.setAttribute("belong","effect"),t._canvas=o,t._customLayer=new AMap.CustomLayer(o,{zooms:[2,22],alwaysRender:!0}),t.map.add(t._customLayer),e()}))}},{key:"updatePass",value:function(){this._bloomPass&&(this._bloomPass.threshold=this._style.threshold,this._bloomPass.strength=this._style.strength,this._bloomPass.radius=this._style.radius)}},{key:"setStyle",value:function(t){this._style=Ot.merge(this._style,t),this.updatePass()}},{key:"toggle",value:function(){var t=this._visible;this[t?"hide":"show"](),this._visible=!t}},{key:"show",value:function(){this._canvas&&(this._canvas.style.display="block")}},{key:"hide",value:function(){this._canvas&&(this._canvas.style.display="none")}},{key:"destroy",value:function(){for(var t in this.removeModuleListener(),this.clear(),this._customLayer&&(this.map.remove(this._customLayer),this._customLayer.destroy()),this)delete this[t]}},{key:"addModuleListener",value:function(){window.addEventListener("resize",this.resizeLayer)}},{key:"removeModuleListener",value:function(){window.removeEventListener("resize",this.resizeLayer)}},{key:"resizeLayer",value:function(){var t=this.getScale(),e=t.width,n=t.height;this._canvas&&(this._canvas.width=e,this._canvas.height=n,this._canvas.style.width=e+"px",this._canvas.style.height=n+"px"),this._composer&&this._composer.setSize(e,n),this._renderer&&this._renderer.setSize(e,n)}},{key:"getScale",value:function(){var t=this.map.getContainer();return{width:t.clientWidth,height:t.clientHeight}}}]);var n}(),Lr=function(){function e(t){var n;Gt(this,e);var r=qt({data:null,altitude:0,opacity:1,interact:!1,lineWidth:50,lineColor:"#FFFFFF",lineMap:null,sizeAttenuation:1,style:{polygonMap:null}},t);return Ht(n=zt(this,e,[r]),"_meshs",[]),Ht(n,"_lines",[]),Ht(n,"_data",[]),Ht(n,"_lastPick",{mesh:null,opacity:null}),n.initData(r.data),n}return Yt(e,ue),jt(e,[{key:"initData",value:function(t){var e=this;t.features.forEach((function(t){var n=t.geometry,r=t.properties;switch(n.type){case"MultiPolygon":n.coordinates[0].forEach((function(t){e._data.push({path:e.customCoords.lngLatsToCoords(t),properties:r})}));break;case"Polygon":e._data.push({path:e.customCoords.lngLatsToCoords(n.coordinates[0]),properties:r})}})),console.log(this._data)}},{key:"onReady",value:function(){this.createMesh()}},{key:"beforeDestroy",value:function(){this._meshs.forEach((function(t){t.geometry.dispose(),t.material.dispose(),t.removeFromParent()})),this._meshs=[],this._lines.forEach((function(t){t.geometry.dispose(),t.material.dispose(),t.removeFromParent()})),this._lines=[]}},{key:"getParentObject",value:function(t){var e=t.object;do{var n;if(["Scene","Group"].includes(null===(n=e.parent)||void 0===n?void 0:n.type))return e;e=e.parent}while(e)}},{key:"onPicked",value:function(t){var e,n,r=t.targets,i=t.event,a=null;if(r.length>0){var o=this.getParentObject(r[0]);o?(this.setLastPick(o),a=o._attrs):this.removeLastPick()}else this.removeLastPick();this.handleEvent("pick",{screenX:null==i||null===(e=i.pixel)||void 0===e?void 0:e.x,screenY:null==i||null===(n=i.pixel)||void 0===n?void 0:n.y,attrs:a})}},{key:"setLastPick",value:function(t){t&&(this.removeLastPick(),this._lastPick={mesh:t,opacity:t.material.opacity},t.material.opacity=.9)}},{key:"removeLastPick",value:function(){if(this._lastPick.mesh){var t=this._lastPick,e=t.mesh,n=t.opacity;e.material.opacity=n,this._lastPick={mesh:null,opacity:null}}}},{key:"createMesh",value:function(){var t=this;this.initLineMaterial(),this._data.forEach((function(e){t.drawPolygon(e),t._conf.lineWidth>0&&t.drawLines(e)}))}},{key:"drawPolygon",value:function(e){var n=e.path,r=e.properties,i=this._conf;i.altitude;var a=i.opacity,o=this.getExtRange(n),s=this.generateOneGeometry(o,n),l=new t.MeshBasicMaterial({color:r.color||"#0674F1",transparent:!0,opacity:r.opacity||a}),u=r.polygonMap||this._conf.style.polygonMap;u&&(l.map=u);var c=new t.Mesh(s,l);(this.group||this.scene).add(c),this._meshs.push(c)}},{key:"getExtRange",value:function(t){for(var e=t[0][0],n=t[0][1],r=t[0][0],i=t[0][1],a=0;a<t.length;a+=1){var o=te(t[a],2),s=o[0],l=o[1];s<e?e=s:s>r&&(r=s),l<n?n=l:l>i&&(i=l)}return{minX:e,minY:n,maxX:r,maxY:i}}},{key:"generateOneGeometry",value:function(e,n){var r=new t.Shape;n.forEach((function(t,e){var n=te(t,2),i=n[0],a=n[1];0===e?r.moveTo(i,a):r.lineTo(i,a)}));var i=new t.ShapeGeometry(r),a=this.getGeometryUV(i,e),o=new t.BufferAttribute(a,2);return i.setAttribute("uv",o),i}},{key:"getGeometryUV",value:function(t,e){for(var n=t.attributes.position.count,r=new Float32Array(2*n),i=e.minX,a=e.minY,o=e.maxX,s=e.maxY,l=0;l<n;l++){var u=2*l,c=(t.attributes.position.getX(l)-i)/(o-i),h=(t.attributes.position.getY(l)-a)/(s-a);r[u]=c,r[u+1]=h}return r}},{key:"drawLines",value:function(e){var n=this,r=e.path;e.properties;var i=[];r.forEach((function(e){var r=te(e,3),a=r[0],o=r[1];r[2],i.push(new t.Vector3(a,o,n._conf.altitude+10))}));var a=new Me;a.setPoints(i);var o=new t.Mesh(a,this._lineMaterial);(this.group||this.scene).add(o),this._lines.push(o)}},{key:"initLineMaterial",value:function(){var e=this._conf,n=e.sizeAttenuation,r=e.lineWidth,i=e.lineColor,a=e.lineMap,o={};return o=a?{useMap:!0,map:a,transparent:!0,depthTest:!1,alphaTest:0,sizeAttenuation:1,lineWidth:r,dashOffset:0}:{useMap:0,color:new t.Color(i),opacity:1,depthTest:!0,sizeAttenuation:n?1:0,lineWidth:r},this._lineMaterial=new Te(o),this._lineMaterial}},{key:"getRandomColor",value:function(){for(var t="#",e=0;e<6;e++)t+="0123456789ABCDEF"[Math.floor(16*Math.random())];return t}},{key:"update",value:function(){this.handleEvent("update",this)}}])}(),Pr=function(){function e(t){var n;Gt(this,e);var r=qt({data:null,altitude:0,opacity:1,interact:!0,style:{lineColor:"#00ffff",lineWidth:5,glowColor:"#00ffff",glowIntensity:2,glowBlur:10}},t);return Ht(n=zt(this,e,[r]),"_data",[]),Ht(n,"_meshs",[]),Ht(n,"_lastPick",{mesh:null,opacity:null}),Ht(n,"_CANVAS_MAX_LEN",2048),Ht(n,"_maxDimension",0),n.initData(r.data),n}return Yt(e,ue),jt(e,[{key:"initData",value:function(t){var e=this;t.features.forEach((function(t){var n=t.geometry,r=t.properties;switch(n.type){case"MultiPolygon":n.coordinates[0].forEach((function(t){var n=e.customCoords.lngLatsToCoords(t);e._data.push({path:n,range:e.getExtRange(n),properties:r})}));break;case"Polygon":var i=e.customCoords.lngLatsToCoords(n.coordinates[0]);e._data.push({path:i,range:e.getExtRange(i),properties:r})}})),this._maxDimension=this._data.reduce((function(t,e){var n=e.range,r=n.minX,i=n.minY,a=n.maxX,o=n.maxY,s=Math.max(a-r,o-i);return Math.max(t,s)}),0),console.log("_maxDimension",this._maxDimension)}},{key:"onReady",value:function(){this.bindMethods(["handleContainerClick"]),this.createMesh(),this.initMouseEvent()}},{key:"beforeDestroy",value:function(){this.map&&this.map.off("click",this.handleContainerClick)}},{key:"initMouseEvent",value:function(){this.map.on("click",this.handleContainerClick)}},{key:"handleContainerClick",value:function(t){var e=t.originEvent,n=this.getRayPickMesh(e),r=this.getParentObject(n[0])||{};this.handleEvent("click",{screenX:null==e?void 0:e.clientX,screenY:null==e?void 0:e.clientY,attrs:r._attrs})}},{key:"getParentObject",value:function(){var t=(arguments.length>0&&void 0!==arguments[0]?arguments[0]:{}).object;if(t)do{var e;if(["Scene","Group"].includes(null===(e=t.parent)||void 0===e?void 0:e.type))return t;t=t.parent}while(t)}},{key:"onPicked",value:function(t){var e,n,r=t.targets,i=t.event,a=null;if(r.length>0){var o=this.getParentObject(r[0]);o?(this.setLastPick(o),a=o._attrs):this.removeLastPick()}else this.removeLastPick();this.handleEvent("pick",{screenX:null==i||null===(e=i.pixel)||void 0===e?void 0:e.x,screenY:null==i||null===(n=i.pixel)||void 0===n?void 0:n.y,attrs:a})}},{key:"setLastPick",value:function(t){t&&(this.removeLastPick(),this._lastPick={mesh:t,opacity:t.material.opacity},t.material.opacity=1,t.material.needsUpdate=!0)}},{key:"removeLastPick",value:function(){if(this._lastPick.mesh){var t=this._lastPick,e=t.mesh,n=t.opacity;e.material.opacity=n,this._lastPick={mesh:null,opacity:null}}}},{key:"createMesh",value:function(){var t=this;this._data.forEach((function(e){t.drawPolygon(e)}))}},{key:"getExtRange",value:function(t){for(var e=t[0][0],n=t[0][1],r=t[0][0],i=t[0][1],a=0;a<t.length;a+=1){var o=te(t[a],2),s=o[0],l=o[1];s<e?e=s:s>r&&(r=s),l<n?n=l:l>i&&(i=l)}return{minX:e,minY:n,maxX:r,maxY:i}}},{key:"generateOneGeometry",value:function(e,n){e.minX,e.minY,e.maxX,e.maxY;var r=new t.Shape;n.forEach((function(t,e){var n=te(t,2),i=n[0],a=n[1];0===e?r.moveTo(i,a):r.lineTo(i,a)}));var i=new t.ShapeGeometry(r),a=this.getGeometryUV(i,e),o=new t.BufferAttribute(a,2);return i.setAttribute("uv",o),i}},{key:"getGeometryUV",value:function(t,e){for(var n=t.attributes.position.count,r=new Float32Array(2*n),i=e.minX,a=e.minY,o=e.maxX,s=e.maxY,l=0;l<n;l++){var u=2*l,c=(t.attributes.position.getX(l)-i)/(o-i),h=(t.attributes.position.getY(l)-a)/(s-a);r[u]=c,r[u+1]=h}return r}},{key:"drawPolygon",value:function(e){var n=e.path,r=e.properties,i=this._conf,a=i.altitude;i.opacity;var o=this.getExtRange(n);console.log(r.name);var s=this.generateOneGeometry(o,n),l=this.getMaterial(o,n),u=new t.Mesh(s,l);u.position.z=a,u._attrs=r,(this.group||this.scene).add(u),this._meshs.push(u)}},{key:"generateCanvasTexture",value:function(e,n){var r=n.map((function(e){var n=te(e,2),r=n[0],i=n[1];return new t.Vector3(r,i,0)})),i=e.minX,a=e.minY,o=e.maxX,s=e.maxY,l=this._CANVAS_MAX_LEN/this._maxDimension;console.log("scale",l);var u=r.map((function(e){var n=(e.x-i)*l,r=(e.y-a)*l;return new t.Vector3(n,r,e.z)})),c=Math.ceil((o-i)*l),h=Math.ceil((s-a)*l);console.log(c,h);var d=this._conf.style,f=d.lineWidth,p=d.lineColor,v=d.glowColor,m=d.glowIntensity,g=d.glowBlur,y=this.generateCanvas({width:c,height:h}),_=y.getContext("2d");_.fillStyle="transparent",_.fillRect(0,0,c,h),_.beginPath(),_.moveTo(u[0].x,u[0].y);for(var x=1;x<u.length;x++)_.lineTo(u[x].x,u[x].y);_.closePath(),_.lineWidth=2*f,_.strokeStyle=p;for(var w,b=100*m,A=te((w=v,[parseInt("0x"+w.slice(1,3)),parseInt("0x"+w.slice(3,5)),parseInt("0x"+w.slice(5,7))]),3),M=A[0],T=A[1],S=A[2],k=1;k<=5;k++)_.shadowColor="rgba(".concat(M,", ").concat(T,", ").concat(S,", ").concat(b*(5-k+1)/5,")"),_.shadowBlur=g*k,_.shadowOffsetX=0,_.shadowOffsetY=0,_.stroke();return new t.CanvasTexture(y,null,t.RepeatWrapping,t.RepeatWrapping)}},{key:"generateCanvas",value:function(t){var e=t.width,n=t.height,r=document.createElement("canvas");r.width=e,r.height=n;var i=r.getContext("2d");return i.translate(0,n),i.scale(1,-1),r}},{key:"getMaterial",value:function(e,n){var r=this.generateCanvasTexture(e,n);return r.wrapS=r.wrapT=t.RepeatWrapping,new t.MeshBasicMaterial({map:r,transparent:!0,side:t.DoubleSide,opacity:.9})}},{key:"setStyle",value:function(t){var e=this,n={lineColor:t.lineColor||this._conf.style.lineColor,lineWidth:t.lineWidth||this._conf.style.lineWidth,glowColor:t.glowColor||this._conf.style.glowColor,glowIntensity:t.glowIntensity||this._conf.style.glowIntensity,glowBlur:t.glowBlur||this._conf.style.glowBlur};this._conf.style=n,this._meshs.forEach((function(t,n){var r=e._data[n].path,i=e.getExtRange(r),a=e.generateCanvasTexture(i,r);t.material.map=a,t.material.needsUpdate=!0}))}},{key:"update",value:function(){}}])}(),Rr=(new t.Color(65535),new t.Vector2(100,100),"\n        varying vec2 vUv;\n        void main() {\n            vUv = uv;\n            gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n  "),Ir="\n        uniform sampler2D inputImageTexture;\n        uniform vec3 glowColor;\n        uniform float glowIntensity;\n        // uniform float stepWidth;\n        uniform float edgeWidth;\n        uniform vec2 resolution;\n        // uniform float md;\n        uniform float textureOffsetX;\n        uniform float textureOffsetY;\n        varying vec2 vUv;\n\n        // 在for循环中需要设置为静态值，该算法复杂度太高 width*height*md*md\n        // todo: 待优化为双通道有向距离场生成\n        const float md = 20.0;\n        const float stepWidth = 1.0;\n\n        // 判断点是否在边界内\n        float source(vec2 uv) {\n            vec2 textureOffset = vec2(textureOffsetX, textureOffsetY);\n            vec2 finalUV = uv - textureOffset;\n            return texture2D(inputImageTexture, finalUV).r - 0.7;\n        }\n\n        // 计算当前点到边界的最短距离\n        float distanceToEdge(vec2 point) {\n            float minDistance = md;\n\n            // 处于边界外\n            if(source(point) < 0.0){\n                return minDistance;\n            }\n\n            for (float x = -md ; x <= md; x += stepWidth) {\n                for (float y = -md; y <= md; y += stepWidth) {\n                    // 采样点坐标\n                    vec2 samplePoint = point + vec2(x, y) / resolution;\n                    // 判断采样点是否刚好在边界\n                    if (source(samplePoint) < 0.0) {\n                        float distance = length(samplePoint - point);\n                        if (distance < minDistance) {\n                            minDistance = distance;\n                        }\n                    }\n                }\n            }\n            return minDistance;\n        }\n\n        //\n        void main() {\n            // 计算到最近边界的距离 distance值应该是归一化后的值\n            float distance = distanceToEdge(vUv);\n\n            // 计算透明度渐变: 距离越远alpha越小\n            float alphaFactor = smoothstep(0.0, 1.0, 1.0 - clamp( distance / edgeWidth, 0.0, 1.0));\n\n            // 应用发光效果\n            // float glowFactor = exp(-distance * glowIntensity);\n            vec3 finalGlow = glowColor * glowIntensity;\n\n            // 输出最终颜色\n            gl_FragColor = vec4(finalGlow, alphaFactor);\n        }\n  ",Or=function(){function e(t){var n;Gt(this,e);var r=qt({data:null,altitude:0,opacity:1,interact:!1},t);return Ht(n=zt(this,e,[r]),"_data",[]),Ht(n,"_meshs",[]),Ht(n,"_lastPick",{mesh:null,opacity:null}),Ht(n,"_CANVAS_MAX_LEN",1024),n.initData(r.data),n}return Yt(e,ue),jt(e,[{key:"initData",value:function(t){var e=this;t.features.forEach((function(t){var n=t.geometry,r=t.properties;switch(n.type){case"MultiPolygon":n.coordinates[0].forEach((function(t){e._data.push({path:e.customCoords.lngLatsToCoords(t),properties:r})}));break;case"Polygon":e._data.push({path:e.customCoords.lngLatsToCoords(n.coordinates[0]),properties:r})}})),console.log(this._data)}},{key:"onReady",value:function(){this.createMesh()}},{key:"getParentObject",value:function(t){var e=t.object;do{var n;if(["Scene","Group"].includes(null===(n=e.parent)||void 0===n?void 0:n.type))return e;e=e.parent}while(e)}},{key:"onPicked",value:function(t){var e,n,r=t.targets,i=t.event,a=null;if(r.length>0){var o=this.getParentObject(r[0]);o?(this.setLastPick(o),a=o._attrs):this.removeLastPick()}else this.removeLastPick();this.handleEvent("pick",{screenX:null==i||null===(e=i.pixel)||void 0===e?void 0:e.x,screenY:null==i||null===(n=i.pixel)||void 0===n?void 0:n.y,attrs:a})}},{key:"setLastPick",value:function(t){t&&(this.removeLastPick(),this._lastPick={mesh:t,opacity:t.material.opacity},t.material.opacity=.9)}},{key:"removeLastPick",value:function(){if(this._lastPick.mesh){var t=this._lastPick,e=t.mesh,n=t.opacity;e.material.opacity=n,this._lastPick={mesh:null,opacity:null}}}},{key:"createMesh",value:function(){var t=this;this._data.forEach((function(e){t.drawPolygon(e)}))}},{key:"getExtRange",value:function(t){for(var e=t[0][0],n=t[0][1],r=t[0][0],i=t[0][1],a=0;a<t.length;a+=1){var o=te(t[a],2),s=o[0],l=o[1];s<e?e=s:s>r&&(r=s),l<n?n=l:l>i&&(i=l)}return{minX:e,minY:n,maxX:r,maxY:i}}},{key:"generateOneGeometry",value:function(e,n){e.minX,e.minY,e.maxX,e.maxY;var r=new t.Shape;n.forEach((function(t,e){var n=te(t,2),i=n[0],a=n[1];0===e?r.moveTo(i,a):r.lineTo(i,a)}));var i=new t.ShapeGeometry(r),a=this.getGeometryUV(i,e),o=new t.BufferAttribute(a,2);return i.setAttribute("uv",o),i}},{key:"generateRangeMesh",value:function(e){var n=e.minX,r=e.minY,i=e.maxX,a=e.maxY,o=[[n,r],[n,a],[i,a],[i,r]],s=new t.Shape;o.forEach((function(t,e){var n=te(t,2),r=n[0],i=n[1];0===e?s.moveTo(r,i):s.lineTo(r,i)}));var l=new t.ShapeGeometry(s),u=new t.MeshBasicMaterial({color:65280,transparent:!0,opacity:.2,side:t.DoubleSide}),c=new t.Mesh(l,u);(this.group||this.scene).add(c)}},{key:"getGeometryUV",value:function(t,e){for(var n=t.attributes.position.count,r=new Float32Array(2*n),i=e.minX,a=e.minY,o=e.maxX,s=e.maxY,l=0;l<n;l++){var u=2*l,c=(t.attributes.position.getX(l)-i)/(o-i),h=(t.attributes.position.getY(l)-a)/(s-a);r[u]=c,r[u+1]=h}return r}},{key:"drawPolygon",value:function(e){var n=e.path;e.properties;var r=this._conf,i=r.altitude;r.opacity;var a=this.getExtRange(n),o=this.generateOneGeometry(a,n),s=this.getMaterial(a,n),l=new t.Mesh(o,s);l.position.z=i,(this.group||this.scene).add(l),this._meshs.push(l)}},{key:"generateAlphaMap",value:function(e,n){var r=n.map((function(e){var n=te(e,2),r=n[0],i=n[1];return new t.Vector3(r,i,0)})),i=e.minX,a=e.minY,o=e.maxX,s=e.maxY,l=Math.max(o-i,s-a),u=this._CANVAS_MAX_LEN/l,c=r.map((function(e){var n=(e.x-i)*u,r=(e.y-a)*u;return new t.Vector3(n,r,e.z)})),h=Math.ceil((o-i)*u),d=Math.ceil((s-a)*u),f=this.generateCanvas({width:h,height:d}),p=f.getContext("2d");p.fillStyle="#000000",p.fillRect(0,0,h,d),p.fillStyle="#FFFFFF",p.beginPath(),p.moveTo(c[0].x,c[0].y);for(var v=1;v<c.length;v++)p.lineTo(c[v].x,c[v].y);return p.closePath(),p.fill(),new t.CanvasTexture(f,null,t.RepeatWrapping,t.RepeatWrapping)}},{key:"generateCanvas",value:function(t){var e=t.width,n=t.height,r=document.createElement("canvas");r.width=e,r.height=n;var i=r.getContext("2d");return i.translate(0,n),i.scale(1,-1),r}},{key:"getMaterial",value:function(e,n){var r=this.generateAlphaMap(e,n),i=r.source.data,a=i.width,o=i.height,s=Ir,l=Rr;return new t.ShaderMaterial({uniforms:{inputImageTexture:{value:r},glowColor:{value:new t.Color(65535)},glowIntensity:{value:2},stepWidth:{value:1},md:{value:10},resolution:{value:new t.Vector2(a,o)},edgeWidth:{value:.02},textureOffsetX:{value:0},textureOffsetY:{value:0}},vertexShader:l,fragmentShader:s,transparent:!0,side:t.DoubleSide})}},{key:"update",value:function(){}}])}();class Dr{constructor(t=.1,e=6){this.maxEdgeLength=t,this.maxIterations=e}modify(t){null!==t.index&&(t=t.toNonIndexed());const n=this.maxIterations,r=this.maxEdgeLength*this.maxEdgeLength,i=new _,a=new _,o=new _,s=new _,l=[i,a,o,s],c=new _,h=new _,d=new _,f=new _,p=[c,h,d,f],v=new u,m=new u,y=new u,x=new u,w=[v,m,y,x],b=new g,A=new g,M=new g,T=new g,S=[b,A,M,T],k=new g,C=new g,E=new g,L=new g,P=[k,C,E,L],R=t.attributes,I=void 0!==R.normal,O=void 0!==R.color,D=void 0!==R.uv,N=void 0!==R.uv1;let U=R.position.array,F=I?R.normal.array:null,B=O?R.color.array:null,z=D?R.uv.array:null,G=N?R.uv1.array:null,V=U,j=F,H=B,W=z,X=G,Y=0,K=!0;function Q(t,e,n){const r=l[t],i=l[e],a=l[n];if(V.push(r.x,r.y,r.z),V.push(i.x,i.y,i.z),V.push(a.x,a.y,a.z),I){const r=p[t],i=p[e],a=p[n];j.push(r.x,r.y,r.z),j.push(i.x,i.y,i.z),j.push(a.x,a.y,a.z)}if(O){const r=w[t],i=w[e],a=w[n];H.push(r.x,r.y,r.z),H.push(i.x,i.y,i.z),H.push(a.x,a.y,a.z)}if(D){const r=S[t],i=S[e],a=S[n];W.push(r.x,r.y),W.push(i.x,i.y),W.push(a.x,a.y)}if(N){const r=P[t],i=P[e],a=P[n];X.push(r.x,r.y),X.push(i.x,i.y),X.push(a.x,a.y)}}for(;K&&Y<n;){Y++,K=!1,U=V,V=[],I&&(F=j,j=[]),O&&(B=H,H=[]),D&&(z=W,W=[]),N&&(G=X,X=[]);for(let t=0,e=0,n=U.length;t<n;t+=9,e+=6){i.fromArray(U,t+0),a.fromArray(U,t+3),o.fromArray(U,t+6),I&&(c.fromArray(F,t+0),h.fromArray(F,t+3),d.fromArray(F,t+6)),O&&(v.fromArray(B,t+0),m.fromArray(B,t+3),y.fromArray(B,t+6)),D&&(b.fromArray(z,e+0),A.fromArray(z,e+2),M.fromArray(z,e+4)),N&&(k.fromArray(G,e+0),C.fromArray(G,e+2),E.fromArray(G,e+4));const n=i.distanceToSquared(a),l=a.distanceToSquared(o),u=i.distanceToSquared(o);n>r||l>r||u>r?(K=!0,n>=l&&n>=u?(s.lerpVectors(i,a,.5),I&&f.lerpVectors(c,h,.5),O&&x.lerpColors(v,m,.5),D&&T.lerpVectors(b,A,.5),N&&L.lerpVectors(k,C,.5),Q(0,3,2),Q(3,1,2)):l>=n&&l>=u?(s.lerpVectors(a,o,.5),I&&f.lerpVectors(h,d,.5),O&&x.lerpColors(m,y,.5),D&&T.lerpVectors(A,M,.5),N&&L.lerpVectors(C,E,.5),Q(0,1,3),Q(3,2,0)):(s.lerpVectors(i,o,.5),I&&f.lerpVectors(c,d,.5),O&&x.lerpColors(v,y,.5),D&&T.lerpVectors(b,M,.5),N&&L.lerpVectors(k,E,.5),Q(0,1,3),Q(3,1,2))):Q(0,1,2)}}const q=new e;return q.setAttribute("position",new dt(V,3)),I&&q.setAttribute("normal",new dt(j,3)),O&&q.setAttribute("color",new dt(H,3)),D&&q.setAttribute("uv",new dt(W,2)),N&&q.setAttribute("uv1",new dt(X,2)),q}}var Nr=function(){function e(t){var n;Gt(this,e);var r=qt({data:null,altitude:0,opacity:1,interact:!1,intensity:.9,lineWidth:100,lineColor:"#FFFFFF",sizeAttenuation:1,textureMapURL:null,normalMapURL:null,displacementMapURL:null,segment:15,sideTextureMapURL:"./static/texture/texture_cake_1.png"},t);return Ht(n=zt(this,e,[r]),"_data",[]),Ht(n,"_lastPick",{mesh:null,opacity:null}),Ht(n,"_extRange",{minX:0,minY:0,maxX:0,maxY:0}),Ht(n,"_topMesh",null),Ht(n,"_topMeshProps",{}),Ht(n,"_sideMesh",null),Ht(n,"_sideMeshProps",{}),Ht(n,"_CANVAS_MAX_LEN",2e3),n.initData(r.data),n}return Yt(e,ue),jt(e,[{key:"initData",value:function(t){var e=this;t.features.forEach((function(t){var n=t.geometry,r=t.properties;switch(n.type){case"MultiPolygon":n.coordinates[0].forEach((function(t){e._data.push({path:e.customCoords.lngLatsToCoords(t),properties:r})}));break;case"Polygon":e._data.push({path:e.customCoords.lngLatsToCoords(n.coordinates[0]),properties:r})}})),console.log(this._data)}},{key:"onReady",value:(r=Bt(Jt().mark((function t(){return Jt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.initExtRange(),t.next=3,this.initTexture();case 3:this.createTopMesh(),this._conf.altitude>0&&this.createSideMesh({height:this._conf.altitude}),this._conf.lineWidth>0&&this.createEdge(),this.initLight();case 7:case"end":return t.stop()}}),t,this)}))),function(){return r.apply(this,arguments)})},{key:"initLight",value:function(){var e=this._conf.intensity,n=new t.DirectionalLight(16777215,1*e);n.position.set(1,1,1),this.scene.add(n);var r=new t.AmbientLight(4210752,2*e);this.scene.add(r)}},{key:"getParentObject",value:function(t){var e=t.object;do{var n;if("Scene"===(null===(n=e.parent)||void 0===n?void 0:n.type))return e;e=e.parent}while(e)}},{key:"onPicked",value:function(t){var e,n,r=t.targets,i=t.event,a=null;if(r.length>0){var o=this.getParentObject(r[0]);o?(this.setLastPick(o),a=o._attrs):this.removeLastPick()}else this.removeLastPick();this.handleEvent("pick",{screenX:null==i||null===(e=i.pixel)||void 0===e?void 0:e.x,screenY:null==i||null===(n=i.pixel)||void 0===n?void 0:n.y,attrs:a})}},{key:"setLastPick",value:function(t){t&&(this.removeLastPick(),this._lastPick={mesh:t,opacity:t.material.opacity},t.material.opacity=.9)}},{key:"removeLastPick",value:function(){if(this._lastPick.mesh){var t=this._lastPick,e=t.mesh,n=t.opacity;e.material.opacity=n,this._lastPick={mesh:null,opacity:null}}}},{key:"createEdge",value:function(){var e=this,n=this._data[0].path,r=[];n.forEach((function(n){var i=te(n,3),a=i[0],o=i[1];i[2],r.push(new t.Vector3(a,o,e._conf.altitude+20))}));var i=new Me;i.setPoints(r);var a=this._conf,o=a.sizeAttenuation,s=a.lineWidth,l=a.lineColor,u=new Te({useMap:0,color:new t.Color(l),opacity:1,depthTest:!0,sizeAttenuation:o?1:0,lineWidth:s}),c=new t.Mesh(i,u);this.scene.add(c),this._edgeMesh=c}},{key:"getLineMaterial",value:function(){return null==this._lineMaterial&&(this._lineMaterial=new Te({useMap:0,color:new t.Color(lineColor),opacity:1,depthTest:!0,sizeAttenuation:sizeAttenuation?1:0,lineWidth:lineWidth})),this._lineMaterial}},{key:"createTopMesh",value:function(){var e=this._conf,n=e.normalScale,r=e.displacementScale,i=this._topMeshProps,a=i.textureMap,o=i.normalMap,s=i.displacementMap,l=i.alphaMap;a.encoding=t.sRGBEncoding;var u=new t.MeshStandardMaterial({side:t.DoubleSide,map:a,normalMap:o,normalScale:new t.Vector2(n,n),alphaMap:l,displacementMap:s,displacementScale:r,displacementBias:0,wireframe:!1,transparent:!0,alphaTest:.1}),c=this.generateTopGeometry(),h=new t.Mesh(c,u);h.position.set(0,0,this._conf.altitude),this.scene.add(h),this._topMesh=h}},{key:"generateTopGeometry",value:function(){var e=this._conf.segment,n=this._extRange,r=n.minX,i=n.minY,a=n.maxX,o=n.maxY,s=[[r,i],[r,o],[a,o],[a,i]],l=new t.Shape;s.forEach((function(t,e){var n=te(t,2),r=n[0],i=n[1];0===e?l.moveTo(r,i):l.lineTo(r,i)}));var u=new t.ShapeGeometry(l);u=new Dr(.1,e).modify(u);var c=this.getGeometryUV(u),h=new t.BufferAttribute(c,2);return u.setAttribute("uv",h),u}},{key:"generateAlphaMap",value:function(){var e=this._data[0].path.map((function(e){var n=te(e,2),r=n[0],i=n[1];return new t.Vector3(r,i,0)})),n=this._extRange,r=n.minX,i=n.minY,a=n.maxX,o=n.maxY,s=Math.max(a-r,o-i),l=this._CANVAS_MAX_LEN/s,u=e.map((function(e){var n=(e.x-r)*l,a=(e.y-i)*l;return new t.Vector3(n,a,e.z)})),c=Math.ceil((a-r)*l),h=Math.ceil((o-i)*l),d=this.generateCanvas({width:c,height:h}),f=d.getContext("2d");f.fillStyle="#000000",f.fillRect(0,0,c,h),f.fillStyle="#FFFFFF",f.beginPath(),f.moveTo(u[0].x,u[0].y);for(var p=1;p<u.length;p++)f.lineTo(u[p].x,u[p].y);return f.closePath(),f.fill(),new t.CanvasTexture(d,null,t.RepeatWrapping,t.RepeatWrapping)}},{key:"generateCanvas",value:function(t){var e=t.width,n=t.height,r=document.createElement("canvas");r.width=e,r.height=n;var i=r.getContext("2d");return i.translate(0,n),i.scale(1,-1),r}},{key:"setSegment",value:function(t){this._conf.segment=t,this._topMesh.geometry=this.generateTopGeometry()}},{key:"initTexture",value:(n=Bt(Jt().mark((function e(){var n,r,i,a,o,s;return Jt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=["textureMap","normalMap","displacementMap"],r=0;case 2:if(!(r<n.length)){e.next=14;break}return i=n[r],a=this._conf["".concat(i,"URL")],e.next=7,(new t.TextureLoader).load(a);case 7:(o=e.sent).wrapS=t.RepeatWrapping,o.wrapT=t.RepeatWrapping,this._topMeshProps[i]=o;case 11:r++,e.next=2;break;case 14:return this._topMeshProps.alphaMap=this.generateAlphaMap(),e.next=17,(new t.TextureLoader).load(this._conf.sideTextureMapURL);case 17:(s=e.sent).wrapS=t.RepeatWrapping,s.wrapT=t.RepeatWrapping,s.offset.set(0,1),this._sideMeshProps.textureMap=s;case 22:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"initExtRange",value:function(){for(var t=this._data[0].path,e=t[0][0],n=t[0][1],r=t[0][0],i=t[0][1],a=0;a<t.length;a+=1){var o=te(t[a],2),s=o[0],l=o[1];s<e?e=s:s>r&&(r=s),l<n?n=l:l>i&&(i=l)}this._extRange={minX:e,minY:n,maxX:r,maxY:i}}},{key:"getGeometryUV",value:function(t){for(var e=t.attributes.position.count,n=new Float32Array(2*e),r=this._extRange,i=r.minX,a=r.minY,o=r.maxX,s=r.maxY,l=0;l<e;l++){var u=2*l,c=(t.attributes.position.getX(l)-i)/(o-i),h=(t.attributes.position.getY(l)-a)/(s-a);n[u]=c,n[u+1]=h}return n}},{key:"createSideGeometry",value:function(e,n){var r=n.height;e[0].toString()!==e[e.length-1].toString()&&e.push(e[0]);for(var i=[],a=[],o=[],s=[0,0],l=[1,0],u=[1,1],c=[0,1],h=0;h<e.length;h++){var d=te(e[h],3),f=d[0],p=d[1],v=d[2];i.push([f,p,0]),i.push([f,p,void 0!==v?v:r])}for(var m=0;m<i.length-2;m++)m%2==0?(a=[].concat(ee(a),ee(i[m]),ee(i[m+2]),ee(i[m+1])),o=[].concat(ee(o),s,l,c)):(a=[].concat(ee(a),ee(i[m]),ee(i[m+1]),ee(i[m+2])),o=[].concat(ee(o),c,l,u));var g=new t.BufferGeometry;return g.setAttribute("position",new t.BufferAttribute(new Float32Array(a),3)),g.setAttribute("uv",new t.BufferAttribute(new Float32Array(o),2)),g}},{key:"createSideMesh",value:function(e){var n=e.height,r=void 0===n?0:n;if(e.name,!(r<=0)){var i=this._data[0].path,a=this.createSideGeometry(i,{height:r}),o=new t.MeshBasicMaterial({side:t.DoubleSide,transparent:!0,depthWrite:!0,map:this._sideMeshProps.textureMap}),s=new t.Mesh(a,o);this.scene.add(s),this._sideMesh=s}}},{key:"updateUniforms",value:function(t,e){this._topMesh.material.uniforms[t].value=e}},{key:"updateMaterial",value:function(t,e){this._topMesh.material[t]=e}},{key:"update",value:function(){}}]);var n,r}(),Ur="\n      varying vec2 vUv;\n      varying vec3 v_position;\n      void main() {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n          v_position = vec3(modelMatrix * vec4(position, 1.0));\n      }\n  ",Fr="   \n     varying vec2 vUv;\n     varying vec3 v_position;\n\n     uniform float innerCircleWidth;\n     uniform float circleWidth;\n     uniform float radius;\n     uniform float opacity;\n     uniform vec3 center;\n     uniform vec3 color;\n     uniform sampler2D textureMap;\n     uniform vec2 repeat;\n\n     void main() {\n       float dis = length(v_position - center);\n\n       // 不超过半径范围，且与波动有交集\n       if( dis < radius && dis < (innerCircleWidth + circleWidth) && dis > innerCircleWidth) {\n          // 计算当前片元的位置占整个圆环宽度的比例\n          float r = (dis - innerCircleWidth) / circleWidth;\n\n          // 透明度衰减起始点和终止点\n          float startDecay = radius * 0.5;\n          float endDecay = radius;\n\n          // 计算透明度\n          float alpha = 1.0;\n          if (dis > startDecay) {\n              alpha = 1.0 - (dis - startDecay) / (endDecay - startDecay);\n          }\n          if (dis >= endDecay) {\n              alpha = 0.0;\n          }         \n          \n          // 方案1： 纹理和颜色混合\n          gl_FragColor = mix(texture2D(textureMap, vUv * repeat), vec4(color, opacity), r);\n          // 叠加 过程透明度 和 位置透明度  \n          gl_FragColor.a *= alpha * r;\n\n          // 方案2：只显示纹理\n          // gl_FragColor = vec4(color, 1.0) * texture2D(textureMap, vUv);\n       }else {\n          // 丢弃片元不渲染\n          discard;\n       }        \n\n     }\n  ",Br="\n      varying vec2 vUv;\n      void main() \n      {\n          vUv = uv;\n          gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n      }\n  ",zr="   \n      const float PI = 3.14159265359;\n      const float TWO_PI = 6.28318530718;\n      // 边长数量\n      const int N = 3;\n      // 中间圆心的尺寸\n      const float r0 = 0.01;\n      // 蓝色闪烁点的尺寸\n      const float r_blue = 0.005;\n      // 红色闪烁点的尺寸\n      const float r_red = 0.005;\n      // 雷达完整尺寸占画布的比例\n      const float edge = 0.95;\n      const float offset = 0.05;\n      \n      // 动画时间\n      uniform float time;\n      // 扫描扇形范围叠加的纹理\n      uniform sampler2D textureMap;\n      varying vec2 vUv;\n      \n      // 绘制辐射直径\n      // 参数：当前像素坐标，指定绘制位置， 线宽\n      float plot(const vec2 st, const float pct, const float width)\n      {\n          return smoothstep(pct - width, pct, st.y) -  smoothstep(pct, pct + width, st.y);\n      }\n      \n      // 绘制雷达追踪到的多边形物体\n      // 参数：物体中心 边数  半径 画布位置\n      float drawPolygon(const vec2 polygonCenter, const int N, const float radius, vec2 pos)\n      {\n        pos = pos - polygonCenter;\n        float d = 0.0;\n        float a = atan(pos.x, pos.y);\n        float r = TWO_PI / float(N);\n        d = cos(floor(0.5 + a / r)*r - a)*length(pos);\n        return (1.0 - smoothstep(radius, radius + radius/10.0, d));\n      }\n      \n      // 生成圆盘的刻度\n      // 参数：当前角度 a， 刻度数量 gradNum， 圆盘半径 outRad， 刻度长 tickLen，刻度宽 tickWidth， r, 旋转速度\n      float gradations(const float a, const float gradNum, const float outRad, const float tickLen, const float tickWidth, const float r, const float move)\n      {\n      float f = step(0.0, cos((a + move)*gradNum) - tickWidth)*tickLen + (outRad - tickLen);\n          return 1.0 - step(f, r) * 1.0 - step(r, outRad - tickLen);\n      }\n            \n      void main(  )\n      {\n          // 屏幕像素坐标（从0到1）\n          vec2 uv = vUv;\n          // 圆心位置\n          vec2 pos = uv.xy - vec2(0.5, 0.5) ; \n             \n          // 扫描区域叠加的叠加纹理图\n          vec4 mapcol = texture2D(textureMap,uv) * vec4 (0.0, 0.85, 0.0, 1.0);\n            \n          vec3 color = vec3(0.0, 0.0, 0.0);\n          \n          float r = length(pos) * 2.0;\n          // 当前像素点的角度\n          float a = atan(pos.y, pos.x); \n          // 雷达扫描的角度\n          float an = PI - mod(time/ 1.0, TWO_PI); \n          // 被追踪物体的移动速度\n          float blipSpd = 3.0; \n          vec2 translate1 = vec2(cos(time/ blipSpd), sin(time/ blipSpd));\n          vec2 translate2 = vec2(sin(time/ blipSpd), cos(time/ blipSpd));\n          vec2 left1 = translate1 * 0.35;\n          vec2 right1 = -translate1 * 0.30;\n          vec2 left2 = translate2 * 0.15;\n          vec2 right2 = -translate2 * 0.25;\n                    \n          //  雷达扫描\n          float sn = step(PI/2.0, an) * step(-PI/2.0, (a + an)) * step(r, edge) * (1.0 - 0.55 * (a + (TWO_PI) - an));\n          float sw = step(an, a) * step(r, edge);\n          float s_blade = sw * (1.0 - (a - an) * 20.0);\n          float s = sw * (1.0 - 0.55 * (a - an));\n          s = max(sn,s);\n          float se = step(r, edge - 0.05);\n             \n          // 外圈圆\n          float s1 = smoothstep(edge - 0.00, edge + 0.01, r)* smoothstep(edge + 0.02, edge + 0.01, r);   \n             \n          // 同心圆：中心点 内圈 中圈          \n          float s0 = 1.0 - smoothstep(r0 / 2.0, r0, length(pos));\n          float smb = (1.0 - smoothstep(0.2, 0.2 + 0.01, length(pos))) * (1.0 - smoothstep(0.2 +0.01, 0.2, length(pos)));\n          float smr = (1.0 - smoothstep(0.3, 0.3 + 0.01, length(pos))) * (1.0 - smoothstep(0.3 +0.01, 0.3, length(pos)));\n          \n          // Circular concentric gradations\n          float gradNum = 120.0;\n          float tickWidth = 0.9;\n          const float tickLen = 0.04;\n          float outRad = edge;\n          float move = 0.0;\n          // 绘制外圈刻度\n          float sm = 0.75*gradations(a, gradNum, outRad, tickLen, tickWidth, r, move);   \n                       \n          gradNum = 36.0;\n          tickWidth = 0.95;\n          outRad = 0.6;\n          move = sin(time/10.0);\n          // 绘制中圈刻度\n          smr += 0.5*gradations(a, gradNum, outRad, tickLen, tickWidth, r, move);         \n         \n          outRad = 0.4;\n          move = cos(time/10.0);\n          // 绘制内圈刻度\n          smb += 0.5*gradations(a, gradNum, outRad, tickLen, tickWidth, r, move);\n          \n          // 8条辐射线\n          float sr = plot(pos, pos.x, 0.003) * step(r, edge - 0.06);\n          sr += plot(vec2(0.0, 0.0), pos.x, 0.002) * step(r, edge - 0.06);\n          sr += plot(vec2(0.0, 0.0), pos.y, 0.003) * step(r, edge - 0.06);\n          sr += plot(-pos, pos.x, 0.003) * step(r, edge - 0.06);\n          sr *= 0.75;\n      \n          // 蓝色圆形被追踪物体\n          vec2 st_trace1 = left2;\n          float s_trace1 = s * (1.0 - smoothstep(r_blue / 10.0, r_blue, length(pos - st_trace1)));\n          s_trace1 += s * (1.0 - smoothstep(r_blue / 10.0, r_blue, length(pos - st_trace1 + vec2(+offset, +offset))));\n          s_trace1 += s * (1.0 - smoothstep(r_blue / 10.0, r_blue, length(pos - st_trace1 + vec2(+2.0 *offset, +2.0 *offset))));\n          \n          vec2 st_trace2 = right1;\n          float s_trace2 = s * (1.0 - smoothstep(r_blue / 10.0, r_blue, length(pos - st_trace2)));\n          \n          // 红色三角形被追踪物体\n          vec2 st_trace3 = left1;\n          float st1 = s * (drawPolygon(st_trace3, N, r_red , pos));\n          st1 += s * (drawPolygon(st_trace3 + vec2(-offset, -offset), N, r_red, pos));\n          st1 += s * (drawPolygon(st_trace3 + vec2(+offset, -offset), N, r_red, pos));\n          \n          vec2 st_trace4 = right2;\n          float st2 = s * (drawPolygon(st_trace4, N, r_red, pos));  \n              \n          // 叠加扫描区域和纹理图\n          float s_grn = max(s * mapcol.y, s_blade);\n          // 叠加： 扫描区域， 中心点 辐射线 外圈刻度\n          s_grn = max(s_grn, (s0 +  sr + sm));\n          // 叠加：外 中 内圈  加强颜色：/0.5\n          s_grn += (s1  + smb  + smr) / 0.5 ; \n          \n          // 将被追踪物体置于顶部\n          float s_red = st1*2.0 + st2*2.0 + smr;          \n          float s_blue = max(s_trace1 + s_trace2, s_blade) + smb;\n          \n          if (s_trace1 > 0.0 || s_trace2 > 0.0) { \n            s_blue = max(s, s_blue); \n            s_grn = max(s_grn, s_blue); \n          }\n      \n          color += vec3(s_red , s_grn, s_blue);            \n          vec4 texColor = mapcol * s;\n          \n          // 过滤掉纯黑色背景\n          if (color == vec3(0.0, 0.0, 0.0)) {\n              discard;\n          }else{\n            gl_FragColor = vec4(color, s_red + s_grn + s_blue); \n          }\n      \n      }\n  ",Gr=function(){function e(t){var n;Gt(this,e);var r=qt({altitude:0,radius:1e3,duration:2e3,easingFunction:"Easing.Linear.None",textureMapURL:"./static/texture/ring_0.png",color:"#ffffff",opacity:1,mode:"rotate",rotateOptions:{direction:1,initAngle:0},spreadOptions:{initRadius:0,circleWidth:void 0,center:void 0}},t);return Ht(n=zt(this,e,[r]),"_angle",0),Ht(n,"_spreadStep",0),Ht(n,"_mesh",null),Ht(n,"_tweenInstance",null),n.initData(r.data),n}return Yt(e,ue),jt(e,[{key:"initData",value:function(t){}},{key:"onReady",value:(s=Bt(Jt().mark((function t(){return Jt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.initOptions(),this.initTween(),t.next=4,this.createMesh();case 4:case"end":return t.stop()}}),t,this)}))),function(){return s.apply(this,arguments)})},{key:"initOptions",value:function(){var t=this._conf,e=t.mode,n=t.rotateOptions,r=t.spreadOptions,i=t.radius;switch(e){case"rotate":this._angle=n.initAngle;break;case"spread":this._spreadStep=Math.max(this._conf.radius/240,1);var a=r.circleWidth,o=r.center,s=r.initRadius,l=r.repeat;void 0===a&&(r.circleWidth=Math.max(1,parseInt(i/10))),void 0===s&&(r.initRadius=0),o instanceof Array==!1&&(r.center=[0,0]),l instanceof Array==!1&&(r.repeat=[1,1])}}},{key:"initTween",value:function(){var t=this,e={t:0},n=this._conf,r=n.duration,i=n.radius,a=n.mode,o=n.rotateOptions,s=n.spreadOptions,l=n.easingFunction;this._tweenInstance&&(this._tweenInstance.stop(),this._tweenInstance=null);var u=l.split(".").reduce((function(t,e){return t&&t[e]}),sr);this._tweenInstance=new Zn(e).to({t:1},r).easing(u).onUpdate((function(){switch(a){case"rotate":t._angle>360?t._angle=o.initAngle:t._angle=o.initAngle+e.t*(360-o.initAngle)*o.direction,t._mesh.material.map.rotation=t._angle*Math.PI/180;break;case"spread":var n=t._mesh.material.uniforms.innerCircleWidth;n.value=s.initRadius+e.t*(i-s.initRadius),n.value>i&&(n.value=s.initRadius);break;case"radar":t._mesh.material.uniforms.time.value+=12/r}})).onComplete((function(){e.t=0,t._tweenInstance.stop().to({t:1},r).start()})).start()}},{key:"createMesh",value:(o=Bt(Jt().mark((function e(){var n,r,i,a,o,s,l;return Jt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:n=this._conf,r=n.radius,i=n.altitude,a=n.mode,o=new t.PlaneGeometry(2*r,2*r),s=null,e.t0=a,e.next="rotate"===e.t0?6:"spread"===e.t0?10:"radar"===e.t0?14:18;break;case 6:return e.next=8,this.generateRotateMaterial();case 8:return s=e.sent,e.abrupt("break",19);case 10:return e.next=12,this.generateSpreadMaterial();case 12:return s=e.sent,e.abrupt("break",19);case 14:return e.next=16,this.generateRadarMaterial();case 16:return s=e.sent,e.abrupt("break",19);case 18:return e.abrupt("break",19);case 19:(l=new t.Mesh(o,s)).position.set(0,0,i),this.scene.add(l),this._mesh=l;case 23:case"end":return e.stop()}}),e,this)}))),function(){return o.apply(this,arguments)})},{key:"generateRotateMaterial",value:(a=Bt(Jt().mark((function e(){var n,r,i,a,o,s;return Jt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._conf,r=n.textureMapURL,i=n.color,a=n.opacity,e.next=3,(new t.TextureLoader).load(r);case 3:return(o=e.sent).wrapS=t.ClampToEdgeWrapping,o.wrapT=t.ClampToEdgeWrapping,o.center=new t.Vector2(.5,.5),s=new t.MeshBasicMaterial({side:t.DoubleSide,map:o,transparent:!0,alphaTest:.01,opacity:a,color:i,depthWrite:!1}),e.abrupt("return",s);case 9:case"end":return e.stop()}}),e,this)}))),function(){return a.apply(this,arguments)})},{key:"generateRadarMaterial",value:(i=Bt(Jt().mark((function e(){var n,r,i,a,o;return Jt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._conf.textureMapURL,r=Br,i=zr,e.next=4,(new t.TextureLoader).load(n);case 4:return a=e.sent,o=new t.ShaderMaterial({uniforms:{textureMap:{value:a},time:{value:0}},vertexShader:r,fragmentShader:i,transparent:!0,depthWrite:!1}),e.abrupt("return",o);case 7:case"end":return e.stop()}}),e,this)}))),function(){return i.apply(this,arguments)})},{key:"generateSpreadMaterial",value:(r=Bt(Jt().mark((function e(){var n,r,i,a,o,s,l,u,c,h,d,f,p;return Jt().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n=this._conf,r=n.textureMapURL,i=n.radius,a=n.spreadOptions,o=n.color,s=a.initRadius,l=a.circleWidth,u=a.center,c=a.repeat,e.next=4,(new t.TextureLoader).load(r);case 4:return(h=e.sent).wrapS=t.RepeatWrapping,h.wrapT=t.RepeatWrapping,h.center=new t.Vector2(.5,.5),d=Ur,f=Fr,p=new t.ShaderMaterial({uniforms:{innerCircleWidth:{value:s},circleWidth:{value:l},color:{value:new t.Color(o||16777215)},opacity:{value:.8},center:{value:new t.Vector3(u[0],u[1])},radius:{value:i},textureMap:{value:h},repeat:{value:new t.Vector2(c[0],c[1])}},vertexShader:d,fragmentShader:f,transparent:!0,depthWrite:!1}),e.abrupt("return",p);case 11:case"end":return e.stop()}}),e,this)}))),function(){return r.apply(this,arguments)})},{key:"setRadius",value:function(e){this._conf.radius=e;var n=new t.PlaneGeometry(2*e,2*e);this._mesh.geometry=n}},{key:"setDuration",value:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1e3;this._conf.duration=t,this.initTween()}},{key:"setEasing",value:function(t){this._conf.easingFunction=t,this.initTween()}},{key:"setAltitude",value:function(t){this._mesh.position.set(0,0,t)}},{key:"updateMaterial",value:function(t,e){this._mesh.material[t]=e,"map"===t&&(this._texture=e)}},{key:"update",value:function(t){var e;void 0!==(null==this||null===(e=this._mesh)||void 0===e?void 0:e.material)&&this._tweenInstance&&this._tweenInstance.update()}},{key:"setMode",value:(n=Bt(Jt().mark((function t(e){var n;return Jt().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:this._conf.mode=e,this.initOptions(),this.initTween(),n=null,t.t0=e,t.next="rotate"===t.t0?7:"spread"===t.t0?11:"radar"===t.t0?15:19;break;case 7:return t.next=9,this.generateRotateMaterial();case 9:return n=t.sent,t.abrupt("break",20);case 11:return t.next=13,this.generateSpreadMaterial();case 13:return n=t.sent,t.abrupt("break",20);case 15:return t.next=17,this.generateRadarMaterial();case 17:return n=t.sent,t.abrupt("break",20);case 19:return t.abrupt("break",20);case 20:this._mesh.material=n;case 21:case"end":return t.stop()}}),t,this)}))),function(t){return n.apply(this,arguments)})}]);var n,r,i,a,o,s}(),Vr=function(){function e(t){var n;Gt(this,e);var r=qt({data:null,opacity:0,altitude:1},t);return Ht(n=zt(this,e,[r]),"_paths",[]),void 0===r.data?(console.log("props data is required"),Zt(n)):(n.initData(r.data),n._data=r.data,n)}return Yt(e,ue),jt(e,[{key:"onReady",value:function(){this.createMesh()}},{key:"createMesh",value:function(){var e=this,n=this.getMaterial();this._paths.forEach((function(r){var i=e.generateGeometry(r),a=new t.Mesh(i,n);a.position.z=e._conf.altitude,e.scene.add(a)}))}},{key:"generateGeometry",value:function(e){var n=new t.Shape;return e.forEach((function(t,e){var r=te(t,2),i=r[0],a=r[1];0===e?n.moveTo(i,a):n.lineTo(i,a)})),new t.ShapeGeometry(n)}},{key:"initData",value:function(t){var e=this;t.features.forEach((function(t){t.geometry.coordinates.forEach((function(t){var n=t[0][0]instanceof Array?t[0]:t,r=e.customCoords.lngLatsToCoords(n);e._paths.push(r)}))}))}},{key:"getMaterial",value:function(){return new t.MeshBasicMaterial({color:16777215,opacity:0,side:t.DoubleSide,transparent:!0,alphaTest:0,depthWrite:!0})}},{key:"update",value:function(){}}])}(),jr=function(){function e(t){var n;return Gt(this,e),Ht(n=zt(this,e,[qt({data:null,extent:null,picUrl:null,opacity:1},t)]),"animTime",0),Ht(n,"_extent",[]),n.initData(),n}return Yt(e,ue),jt(e,[{key:"onReady",value:function(){this.createTexture()}},{key:"initData",value:function(){var t,e=this.customCoords.lngLatsToCoords(this._conf.extent);(t=this._extent).push.apply(t,ee(e))}},{key:"createTexture",value:function(){var e=this,n=this.scene;(new t.TextureLoader).load(this._conf.picUrl,(function(r){r.encoding=t.sRGBEncoding,r.encoding=t.sRGBEncoding;var i=new t.PlaneGeometry(e._extent[1][0]-e._extent[0][0],e._extent[1][1]-e._extent[0][1]),a=new t.MeshBasicMaterial({transparent:!0,side:t.DoubleSide,depthWrite:!1,map:r,opacity:e._conf.opacity}),o=new t.Mesh(i,a);n.add(o),o.position.set((e._extent[0][0]+e._extent[1][0])/2,(e._extent[0][1]+e._extent[1][1])/2,0)}))}},{key:"update",value:function(){}}])}();kt.line={worldUnits:{value:1},linewidth:{value:1},resolution:{value:new g(1,1)},dashOffset:{value:0},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},Ct.line={uniforms:pt.merge([kt.common,kt.fog,kt.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\t#ifdef WORLD_UNITS\n\n\t\t\tvarying vec4 worldPos;\n\t\t\tvarying vec3 worldStart;\n\t\t\tvarying vec3 worldEnd;\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvarying vec2 vUv;\n\n\t\t\t#endif\n\n\t\t#else\n\n\t\t\tvarying vec2 vUv;\n\n\t\t#endif\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\t\t\t\tvUv = uv;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\tworldStart = start.xyz;\n\t\t\t\tworldEnd = end.xyz;\n\n\t\t\t#else\n\n\t\t\t\tvUv = uv;\n\n\t\t\t#endif\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec3 ndcStart = clipStart.xyz / clipStart.w;\n\t\t\tvec3 ndcEnd = clipEnd.xyz / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd.xy - ndcStart.xy;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\t// get the offset direction as perpendicular to the view vector\n\t\t\t\tvec3 worldDir = normalize( end.xyz - start.xyz );\n\t\t\t\tvec3 offset;\n\t\t\t\tif ( position.y < 0.5 ) {\n\n\t\t\t\t\toffset = normalize( cross( start.xyz, worldDir ) );\n\n\t\t\t\t} else {\n\n\t\t\t\t\toffset = normalize( cross( end.xyz, worldDir ) );\n\n\t\t\t\t}\n\n\t\t\t\t// sign flip\n\t\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t\tfloat forwardOffset = dot( worldDir, vec3( 0.0, 0.0, 1.0 ) );\n\n\t\t\t\t// don't extend the line if we're rendering dashes because we\n\t\t\t\t// won't be rendering the endcaps\n\t\t\t\t#ifndef USE_DASH\n\n\t\t\t\t\t// extend the line bounds to encompass  endcaps\n\t\t\t\t\tstart.xyz += - worldDir * linewidth * 0.5;\n\t\t\t\t\tend.xyz += worldDir * linewidth * 0.5;\n\n\t\t\t\t\t// shift the position of the quad so it hugs the forward edge of the line\n\t\t\t\t\toffset.xy -= dir * forwardOffset;\n\t\t\t\t\toffset.z += 0.5;\n\n\t\t\t\t#endif\n\n\t\t\t\t// endcaps\n\t\t\t\tif ( position.y > 1.0 || position.y < 0.0 ) {\n\n\t\t\t\t\toffset.xy += dir * 2.0 * forwardOffset;\n\n\t\t\t\t}\n\n\t\t\t\t// adjust for linewidth\n\t\t\t\toffset *= linewidth * 0.5;\n\n\t\t\t\t// set the world position\n\t\t\t\tworldPos = ( position.y < 0.5 ) ? start : end;\n\t\t\t\tworldPos.xyz += offset;\n\n\t\t\t\t// project the worldpos\n\t\t\t\tvec4 clip = projectionMatrix * worldPos;\n\n\t\t\t\t// shift the depth of the projected points so the line\n\t\t\t\t// segments overlap neatly\n\t\t\t\tvec3 clipPose = ( position.y < 0.5 ) ? ndcStart : ndcEnd;\n\t\t\t\tclip.z = clipPose.z * clip.w;\n\n\t\t\t#else\n\n\t\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\t\t\t\t// undo aspect ratio adjustment\n\t\t\t\tdir.x /= aspect;\n\t\t\t\toffset.x /= aspect;\n\n\t\t\t\t// sign flip\n\t\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t\t// endcaps\n\t\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\t\toffset += - dir;\n\n\t\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\t\toffset += dir;\n\n\t\t\t\t}\n\n\t\t\t\t// adjust for linewidth\n\t\t\t\toffset *= linewidth;\n\n\t\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\t\toffset /= resolution.y;\n\n\t\t\t\t// select end\n\t\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t\t// back to clip space\n\t\t\t\toffset *= clip.w;\n\n\t\t\t\tclip.xy += offset;\n\n\t\t\t#endif\n\n\t\t\tgl_Position = clip;\n\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\n\t\t\t#include <logdepthbuf_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\t\tuniform float linewidth;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashOffset;\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#ifdef WORLD_UNITS\n\n\t\t\tvarying vec4 worldPos;\n\t\t\tvarying vec3 worldStart;\n\t\t\tvarying vec3 worldEnd;\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvarying vec2 vUv;\n\n\t\t\t#endif\n\n\t\t#else\n\n\t\t\tvarying vec2 vUv;\n\n\t\t#endif\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvec2 closestLineToLine(vec3 p1, vec3 p2, vec3 p3, vec3 p4) {\n\n\t\t\tfloat mua;\n\t\t\tfloat mub;\n\n\t\t\tvec3 p13 = p1 - p3;\n\t\t\tvec3 p43 = p4 - p3;\n\n\t\t\tvec3 p21 = p2 - p1;\n\n\t\t\tfloat d1343 = dot( p13, p43 );\n\t\t\tfloat d4321 = dot( p43, p21 );\n\t\t\tfloat d1321 = dot( p13, p21 );\n\t\t\tfloat d4343 = dot( p43, p43 );\n\t\t\tfloat d2121 = dot( p21, p21 );\n\n\t\t\tfloat denom = d2121 * d4343 - d4321 * d4321;\n\n\t\t\tfloat numer = d1343 * d4321 - d1321 * d4343;\n\n\t\t\tmua = numer / denom;\n\t\t\tmua = clamp( mua, 0.0, 1.0 );\n\t\t\tmub = ( d1343 + d4321 * ( mua ) ) / d4343;\n\t\t\tmub = clamp( mub, 0.0, 1.0 );\n\n\t\t\treturn vec2( mua, mub );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < - 1.0 || vUv.y > 1.0 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance + dashOffset, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tfloat alpha = opacity;\n\n\t\t\t#ifdef WORLD_UNITS\n\n\t\t\t\t// Find the closest points on the view ray and the line segment\n\t\t\t\tvec3 rayEnd = normalize( worldPos.xyz ) * 1e5;\n\t\t\t\tvec3 lineDir = worldEnd - worldStart;\n\t\t\t\tvec2 params = closestLineToLine( worldStart, worldEnd, vec3( 0.0, 0.0, 0.0 ), rayEnd );\n\n\t\t\t\tvec3 p1 = worldStart + lineDir * params.x;\n\t\t\t\tvec3 p2 = rayEnd * params.y;\n\t\t\t\tvec3 delta = p1 - p2;\n\t\t\t\tfloat len = length( delta );\n\t\t\t\tfloat norm = len / linewidth;\n\n\t\t\t\t#ifndef USE_DASH\n\n\t\t\t\t\t#ifdef USE_ALPHA_TO_COVERAGE\n\n\t\t\t\t\t\tfloat dnorm = fwidth( norm );\n\t\t\t\t\t\talpha = 1.0 - smoothstep( 0.5 - dnorm, 0.5 + dnorm, norm );\n\n\t\t\t\t\t#else\n\n\t\t\t\t\t\tif ( norm > 0.5 ) {\n\n\t\t\t\t\t\t\tdiscard;\n\n\t\t\t\t\t\t}\n\n\t\t\t\t\t#endif\n\n\t\t\t\t#endif\n\n\t\t\t#else\n\n\t\t\t\t#ifdef USE_ALPHA_TO_COVERAGE\n\n\t\t\t\t\t// artifacts appear on some hardware if a derivative is taken within a conditional\n\t\t\t\t\tfloat a = vUv.x;\n\t\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\t\tfloat len2 = a * a + b * b;\n\t\t\t\t\tfloat dlen = fwidth( len2 );\n\n\t\t\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\t\t\talpha = 1.0 - smoothstep( 1.0 - dlen, 1.0 + dlen, len2 );\n\n\t\t\t\t\t}\n\n\t\t\t\t#else\n\n\t\t\t\t\tif ( abs( vUv.y ) > 1.0 ) {\n\n\t\t\t\t\t\tfloat a = vUv.x;\n\t\t\t\t\t\tfloat b = ( vUv.y > 0.0 ) ? vUv.y - 1.0 : vUv.y + 1.0;\n\t\t\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\t\t\tif ( len2 > 1.0 ) discard;\n\n\t\t\t\t\t}\n\n\t\t\t\t#endif\n\n\t\t\t#endif\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, alpha );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, alpha );\n\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <colorspace_fragment>\n\t\t\t#include <fog_fragment>\n\t\t\t#include <premultiplied_alpha_fragment>\n\n\t\t}\n\t\t"};class Hr extends ft{constructor(t){super({type:"LineMaterial",uniforms:pt.clone(Ct.line.uniforms),vertexShader:Ct.line.vertexShader,fragmentShader:Ct.line.fragmentShader,clipping:!0}),this.isLineMaterial=!0,this.setValues(t)}get color(){return this.uniforms.diffuse.value}set color(t){this.uniforms.diffuse.value=t}get worldUnits(){return"WORLD_UNITS"in this.defines}set worldUnits(t){!0===t?this.defines.WORLD_UNITS="":delete this.defines.WORLD_UNITS}get linewidth(){return this.uniforms.linewidth.value}set linewidth(t){this.uniforms.linewidth&&(this.uniforms.linewidth.value=t)}get dashed(){return"USE_DASH"in this.defines}set dashed(t){!0===t!==this.dashed&&(this.needsUpdate=!0),!0===t?this.defines.USE_DASH="":delete this.defines.USE_DASH}get dashScale(){return this.uniforms.dashScale.value}set dashScale(t){this.uniforms.dashScale.value=t}get dashSize(){return this.uniforms.dashSize.value}set dashSize(t){this.uniforms.dashSize.value=t}get dashOffset(){return this.uniforms.dashOffset.value}set dashOffset(t){this.uniforms.dashOffset.value=t}get gapSize(){return this.uniforms.gapSize.value}set gapSize(t){this.uniforms.gapSize.value=t}get opacity(){return this.uniforms.opacity.value}set opacity(t){this.uniforms&&(this.uniforms.opacity.value=t)}get resolution(){return this.uniforms.resolution.value}set resolution(t){this.uniforms.resolution.value.copy(t)}get alphaToCoverage(){return"USE_ALPHA_TO_COVERAGE"in this.defines}set alphaToCoverage(t){this.defines&&(!0===t!==this.alphaToCoverage&&(this.needsUpdate=!0),!0===t?(this.defines.USE_ALPHA_TO_COVERAGE="",this.extensions.derivatives=!0):(delete this.defines.USE_ALPHA_TO_COVERAGE,this.extensions.derivatives=!1))}}const Wr=new ut,Xr=new _;class Yr extends Et{constructor(){super(),this.isLineSegmentsGeometry=!0,this.type="LineSegmentsGeometry";this.setIndex([0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5]),this.setAttribute("position",new dt([-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0],3)),this.setAttribute("uv",new dt([-1,2,1,2,-1,1,1,1,-1,-1,1,-1,-1,-2,1,-2],2))}applyMatrix4(t){const e=this.attributes.instanceStart,n=this.attributes.instanceEnd;return void 0!==e&&(e.applyMatrix4(t),n.applyMatrix4(t),e.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this}setPositions(t){let e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));const n=new Lt(e,6,1);return this.setAttribute("instanceStart",new S(n,3,0)),this.setAttribute("instanceEnd",new S(n,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this}setColors(t){let e;t instanceof Float32Array?e=t:Array.isArray(t)&&(e=new Float32Array(t));const n=new Lt(e,6,1);return this.setAttribute("instanceColorStart",new S(n,3,0)),this.setAttribute("instanceColorEnd",new S(n,3,3)),this}fromWireframeGeometry(t){return this.setPositions(t.attributes.position.array),this}fromEdgesGeometry(t){return this.setPositions(t.attributes.position.array),this}fromMesh(t){return this.fromWireframeGeometry(new Pt(t.geometry)),this}fromLineSegments(t){const e=t.geometry;return this.setPositions(e.attributes.position.array),this}computeBoundingBox(){null===this.boundingBox&&(this.boundingBox=new ut);const t=this.attributes.instanceStart,e=this.attributes.instanceEnd;void 0!==t&&void 0!==e&&(this.boundingBox.setFromBufferAttribute(t),Wr.setFromBufferAttribute(e),this.boundingBox.union(Wr))}computeBoundingSphere(){null===this.boundingSphere&&(this.boundingSphere=new ct),null===this.boundingBox&&this.computeBoundingBox();const t=this.attributes.instanceStart,e=this.attributes.instanceEnd;if(void 0!==t&&void 0!==e){const n=this.boundingSphere.center;this.boundingBox.getCenter(n);let r=0;for(let i=0,a=t.count;i<a;i++)Xr.fromBufferAttribute(t,i),r=Math.max(r,n.distanceToSquared(Xr)),Xr.fromBufferAttribute(e,i),r=Math.max(r,n.distanceToSquared(Xr));this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}toJSON(){}applyMatrix(t){return console.warn("THREE.LineSegmentsGeometry: applyMatrix() has been renamed to applyMatrix4()."),this.applyMatrix4(t)}}class Kr extends Yr{constructor(){super(),this.isLineGeometry=!0,this.type="LineGeometry"}setPositions(t){const e=t.length-3,n=new Float32Array(2*e);for(let r=0;r<e;r+=3)n[2*r]=t[r],n[2*r+1]=t[r+1],n[2*r+2]=t[r+2],n[2*r+3]=t[r+3],n[2*r+4]=t[r+4],n[2*r+5]=t[r+5];return super.setPositions(n),this}setColors(t){const e=t.length-3,n=new Float32Array(2*e);for(let r=0;r<e;r+=3)n[2*r]=t[r],n[2*r+1]=t[r+1],n[2*r+2]=t[r+2],n[2*r+3]=t[r+3],n[2*r+4]=t[r+4],n[2*r+5]=t[r+5];return super.setColors(n),this}fromLine(t){const e=t.geometry;return this.setPositions(e.attributes.position.array),this}}const Qr=new _,qr=new _,Zr=new Rt,Jr=new Rt,$r=new Rt,ti=new _,ei=new y,ni=new It,ri=new _,ii=new ut,ai=new ct,oi=new Rt;let si,li;function ui(t,e,n){return oi.set(0,0,-e,1).applyMatrix4(t.projectionMatrix),oi.multiplyScalar(1/oi.w),oi.x=li/n.width,oi.y=li/n.height,oi.applyMatrix4(t.projectionMatrixInverse),oi.multiplyScalar(1/oi.w),Math.abs(Math.max(oi.x,oi.y))}class ci extends U{constructor(t=new Yr,e=new Hr({color:16777215*Math.random()})){super(t,e),this.isLineSegments2=!0,this.type="LineSegments2"}computeLineDistances(){const t=this.geometry,e=t.attributes.instanceStart,n=t.attributes.instanceEnd,r=new Float32Array(2*e.count);for(let t=0,i=0,a=e.count;t<a;t++,i+=2)Qr.fromBufferAttribute(e,t),qr.fromBufferAttribute(n,t),r[i]=0===i?0:r[i-1],r[i+1]=r[i]+Qr.distanceTo(qr);const i=new Lt(r,2,1);return t.setAttribute("instanceDistanceStart",new S(i,1,0)),t.setAttribute("instanceDistanceEnd",new S(i,1,1)),this}raycast(t,e){const n=this.material.worldUnits,r=t.camera;null!==r||n||console.error('LineSegments2: "Raycaster.camera" needs to be set in order to raycast against LineSegments2 while worldUnits is set to false.');const i=void 0!==t.params.Line2&&t.params.Line2.threshold||0;si=t.ray;const a=this.matrixWorld,o=this.geometry,s=this.material;let l,u;if(li=s.linewidth+i,null===o.boundingSphere&&o.computeBoundingSphere(),ai.copy(o.boundingSphere).applyMatrix4(a),n)l=.5*li;else{l=ui(r,Math.max(r.near,ai.distanceToPoint(si.origin)),s.resolution)}if(ai.radius+=l,!1!==si.intersectsSphere(ai)){if(null===o.boundingBox&&o.computeBoundingBox(),ii.copy(o.boundingBox).applyMatrix4(a),n)u=.5*li;else{u=ui(r,Math.max(r.near,ii.distanceToPoint(si.origin)),s.resolution)}ii.expandByScalar(u),!1!==si.intersectsBox(ii)&&(n?function(t,e){const n=t.matrixWorld,r=t.geometry,i=r.attributes.instanceStart,a=r.attributes.instanceEnd;for(let o=0,s=Math.min(r.instanceCount,i.count);o<s;o++){ni.start.fromBufferAttribute(i,o),ni.end.fromBufferAttribute(a,o),ni.applyMatrix4(n);const r=new _,s=new _;si.distanceSqToSegment(ni.start,ni.end,s,r),s.distanceTo(r)<.5*li&&e.push({point:s,pointOnLine:r,distance:si.origin.distanceTo(s),object:t,face:null,faceIndex:o,uv:null,uv1:null})}}(this,e):function(t,e,n){const r=e.projectionMatrix,i=t.material.resolution,a=t.matrixWorld,o=t.geometry,s=o.attributes.instanceStart,l=o.attributes.instanceEnd,u=Math.min(o.instanceCount,s.count),c=-e.near;si.at(1,$r),$r.w=1,$r.applyMatrix4(e.matrixWorldInverse),$r.applyMatrix4(r),$r.multiplyScalar(1/$r.w),$r.x*=i.x/2,$r.y*=i.y/2,$r.z=0,ti.copy($r),ei.multiplyMatrices(e.matrixWorldInverse,a);for(let e=0,o=u;e<o;e++){if(Zr.fromBufferAttribute(s,e),Jr.fromBufferAttribute(l,e),Zr.w=1,Jr.w=1,Zr.applyMatrix4(ei),Jr.applyMatrix4(ei),Zr.z>c&&Jr.z>c)continue;if(Zr.z>c){const t=Zr.z-Jr.z,e=(Zr.z-c)/t;Zr.lerp(Jr,e)}else if(Jr.z>c){const t=Jr.z-Zr.z,e=(Jr.z-c)/t;Jr.lerp(Zr,e)}Zr.applyMatrix4(r),Jr.applyMatrix4(r),Zr.multiplyScalar(1/Zr.w),Jr.multiplyScalar(1/Jr.w),Zr.x*=i.x/2,Zr.y*=i.y/2,Jr.x*=i.x/2,Jr.y*=i.y/2,ni.start.copy(Zr),ni.start.z=0,ni.end.copy(Jr),ni.end.z=0;const o=ni.closestPointToPointParameter(ti,!0);ni.at(o,ri);const u=H.lerp(Zr.z,Jr.z,o),h=u>=-1&&u<=1,d=ti.distanceTo(ri)<.5*li;if(h&&d){ni.start.fromBufferAttribute(s,e),ni.end.fromBufferAttribute(l,e),ni.start.applyMatrix4(a),ni.end.applyMatrix4(a);const r=new _,i=new _;si.distanceSqToSegment(ni.start,ni.end,i,r),n.push({point:i,pointOnLine:r,distance:si.origin.distanceTo(i),object:t,face:null,faceIndex:e,uv:null,uv1:null})}}}(this,r,e))}}}class hi extends ci{constructor(t=new Kr,e=new Hr({color:16777215*Math.random()})){super(t,e),this.isLine2=!0,this.type="Line2"}}var di={Layer:ue,LayerManager:ce,BorderLayer:fe,BuildingLayer:_e,MonoBuildingLayer:xe,CakeLayer:Se,ModelLayer:An,MassModelLayer:Mn,PathLayer:function(){function e(n){var r;Gt(this,e);var i=qt({data:null,style:{},altitude:0,sizeAttenuation:!0},n);return Ht(r=zt(this,e,[i]),"_data",[]),Ht(r,"_group",new t.Group),Ht(r,"_materialMap",{}),r.initData(i.data),r}return Yt(e,ue),jt(e,[{key:"onReady",value:function(){this.scene.add(this._group),this.initMaterials(),this.initLines()}},{key:"initData",value:function(t){var e=this,n=JSON.parse(JSON.stringify(null==t?void 0:t.features)).map((function(t){var n;return{coordinates:e.customCoords.lngLatsToCoords(null==t||null===(n=t.geometry)||void 0===n?void 0:n.coordinates[0]),properties:null==t?void 0:t.properties}}));this._data=n}},{key:"initMaterials",value:function(){var t=this,e=this._conf.styles;Object.keys(e).forEach((function(n){var r=e[n],i=r.color,a=r.lineWidth,o=new Hr({color:i,linewidth:.001*a,dashed:!1});t._materialMap[n]=o}))}},{key:"initLines",value:function(){var t=this,e=this._group;this._data.forEach((function(n,r){var i=[];n.coordinates.forEach((function(e){var n=te(e,3),r=n[0],a=n[1],o=n[2];i.push(r,a,null!=o?o:t._conf.altitude)}));var a=new Kr;a.setPositions(i);var o=t._materialMap[t._conf.getStyle(n)],s=new hi(a,o);s.computeLineDistances(),s.scale.set(1,1,1),e.add(s)}))}},{key:"setData",value:function(t){this.initData(t),this.clear(),this.initLines()}},{key:"clear",value:function(){this._group.clear()}},{key:"update",value:function(){}}])}(),FlowlineLayer:Tn,IconLayer:Sn,PointIconLayer:En,PointsLayer:Rn,ScatterLayer:In,SpriteLayer:On,TilesLayer:Bn,WaterLayer:Gn,TerrainLayer:Hn,DrivingLayer:lr,PolylineEditor:ur,WeatherLayer:cr,VideoLayer:hr,POI3dLayer:dr,EffectLayer:Er,PolygonLayer:Lr,GlowPolygonLayerCanvas:Pr,GlowPolygonLayerShader:Or,TerrainPolygonLayer:Nr,HaloLayer:Gr,MaskLayer:Vr,PictureLayer:jr};window.GLlayers=di;export{di as default};
